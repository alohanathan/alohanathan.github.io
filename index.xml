<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>é€ƒè·‘å±±ç¾Šç”Ÿæ´»å¿—</title><link>https://www.hinathan.online/</link><description>Recent content on é€ƒè·‘å±±ç¾Šç”Ÿæ´»å¿— created by</description><generator>Hugo -- gohugo.io</generator><language>zh</language><copyright>2017 é€ƒè·‘å±±ç¾Šç”Ÿæ´»å¿— All rights reserved</copyright><lastBuildDate>Mon, 01 Dec 2025 10:37:34 +0800</lastBuildDate><atom:link href="https://www.hinathan.online/index.xml" rel="self" type="application/rss+xml"/><item><title>æ—¥è¯­å­¦ä¹ ç¬”è®°æ±‡æ€»</title><link>https://www.hinathan.online/blog/japanese/</link><pubDate>Sat, 25 Oct 2025 13:31:34 +0800</pubDate><guid>https://www.hinathan.online/blog/japanese/</guid><description>&lt;h2 id="æ ‡å‡†æ—¥æœ¬è¯­_åˆçº§_ä¸Š">æ ‡å‡†æ—¥æœ¬è¯­_åˆçº§_ä¸Š&lt;/h2>
&lt;h3 id="å•è¯">å•è¯&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/dc/xbrdc1" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_å•è¯ ç¬¬1å•å…ƒ å°æèµ´æ—¥&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/dc/xbrdc2" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_å•è¯ ç¬¬2å•å…ƒ å°æçš„å…¬å¸ç”Ÿæ´»â‘ &lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/dc/xbrdc3" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_å•è¯ ç¬¬3å•å…ƒ å°æåœ¨ç®±æ ¹&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/dc/xbrdc4" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_å•è¯ ç¬¬4å•å…ƒ å°æçš„å…¬å¸ç”Ÿæ´»â‘¡&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/dc/xbrdc5" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_å•è¯ ç¬¬5å•å…ƒ å°æåœ¨æ—¥æœ¬è¿æ–°æ˜¥&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/dc/xbrdc6" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_å•è¯ ç¬¬ï¼–å•å…ƒ å†è§ï¼æ—¥æœ¬&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="è¯­æ³•">è¯­æ³•&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/yf/xbryf1_8" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_è¯­æ³• 1-8è¯¾&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/yf/xbryf9_16" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_è¯­æ³• 9_16è¯¾&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/yf/xbryf17_24" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_è¯­æ³• 17_24è¯¾&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="è¯¾æ–‡">è¯¾æ–‡&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/kw/unit_1" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_è¯¾æ–‡ ç¬¬1å•å…ƒ å°æèµ´æ—¥&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/kw/unit_2" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_è¯¾æ–‡ ç¬¬2å•å…ƒ å°æçš„å…¬å¸ç”Ÿæ´»â‘ &lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/kw/unit_3" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_è¯¾æ–‡ ç¬¬3å•å…ƒ å°æåœ¨ç®±æ ¹&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/kw/unit_4" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_è¯¾æ–‡ ç¬¬4å•å…ƒ å°æçš„å…¬å¸ç”Ÿæ´»â‘¡&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/kw/unit_5" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_è¯¾æ–‡ ç¬¬5å•å…ƒ å°æåœ¨æ—¥æœ¬è¿æ–°æ˜¥&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/kw/unit_6" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_è¯¾æ–‡ ç¬¬ï¼–å•å…ƒ å†è§ï¼æ—¥æœ¬&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="æ€»ç»“">æ€»ç»“&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/guan_n5_grammar" target="_blank" rel="noopener noreferrer">è°·å®‰æ—¥è¯­_N5è¯­æ³•æ€»ç»“&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/yuan_n5" target="_blank" rel="noopener noreferrer">åœ†åœ†è€å¸ˆ N5è¯­æ³•æ€»ç»“&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="jlpt">JLPT&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/jlpt/n5/201707" target="_blank" rel="noopener noreferrer">2017å¹´07çœŸé¢˜&lt;/a>&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="æ ‡å‡†æ—¥æœ¬è¯­_åˆçº§_ä¸‹">æ ‡å‡†æ—¥æœ¬è¯­_åˆçº§_ä¸‹&lt;/h2>
&lt;h3 id="å•è¯-1">å•è¯&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/dc/xbrdc7" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸‹_å•è¯ ç¬¬7å•å…ƒ æ£®èµ´åŒ—äº¬&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/dc/xbrdc8" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸‹_å•è¯ ç¬¬8å•å…ƒ ä½™æš‡&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/dc/xbrydc33_40" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_å•è¯ 33_40è¯¾&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/dc/xbrydc41_48" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸Š_å•è¯ 41_48è¯¾&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="è¯­æ³•-1">è¯­æ³•&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/yf/xbryf25_32" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸‹_è¯­æ³• 25-32è¯¾&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/yf/xbryf33_40" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸‹_è¯­æ³• 33-40è¯¾&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/yf/xbryf41_48" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸‹_è¯­æ³• 41-48è¯¾&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="è¯¾æ–‡-1">è¯¾æ–‡&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/kw/unit_7" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸‹_è¯¾æ–‡ ç¬¬7å•å…ƒ æ£®èµ´åŒ—äº¬&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/kw/unit_8" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸‹_è¯¾æ–‡ ç¬¬8å•å…ƒ ä½™æš‡&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/kw/unit_9" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸‹_è¯¾æ–‡ ç¬¬9å•å…ƒ å°é‡èµ´åŒ—äº¬&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/kw/unit_10" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸‹_è¯¾æ–‡ ç¬¬10å•å…ƒ æ¸¸è§ˆåŒ—äº¬&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/kw/unit_11" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸‹_è¯¾æ–‡ ç¬¬11å•å…ƒ åœ¨åŒ—äº¬çš„å·¥ä½œæƒ…å†µ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/kw/unit_12" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥åˆçº§ä¸‹_è¯¾æ–‡ ç¬¬12å•å…ƒ æ–°çš„æ‹“å±•&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="æ€»ç»“-1">æ€»ç»“&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/guan_n4_grammar" target="_blank" rel="noopener noreferrer">è°·å®‰æ—¥è¯­_N4è¯­æ³•æ€»ç»“&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/yuan_n4" target="_blank" rel="noopener noreferrer">åœ†åœ†è€å¸ˆ N4è¯­æ³•æ€»ç»“&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="æ ‡å‡†æ—¥æœ¬è¯­_ä¸­çº§_ä¸Š">æ ‡å‡†æ—¥æœ¬è¯­_ä¸­çº§_ä¸Š&lt;/h2>
&lt;h3 id="å•è¯-2">å•è¯&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/dc/lesson_01" target="_blank" rel="noopener noreferrer">å•è¯ ç¬¬1è¯¾ æ­è®ª/æ‰“æ‹›å‘¼&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/dc/lesson_02" target="_blank" rel="noopener noreferrer">å•è¯ ç¬¬2è¯¾ å¼€å§‹äº¤è°ˆ/ç»“æŸäº¤è°ˆ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/dc/lesson_03" target="_blank" rel="noopener noreferrer">å•è¯ ç¬¬3è¯¾ è‡ªæˆ‘ä»‹ç»&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/dc/lesson_04" target="_blank" rel="noopener noreferrer">å•è¯ ç¬¬4è¯¾ è½¬è¿°ä¿¡æ¯&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="è¯¾æ–‡-2">è¯¾æ–‡&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit01_1" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬1è¯¾ ç›¸é‡&amp;amp;æ—¥æœ¬çš„é“è·¯&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit01_2" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬2è¯¾ å¯’æš„&amp;amp;è§é¢å¯’æš„çš„ç¤¼ä»ª&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit01_3" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬3è¯¾ ä¼šé¢&amp;amp;å§“æ°&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit01_4" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬4è¯¾ ä¸œäº¬æ€»éƒ¨&amp;amp;è¿‘å¹´æ¥å·¥è–ªæ—çš„çŠ¶å†µ&lt;/a>&lt;/li>
&lt;/ul>
&lt;hr>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit02_5" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬5è¯¾ äº§å“ä»‹ç»&amp;amp;æ—¥è¯­çš„è¯æ±‡&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit02_6" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬6è¯¾ å­¦é•¿&amp;amp;å½¢å½¢è‰²è‰²çš„ç­·å­æ–‡åŒ–&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit02_7" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬7è¯¾ é¢„å¤‡ä¼š&amp;amp;ç”µå­é‚®ä»¶çš„å†™æ³•&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit02_8" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬8è¯¾ ç­–åˆ’ä¹¦&amp;amp;ç¢—è£…æ–¹ä¾¿é¢&lt;/a>&lt;/li>
&lt;/ul>
&lt;hr>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit03_9" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬9è¯¾ å‡ºç°éº»çƒ¦&amp;amp;æ„å¤§åˆ©ä¹‹æ—…&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit03_10" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬10è¯¾ å•†è®¨æ—¥ç¨‹&amp;amp;æ¸©æ³‰ç‹å›½æ—¥æœ¬&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit03_11" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬11è¯¾ å¹´è½»äººçš„æ„è¯†&amp;amp;æ¼«ç”»å’ŒåŠ¨ç”»ç‰‡&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit03_12" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬12è¯¾ æœ€åä¸€å¤©&amp;amp;æ–¹è¨€å’Œé€šç”¨è¯­&lt;/a>&lt;/li>
&lt;/ul>
&lt;hr>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit04_13" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬13è¯¾ è¯·æ±‚è‡´è¾&amp;amp;æ—¥æœ¬äººå£åœ¨é€æ¸å‡å°‘-å°‘å­åŒ–&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit04_14" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬14è¯¾ æ©å¸ˆ&amp;amp;æ—¥æœ¬çš„æ±‚èŒæ´»åŠ¨&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit04_15" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬15è¯¾ åŒç­åŒå­¦&amp;amp;æ—¥æœ¬é¤é¦†ä¸€ç¥&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/kw/unit04_16" target="_blank" rel="noopener noreferrer">æ–°æ ‡æ—¥ä¸­çº§ä¸Š ç¬¬16è¯¾ ç»“å©šå–œå®´&amp;amp;å˜åŒ–ä¸­çš„ç»“å©šä»ªå¼&lt;/a>&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h3 id="æ€»ç»“-2">æ€»ç»“&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/guan_n3_grammar" target="_blank" rel="noopener noreferrer">è°·å®‰æ—¥è¯­_N3è¯­æ³•æ€»ç»“&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="jlpt-1">JLPT&lt;/h3>
&lt;ul>
&lt;li>n3_2022_07
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/n3_2022_07_1" target="_blank" rel="noopener noreferrer">è¯æ±‡&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/n3_2022_07_2" target="_blank" rel="noopener noreferrer">è¯­æ³•&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/n3/n3_2022_07_3" target="_blank" rel="noopener noreferrer">é˜…è¯»ç†è§£&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="æ•¬ä½“å’Œç®€ä½“">æ•¬ä½“å’Œç®€ä½“&lt;/h2>
&lt;p>&lt;img src="https://img.hinathan.online/2025/11/751b36dc305c6689eace8ffe1fb9b32c.png" alt="">&lt;/p>
&lt;h3 id="å¦å®šå˜åŒ–è§„åˆ™">âš ï¸å¦å®šå˜åŒ–è§„åˆ™&lt;/h3>
&lt;ul>
&lt;li>
&lt;h5 id="å½¢å®¹è¯-ã‚¤å½¢å®¹è¯ã„å˜-ã">å½¢å®¹è¯-ã‚¤å½¢å®¹è¯ï¼šã„å˜ ã&lt;/h5>
&lt;ul>
&lt;li>æ•¬ï¼šã„å˜ã + ãªã„ã§ã™&lt;/li>
&lt;li>æ•¬ï¼šã„å˜ã + ã‚ã‚Šã¾ã›ã‚“&lt;/li>
&lt;li>ç®€ï¼šã„å˜ã + ãªã„&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;h5 id="å½¢å®¹åŠ¨è¯-ãƒŠå½¢å®¹è¯éšå½¢çš„ã å˜-ã§ã¯">å½¢å®¹åŠ¨è¯-ãƒŠå½¢å®¹è¯ï¼šéšå½¢çš„ï¼ˆã ï¼‰å˜ ã§ã¯&lt;/h5>
&lt;ul>
&lt;li>æ•¬ï¼šï¼ˆã ï¼‰å˜ ã§ã¯ + ã‚ã‚Šã¾ã›ã‚“&lt;/li>
&lt;li>æ•¬ï¼šï¼ˆã ï¼‰å˜ ã§ã¯ + ãªã„ã§ã™&lt;/li>
&lt;li>ç®€ï¼šï¼ˆã ï¼‰å˜ ã§ã¯ + ãªã„&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;h5 id="åè¯åŒ-å½¢å®¹åŠ¨è¯-ãƒŠå½¢å®¹è¯">åè¯ï¼šåŒ å½¢å®¹åŠ¨è¯-ãƒŠå½¢å®¹è¯&lt;/h5>
&lt;/li>
&lt;li>
&lt;h5 id="åŠ¨è¯ã¾ã›ã‚“æˆ–ãªã„å½¢">åŠ¨è¯ï¼šã¾ã›ã‚“æˆ–ãªã„å½¢&lt;/h5>
&lt;/li>
&lt;/ul>
&lt;h2 id="æ—¥è¯­åŠ¨è¯çš„æ´»ç”¨è§„åˆ™">æ—¥è¯­åŠ¨è¯çš„æ´»ç”¨è§„åˆ™&lt;/h2>
&lt;p>&lt;img src="https://img.hinathan.online/2025/11/0fc50884e8fc71785156350c47e2aec3.png" alt="">&lt;/p>
&lt;h2 id="ç‰¹æ®Šçš„ä¸€ç±»åŠ¨è¯">ç‰¹æ®Šçš„ä¸€ç±»åŠ¨è¯&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/tokubetsunadÅshi" target="_blank" rel="noopener noreferrer">ç‰¹æ®Šä¸€ç±»åŠ¨è¯&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="æ•¬è¯­">æ•¬è¯­&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/xbry/jingyu" target="_blank" rel="noopener noreferrer">æ•¬è¯­&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="å…¶ä»–">å…¶ä»–&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://www.hinathan.online/note/ext/Amachan_S01E001" target="_blank" rel="noopener noreferrer">æµ·å¥³_S01E001_æ—¶éš”24å¹´æ˜¥å­å›åˆ°åŒ—ä¸‰é™†&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/ext/sekai_ga_owaru_made_wa" target="_blank" rel="noopener noreferrer">ä¸–ç•ŒãŒçµ‚ã‚‹ã¾ã§ã¯ æ­Œè¯&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/ext/shine_in_the_cruel_night" target="_blank" rel="noopener noreferrer">æ®‹é…·ãªå¤œã«è¼ã‘ æ­Œè¯&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.hinathan.online/note/ext/gurenge" target="_blank" rel="noopener noreferrer">ã€Šçº¢è²åã€‹TV ç‰ˆ OP&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Springæºç é˜…è¯»ï¼ˆä¸€ï¼‰Beançš„åˆ›å»ºè¿‡ç¨‹</title><link>https://www.hinathan.online/blog/spring-bean-create/</link><pubDate>Wed, 16 Apr 2025 13:20:16 +0800</pubDate><guid>https://www.hinathan.online/blog/spring-bean-create/</guid><description>&lt;p>å®ä¾‹åŒ– -&amp;gt; å±æ€§å¡«å…… -&amp;gt; BeanPostProcessorå‰ç½®å¤„ç† -&amp;gt; åˆå§‹åŒ–é˜¶æ®µ -&amp;gt; BeanPostProcessoråç½®å¤„ç† -&amp;gt; åˆå§‹åŒ–å®Œæˆ -&amp;gt; PostConstruct -&amp;gt; InitializingBean.afterPropertiesSet -&amp;gt; è‡ªå®šä¹‰init-method -&amp;gt; AOP&lt;/p>
&lt;h2 id="åˆ›å»ºçš„å¤§è‡´æµç¨‹">åˆ›å»ºçš„å¤§è‡´æµç¨‹&lt;/h2>
&lt;h3 id="æ¨æ–­æ„é€ æ–¹æ³•">æ¨æ–­æ„é€ æ–¹æ³•&lt;/h3>
&lt;p>åˆ©ç”¨è¯¥ç±»çš„æ„é€ æ–¹æ³•æ¥å®ä¾‹åŒ–å¾—åˆ°ä¸€ä¸ªå¯¹è±¡ï¼ˆä½†æ˜¯å¦‚ä½•ä¸€ä¸ªç±»ä¸­æœ‰å¤šä¸ªæ„é€ æ–¹æ³•ï¼ŒSpringåˆ™ä¼šè¿›è¡Œé€‰æ‹©ï¼Œè¿™ä¸ªå«åšæ¨æ–­æ„é€ æ–¹æ³•ï¼‰&lt;/p>
&lt;h3 id="ä¾èµ–æ³¨å…¥">ä¾èµ–æ³¨å…¥&lt;/h3>
&lt;p>å¾—åˆ°ä¸€ä¸ªå¯¹è±¡åï¼ŒSpringä¼šåˆ¤æ–­è¯¥å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨è¢«@Autowiredæ³¨è§£äº†çš„å±æ€§ï¼ŒæŠŠè¿™äº›å±æ€§æ‰¾å‡ºæ¥å¹¶ç”±Springè¿›è¡Œèµ‹å€¼ï¼ˆå±æ€§å¡«å……ï¼‰&lt;/p>
&lt;h3 id="beanpostprocessorå¤„ç†å’Œåˆå§‹åŒ–">BeanPostProcessorå¤„ç†å’Œåˆå§‹åŒ–&lt;/h3>
&lt;p>ä¾èµ–æ³¨å…¥åï¼ŒSpringä¼šåˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦å®ç°äº†&lt;code>BeanNameAware&lt;/code>æ¥å£ã€&lt;code>BeanClassLoaderAware&lt;/code>æ¥å£ã€&lt;code>BeanFactoryAware&lt;/code>æ¥å£ï¼Œå¦‚æœå®ç°äº†ï¼Œå°±è¡¨ç¤ºå½“å‰å¯¹è±¡å¿…é¡»å®ç°è¯¥æ¥å£ä¸­æ‰€å®šä¹‰çš„&lt;code>setBeanName()&lt;/code>ã€&lt;code>setBeanClassLoader()&lt;/code>ã€&lt;code>setBeanFactory()&lt;/code>æ–¹æ³•ï¼Œé‚£Springå°±ä¼šè°ƒç”¨è¿™äº›æ–¹æ³•å¹¶ä¼ å…¥ç›¸åº”çš„å‚æ•°ï¼ˆAwareå›è°ƒï¼‰&lt;/p>
&lt;h3 id="postconstruct-å¤„ç†">PostConstruct å¤„ç†&lt;/h3>
&lt;p>Awareå›è°ƒåï¼ŒSpringä¼šåˆ¤æ–­è¯¥å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨æŸä¸ªæ–¹æ³•è¢«@PostConstructæ³¨è§£äº†ï¼Œå¦‚æœå­˜åœ¨ï¼ŒSpringä¼šè°ƒç”¨å½“å‰å¯¹è±¡çš„æ­¤æ–¹æ³•ï¼ˆåˆå§‹åŒ–å‰ï¼‰&lt;/p>
&lt;h3 id="initializingbeanafterpropertiesset">InitializingBean.afterPropertiesSet&lt;/h3>
&lt;p>ç´§æ¥ç€ï¼ŒSpringä¼šåˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦å®ç°äº†InitializingBeanæ¥å£ï¼Œå¦‚æœå®ç°äº†ï¼Œå°±è¡¨ç¤ºå½“å‰å¯¹è±¡å¿…é¡»å®ç°è¯¥æ¥å£ä¸­çš„afterPropertiesSet()æ–¹æ³•ï¼Œé‚£Springå°±ä¼šè°ƒç”¨å½“å‰å¯¹è±¡ä¸­çš„afterPropertiesSet()æ–¹æ³•ï¼ˆåˆå§‹åŒ–ï¼‰&lt;/p>
&lt;h3 id="è‡ªå®šä¹‰init-method">è‡ªå®šä¹‰init-method&lt;/h3>
&lt;p>æ‰§è¡Œè‡ªå®šä¹‰init-method&lt;/p>
&lt;h3 id="aop">AOP&lt;/h3>
&lt;p>æœ€åï¼ŒSpringä¼šåˆ¤æ–­å½“å‰å¯¹è±¡éœ€ä¸éœ€è¦è¿›è¡ŒAOPï¼Œå¦‚æœä¸éœ€è¦é‚£ä¹ˆBeanå°±åˆ›å»ºå®Œäº†ï¼Œå¦‚æœéœ€è¦è¿›è¡ŒAOPï¼Œåˆ™ä¼šè¿›è¡ŒåŠ¨æ€ä»£ç†å¹¶ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡åšä¸ºBeanï¼ˆåˆå§‹åŒ–åï¼‰&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå½“Springæ ¹æ®UserServiceç±»æ¥åˆ›å»ºä¸€ä¸ªBeanæ—¶ï¼š&lt;/p>
&lt;ol>
&lt;li>å¦‚æœä¸ç”¨è¿›è¡ŒAOPï¼Œé‚£ä¹ˆBeanå°±æ˜¯UserServiceç±»çš„æ„é€ æ–¹æ³•æ‰€å¾—åˆ°çš„å¯¹è±¡ã€‚&lt;/li>
&lt;li>å¦‚æœéœ€è¦è¿›è¡ŒAOPï¼Œé‚£ä¹ˆBeanå°±æ˜¯UserServiceçš„ä»£ç†ç±»æ‰€å®ä¾‹åŒ–å¾—åˆ°çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯UserServiceæœ¬èº«æ‰€å¾—åˆ°çš„å¯¹è±¡ã€‚&lt;/li>
&lt;/ol>
&lt;p>Beanå¯¹è±¡åˆ›å»ºå‡ºæ¥åï¼š&lt;/p>
&lt;ol>
&lt;li>å¦‚æœå½“å‰Beanæ˜¯å•ä¾‹Beanï¼Œé‚£ä¹ˆä¼šæŠŠè¯¥Beanå¯¹è±¡å­˜å…¥ä¸€ä¸ªMap&amp;lt;String, Object&amp;gt;ï¼ŒMapçš„keyä¸ºbeanNameï¼Œvalueä¸ºBeanå¯¹è±¡ã€‚è¿™æ ·ä¸‹æ¬¡getBeanæ—¶å°±å¯ä»¥ç›´æ¥ä»Mapä¸­æ‹¿åˆ°å¯¹åº”çš„Beanå¯¹è±¡äº†ã€‚ï¼ˆå®é™…ä¸Šï¼Œåœ¨Springæºç ä¸­ï¼Œè¿™ä¸ªMapå°±æ˜¯å•ä¾‹æ± ï¼‰&lt;/li>
&lt;li>å¦‚æœå½“å‰Beanæ˜¯åŸå‹Beanï¼Œé‚£ä¹ˆåç»­æ²¡æœ‰å…¶ä»–åŠ¨ä½œï¼Œä¸ä¼šå­˜å…¥ä¸€ä¸ªMapï¼Œä¸‹æ¬¡getBeanæ—¶ä¼šå†æ¬¡æ‰§è¡Œä¸Šè¿°åˆ›å»ºè¿‡ç¨‹ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„Beanå¯¹è±¡ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="åˆå§‹åŒ–å…¥å£">åˆå§‹åŒ–å…¥å£&lt;/h2>
&lt;p>&lt;code>AbstractAutowireCapableBeanFactory&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// æºç è·¯å¾„ï¼šorg.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">protected&lt;/span> Object &lt;span style="color:#a6e22e">initializeBean&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String beanName&lt;span style="color:#f92672">,&lt;/span> Object bean&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#a6e22e">@Nullable&lt;/span> RootBeanDefinition mbd&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// è°ƒç”¨Awareæ¥å£æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> invokeAwareMethods&lt;span style="color:#f92672">(&lt;/span>beanName&lt;span style="color:#f92672">,&lt;/span> bean&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Object wrappedBean &lt;span style="color:#f92672">=&lt;/span> bean&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>mbd &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#f92672">!&lt;/span>mbd&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isSynthetic&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æ‰§è¡ŒBeanPostProcessorå‰ç½®å¤„ç†ï¼ˆåŒ…æ‹¬@PostConstructæ³¨å…¥ï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> wrappedBean &lt;span style="color:#f92672">=&lt;/span> applyBeanPostProcessorsBeforeInitialization&lt;span style="color:#f92672">(&lt;/span>wrappedBean&lt;span style="color:#f92672">,&lt;/span> beanName&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æ‰§è¡ŒInitializingBeanå’Œinit-method
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> invokeInitMethods&lt;span style="color:#f92672">(&lt;/span>beanName&lt;span style="color:#f92672">,&lt;/span> wrappedBean&lt;span style="color:#f92672">,&lt;/span> mbd&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Throwable ex&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> BeanCreationException&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>mbd &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#f92672">!&lt;/span>mbd&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">isSynthetic&lt;/span>&lt;span style="color:#f92672">())&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æ‰§è¡ŒBeanPostProcessoråç½®å¤„ç†
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> wrappedBean &lt;span style="color:#f92672">=&lt;/span> applyBeanPostProcessorsAfterInitialization&lt;span style="color:#f92672">(&lt;/span>wrappedBean&lt;span style="color:#f92672">,&lt;/span> beanName&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> wrappedBean&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="postconstruct-å¤„ç†æœºåˆ¶">@PostConstruct å¤„ç†æœºåˆ¶&lt;/h2>
&lt;p>InitDestroyAnnotationBeanPostProcessor&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// æºç å…³é”®è·¯å¾„ï¼šorg.springframework.beans.factory.annotation.InitDestroyAnnotationBeanPostProcessor
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">public&lt;/span> Object &lt;span style="color:#a6e22e">postProcessBeforeInitialization&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Object bean&lt;span style="color:#f92672">,&lt;/span> String beanName&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> BeansException &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// è·å–@PostConstructå…ƒæ•°æ®
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> LifecycleMetadata metadata &lt;span style="color:#f92672">=&lt;/span> findLifecycleMetadata&lt;span style="color:#f92672">(&lt;/span>bean&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getClass&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// åå°„æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> metadata&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">invokeInitMethods&lt;/span>&lt;span style="color:#f92672">(&lt;/span>bean&lt;span style="color:#f92672">,&lt;/span> beanName&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Throwable ex&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> BeanCreationException&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> bean&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="initializingbean-å¤„ç†æœºåˆ¶">InitializingBean å¤„ç†æœºåˆ¶&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// æºç è·¯å¾„ï¼šorg.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">protected&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">invokeInitMethods&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String beanName&lt;span style="color:#f92672">,&lt;/span> Object bean&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#a6e22e">@Nullable&lt;/span> RootBeanDefinition mbd&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">throws&lt;/span> Throwable &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>bean &lt;span style="color:#66d9ef">instanceof&lt;/span> InitializingBean&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æ‰§è¡Œæ¥å£æ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">((&lt;/span>InitializingBean&lt;span style="color:#f92672">)&lt;/span> bean&lt;span style="color:#f92672">).&lt;/span>&lt;span style="color:#a6e22e">afterPropertiesSet&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>mbd &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> bean&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getClass&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> NullBean&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">class&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> String initMethodName &lt;span style="color:#f92672">=&lt;/span> mbd&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getInitMethodName&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>StringUtils&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">hasLength&lt;/span>&lt;span style="color:#f92672">(&lt;/span>initMethodName&lt;span style="color:#f92672">))&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// åå°„è°ƒç”¨è‡ªå®šä¹‰initæ–¹æ³•
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> invokeCustomInitMethod&lt;span style="color:#f92672">(&lt;/span>beanName&lt;span style="color:#f92672">,&lt;/span> bean&lt;span style="color:#f92672">,&lt;/span> mbd&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ‰§è¡Œé¡ºåºä¸çº¿ç¨‹å®‰å…¨">æ‰§è¡Œé¡ºåºä¸çº¿ç¨‹å®‰å…¨&lt;/h2>
&lt;p>BeanPostProcessor.postProcessBeforeInitialization -&amp;gt; PostConstruct -&amp;gt; InitializingBean.afterPropertiesSet -&amp;gt; è‡ªå®šä¹‰init-method -&amp;gt; BeanPostProcessor.postProcessAfterInitialization&lt;/p>
&lt;h2 id="æ ¸å¿ƒç±»">æ ¸å¿ƒç±»&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>InitDestroyAnnotationBeanPostProcessor&lt;/p>
&lt;ul>
&lt;li>postProcessBeforeInitialization()&lt;/li>
&lt;li>findLifecycleMetadata()&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>AbstractAutowireCapableBeanFactory&lt;/p>
&lt;ul>
&lt;li>invokeInitMethods()&lt;/li>
&lt;li>invokeCustomInitMethod()&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>CommonAnnotationBeanPostProcessor&lt;/p>
&lt;ul>
&lt;li>postProcessBeforeInitialization()&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="postconstruct-å’Œ-initializingbean">@PostConstruct å’Œ InitializingBean&lt;/h2>
&lt;p>@PostConstruct å’Œ InitializingBean åœ¨ Spring ç”Ÿå‘½å‘¨æœŸä¸­æ‰®æ¼”ç€ä¸åŒçš„è§’è‰²ï¼š&lt;/p>
&lt;h3 id="postconstruct">@PostConstruct&lt;/h3>
&lt;ul>
&lt;li>åŸºäºæ ‡å‡†æ³¨è§£çš„è½»é‡çº§åˆå§‹åŒ–&lt;/li>
&lt;li>é€šè¿‡BeanPostProcessorå®ç°&lt;/li>
&lt;li>æ”¯æŒæ–¹æ³•çº§ç»†ç²’åº¦æ§åˆ¶&lt;/li>
&lt;/ul>
&lt;h3 id="initializingbean">InitializingBean&lt;/h3>
&lt;ul>
&lt;li>æ¡†æ¶åŸç”Ÿæ¥å£æ–¹æ¡ˆ&lt;/li>
&lt;li>ç›´æ¥é›†æˆåˆ°Beanåˆå§‹åŒ–æµç¨‹&lt;/li>
&lt;li>æä¾›ç±»å‹å®‰å…¨çš„å›è°ƒ&lt;/li>
&lt;/ul>
&lt;h3 id="ç”Ÿäº§ç¯å¢ƒé€‰æ‹©å»ºè®®">ç”Ÿäº§ç¯å¢ƒé€‰æ‹©å»ºè®®&lt;/h3>
&lt;ul>
&lt;li>80%åœºæ™¯ä½¿ç”¨@PostConstruct&lt;/li>
&lt;li>éœ€è¦å¼ºåˆ¶åˆå§‹åŒ–ä¿éšœæ—¶é€‰æ‹©InitializingBean&lt;/li>
&lt;li>ç¬¬ä¸‰æ–¹åº“é›†æˆä½¿ç”¨init-method&lt;/li>
&lt;/ul></description></item><item><title>Filterå’ŒInteceptorçš„åŒºåˆ«</title><link>https://www.hinathan.online/blog/filter_and_interceptor/</link><pubDate>Sat, 01 Mar 2025 14:16:34 +0800</pubDate><guid>https://www.hinathan.online/blog/filter_and_interceptor/</guid><description>&lt;p>æœ€è¿‘åœ¨å¤„ç†&lt;code>Spring Security&lt;/code>çš„å·¥ä½œï¼Œ ä¸€ä¸ªè¯·æ±‚ç»è¿‡é‚£ä¹ˆå¤šè¿‡æ»¤å™¨å’Œæ‹¦æˆªå™¨ï¼Œåˆ°åº•æœ‰ä»€ä¹ˆå…ˆåé¡ºåºåˆæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ&lt;/p>
&lt;p>åœ¨Javaä½“ç³»ä¸­ï¼Œæ‰€æœ‰çš„httpè¯·æ±‚æœ€åéƒ½ç»è¿‡servletå¤„ç†ã€‚å°±åƒæˆ‘ä»¬ä¸€å¼€å§‹å­¦ä¹ servletçš„æ—¶å€™ï¼Œç¼–ç æˆ‘ä»¬éœ€è¦è‡ªå·±åœ¨ä¸€ä¸ªfilterä¸­å¤„ç†ï¼Œæ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½éœ€è¦æˆ‘ä»¬è‡ªå·±é€šè¿‡&lt;code>servlet api&lt;/code>è·å–å­—èŠ‚æµå¤„ç†ï¼Œç­‰ç­‰ä¸€ç³»åˆ—éº»çƒ¦åˆç¹å¤šçš„å·¥ä½œï¼Œåæ¥Spring MVCå‡ºç°äº†ï¼Œè§£å†³äº†è¿™ä¸€é—®é¢˜ã€‚&lt;/p>
&lt;p>Spring MVCæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªservletï¼Œå°±æ˜¯&lt;code>DispatcherServlet&lt;/code> ï¼ŒDispatcherServletå¤„ç†äº†ä¸šåŠ¡è¯·æ±‚ï¼Œç„¶ååˆé€šè¿‡DispatcherServletè¿”å›ï¼Œå°±åƒæˆ‘ä»¬è‡ªå·±è‡ªå®šä¹‰ä¸€ä¸ªservleté‚£æ ·ï¼Œåªä¸è¿‡åœ¨å¤„ç†servletçš„è¿‡ç¨‹ä¸­è¦å¤æ‚çš„å¤šã€‚&lt;/p>
&lt;p>http -&amp;gt; filter -&amp;gt; servlet -&amp;gt; interceptor -&amp;gt; controller&lt;/p>
&lt;p>&lt;code>Filter&lt;/code> å’Œ &lt;code>Interceptor&lt;/code> æ˜¯ Java Web å¼€å‘ä¸­å¸¸ç”¨çš„ä¸¤ç§æ‹¦æˆªæœºåˆ¶ï¼Œè™½ç„¶å®ƒä»¬éƒ½å¯ä»¥ç”¨æ¥å®ç°ç±»ä¼¼çš„åŠŸèƒ½ï¼Œæ¯”å¦‚è¯·æ±‚æ‹¦æˆªã€æƒé™æ ¡éªŒã€æ—¥å¿—è®°å½•ç­‰ï¼Œä½†å®ƒä»¬çš„ä½œç”¨èŒƒå›´ã€ä½¿ç”¨æ–¹å¼ã€ç”Ÿå‘½å‘¨æœŸç­‰æ–¹é¢éƒ½æœ‰æ˜æ˜¾åŒºåˆ«ã€‚&lt;/p>
&lt;h3 id="ä¸€filterè¿‡æ»¤å™¨">ğŸ§©ä¸€ã€Filterï¼ˆè¿‡æ»¤å™¨ï¼‰&lt;/h3>
&lt;p>&lt;code>javax.servlet.Filter&lt;/code>å±äºServlet è§„èŒƒä¸­çš„ç»„ä»¶ï¼Œå±äº Java EE æ ‡å‡†ã€‚ä½¿ç”¨åœ¨ &lt;strong>Servlet å®¹å™¨ï¼ˆå¦‚ Tomcatï¼‰çº§åˆ«&lt;/strong>ã€‚æ‹¦æˆª &lt;strong>HTTP è¯·æ±‚å’Œå“åº”&lt;/strong>ï¼Œåœ¨è¿›å…¥ Servlet ä¹‹å‰å’Œå“åº”è¿”å›å®¢æˆ·ç«¯ä¹‹å‰å¤„ç†ã€‚&lt;/p>
&lt;hr>
&lt;h3 id="-äºŒinterceptoræ‹¦æˆªå™¨">ğŸ§© äºŒã€Interceptorï¼ˆæ‹¦æˆªå™¨ï¼‰&lt;/h3>
&lt;p>&lt;code>HandlerInterceptor&lt;/code>æ˜¯Spring MVC æä¾›çš„åŠŸèƒ½ï¼Œå±äº &lt;strong>Spring æ¡†æ¶å±‚é¢&lt;/strong>ã€‚æ‹¦æˆª &lt;strong>Controller æ–¹æ³•çš„è°ƒç”¨&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>è¯·æ±‚è¿›å…¥ DispatcherServlet ä¹‹åæ‰ç”Ÿæ•ˆï¼ˆFilter æ˜¯ DispatcherServlet ä¹‹å‰ï¼‰&lt;/li>
&lt;/ul>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>ç‰¹æ€§&lt;/th>
&lt;th>Filterï¼ˆè¿‡æ»¤å™¨ï¼‰&lt;/th>
&lt;th>Interceptorï¼ˆæ‹¦æˆªå™¨ï¼‰&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>æ‰€å±ä½“ç³»&lt;/td>
&lt;td>Servlet è§„èŒƒ&lt;/td>
&lt;td>Spring MVC æ¡†æ¶&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ä½œç”¨èŒƒå›´&lt;/td>
&lt;td>æ‰€æœ‰è¯·æ±‚ï¼ŒåŒ…æ‹¬é™æ€èµ„æº&lt;/td>
&lt;td>ä»…æ‹¦æˆªæ§åˆ¶å™¨è¯·æ±‚ï¼ˆä¸åŒ…æ‹¬é™æ€èµ„æºï¼‰&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>æ‰§è¡Œé¡ºåº&lt;/td>
&lt;td>åœ¨ DispatcherServlet ä¹‹å‰æ‰§è¡Œ&lt;/td>
&lt;td>åœ¨ DispatcherServlet ä¹‹åæ‰§è¡Œ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>é…ç½®æ–¹å¼&lt;/td>
&lt;td>web.xml æˆ–æ³¨è§£&lt;/td>
&lt;td>Java Config (&lt;code>WebMvcConfigurer&lt;/code>)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>æ‹¦æˆªç²’åº¦&lt;/td>
&lt;td>è¯·æ±‚çº§åˆ«ï¼ˆrequest/responseï¼‰&lt;/td>
&lt;td>æ–¹æ³•çº§åˆ«ï¼ˆHandlerï¼‰&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å¸¸ç”¨åœºæ™¯&lt;/td>
&lt;td>ç¼–ç ã€æ—¥å¿—ã€æƒé™ã€XSS&lt;/td>
&lt;td>ç™»å½•ã€æƒé™ã€æ—¥å¿—ã€é™æµ&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item><item><title>Javaå¹¶å‘ç¼–ç¨‹ï¼ˆå››ï¼‰å¹¶å‘ä¸‰å¤§ç‰¹æ€§-æœ‰åºæ€§</title><link>https://www.hinathan.online/blog/04-ordering/</link><pubDate>Tue, 21 Jan 2020 19:20:16 +0800</pubDate><guid>https://www.hinathan.online/blog/04-ordering/</guid><description>&lt;h2 id="æœ‰åºæ€§">æœ‰åºæ€§&lt;/h2>
&lt;p>å³ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚&lt;u>JVM å­˜åœ¨æŒ‡ä»¤é‡æ’ï¼Œæ‰€ä»¥å­˜åœ¨æœ‰åºæ€§é—®é¢˜ã€‚&lt;/u>&lt;/p>
&lt;h4 id="å¦‚ä½•ä¿è¯æœ‰åºæ€§">å¦‚ä½•ä¿è¯æœ‰åºæ€§&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>é€šè¿‡&lt;code>volatile&lt;/code>å…³é”®å­—ä¿è¯æœ‰åºæ€§ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é€šè¿‡&lt;code>å†…å­˜å±éšœ&lt;/code>ä¿è¯æœ‰åºæ€§ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é€šè¿‡&lt;code>synchronized&lt;/code>å…³é”®å­—ä¿è¯æœ‰åºæ€§ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é€šè¿‡&lt;code>Lock&lt;/code>ä¿è¯æœ‰åºæ€§ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="æœ‰åºæ€§é—®é¢˜æ·±å…¥åˆ†æ">æœ‰åºæ€§é—®é¢˜æ·±å…¥åˆ†æ&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">ReOrderTest&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> x &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">,&lt;/span> y &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> a &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">,&lt;/span> b &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> InterruptedException &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">true&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> i&lt;span style="color:#f92672">++;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> x &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> y &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> a &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> b &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Thread thread1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(()&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> shortWait&lt;span style="color:#f92672">(&lt;/span>20000&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> a &lt;span style="color:#f92672">=&lt;/span> 1&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> x &lt;span style="color:#f92672">=&lt;/span> b&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">});&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Thread thread2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(()&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> b &lt;span style="color:#f92672">=&lt;/span> 1&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> y &lt;span style="color:#f92672">=&lt;/span> a&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">});&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> thread1&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> thread2&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> thread1&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">join&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> thread2&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">join&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;ç¬¬&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> i &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;æ¬¡ï¼ˆ&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> x &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;,&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> y &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;)&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>x &lt;span style="color:#f92672">==&lt;/span> 0 &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> y &lt;span style="color:#f92672">==&lt;/span> 0&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">shortWait&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">long&lt;/span> interval&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> start &lt;span style="color:#f92672">=&lt;/span> System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">nanoTime&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> end&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> end &lt;span style="color:#f92672">=&lt;/span> System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">nanoTime&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">while&lt;/span> &lt;span style="color:#f92672">(&lt;/span>start &lt;span style="color:#f92672">+&lt;/span> interval &lt;span style="color:#f92672">&amp;gt;=&lt;/span> end&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æœ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>ç¬¬13512æ¬¡&lt;span style="color:#960050;background-color:#1e0010">ï¼ˆ&lt;/span>0&lt;span style="color:#f92672">,&lt;/span>1&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ç¬¬13513æ¬¡&lt;span style="color:#960050;background-color:#1e0010">ï¼ˆ&lt;/span>1&lt;span style="color:#f92672">,&lt;/span>0&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ç¬¬13514æ¬¡&lt;span style="color:#960050;background-color:#1e0010">ï¼ˆ&lt;/span>1&lt;span style="color:#f92672">,&lt;/span>0&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ç¬¬13515æ¬¡&lt;span style="color:#960050;background-color:#1e0010">ï¼ˆ&lt;/span>0&lt;span style="color:#f92672">,&lt;/span>1&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ç¬¬13516æ¬¡&lt;span style="color:#960050;background-color:#1e0010">ï¼ˆ&lt;/span>0&lt;span style="color:#f92672">,&lt;/span>1&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æŒ‡ä»¤é‡æ’åº">æŒ‡ä»¤é‡æ’åº&lt;/h2>
&lt;p>Javaè¯­è¨€è§„èŒƒè§„å®šJVMçº¿ç¨‹å†…éƒ¨ç»´æŒé¡ºåºåŒ–è¯­ä¹‰ã€‚å³åªè¦ç¨‹åºçš„æœ€ç»ˆç»“æœä¸å®ƒé¡ºåºåŒ–æƒ…å†µçš„ç»“æœç›¸ç­‰ï¼Œé‚£ä¹ˆæŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºå¯ä»¥ä¸ä»£ç é¡ºåºä¸ä¸€è‡´ï¼Œæ­¤è¿‡ç¨‹å«æŒ‡ä»¤çš„é‡æ’åºã€‚&lt;/p>
&lt;h3 id="æŒ‡ä»¤é‡æ’åºçš„æ„ä¹‰">æŒ‡ä»¤é‡æ’åºçš„æ„ä¹‰&lt;/h3>
&lt;p>JVMèƒ½æ ¹æ®å¤„ç†å™¨ç‰¹æ€§ï¼ˆCPUå¤šçº§ç¼“å­˜ç³»ç»Ÿã€å¤šæ ¸å¤„ç†å™¨ç­‰ï¼‰é€‚å½“çš„å¯¹æœºå™¨æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼Œä½¿æœºå™¨æŒ‡ä»¤èƒ½æ›´ç¬¦åˆCPUçš„æ‰§è¡Œç‰¹æ€§ï¼Œæœ€å¤§é™åº¦çš„å‘æŒ¥æœºå™¨æ€§èƒ½ã€‚&lt;/p>
&lt;p>åœ¨ç¼–è¯‘å™¨ä¸CPUå¤„ç†å™¨ä¸­éƒ½èƒ½æ‰§è¡ŒæŒ‡ä»¤é‡æ’ä¼˜åŒ–æ“ä½œ&lt;/p>
&lt;p>&lt;img src="https://img.hinathan.online/2025/07/28567.png" alt="">&lt;/p>
&lt;h3 id="volatileé‡æ’åºè§„åˆ™">volatileé‡æ’åºè§„åˆ™&lt;/h3>
&lt;p>&lt;img src="https://img.hinathan.online/2025/07/28665.png" alt="">&lt;/p>
&lt;h3 id="volatileç¦æ­¢é‡æ’åºåœºæ™¯">volatileç¦æ­¢é‡æ’åºåœºæ™¯&lt;/h3>
&lt;ol>
&lt;li>ç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileå†™ï¼Œä¸ç®¡ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ä»€ä¹ˆéƒ½ä¸ä¼šé‡æ’åº&lt;/li>
&lt;li>ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileè¯»ï¼Œä¸ç®¡ç¬¬äºŒä¸ªæ“ä½œæ˜¯ä»€ä¹ˆéƒ½ä¸ä¼šé‡æ’åº&lt;/li>
&lt;li>ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileå†™ï¼Œç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileè¯»ï¼Œä¹Ÿä¸ä¼šå‘ç”Ÿé‡æ’åº&lt;/li>
&lt;/ol>
&lt;h2 id="å†…å­˜å±éšœ">å†…å­˜å±éšœ&lt;/h2>
&lt;h3 id="jmmå†…å­˜å±éšœæ’å…¥ç­–ç•¥">JMMå†…å­˜å±éšœæ’å…¥ç­–ç•¥&lt;/h3>
&lt;ol>
&lt;li>åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ªStoreStoreå±éšœ&lt;/li>
&lt;li>åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªStoreLoadå±éšœ&lt;/li>
&lt;li>åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªLoadLoadå±éšœ&lt;/li>
&lt;li>åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªLoadStoreå±éšœ&lt;/li>
&lt;/ol>
&lt;p>â€‹ &lt;img src="https://img.hinathan.online/2025/07/28670.png" alt="0">&lt;/p>
&lt;h3 id="jvmå±‚é¢çš„å†…å­˜å±éšœ">JVMå±‚é¢çš„å†…å­˜å±éšœ&lt;/h3>
&lt;p>åœ¨JSRè§„èŒƒä¸­å®šä¹‰äº†4ç§å†…å­˜å±éšœï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>LoadLoadå±éšœ&lt;/strong>ï¼šï¼ˆæŒ‡ä»¤Load1; LoadLoad; Load2ï¼‰ï¼Œåœ¨Load2åŠåç»­è¯»å–æ“ä½œè¦è¯»å–çš„æ•°æ®è¢«è®¿é—®å‰ï¼Œä¿è¯Load1è¦è¯»å–çš„æ•°æ®è¢«è¯»å–å®Œæ¯•ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>LoadStoreå±éšœ&lt;/strong>ï¼šï¼ˆæŒ‡ä»¤Load1; LoadStore; Store2ï¼‰ï¼Œåœ¨Store2åŠåç»­å†™å…¥æ“ä½œè¢«åˆ·å‡ºå‰ï¼Œä¿è¯Load1è¦è¯»å–çš„æ•°æ®è¢«è¯»å–å®Œæ¯•ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>StoreStoreå±éšœ&lt;/strong>ï¼šï¼ˆæŒ‡ä»¤Store1; StoreStore; Store2ï¼‰ï¼Œåœ¨Store2åŠåç»­å†™å…¥æ“ä½œæ‰§è¡Œå‰ï¼Œä¿è¯Store1çš„å†™å…¥æ“ä½œå¯¹å…¶å®ƒå¤„ç†å™¨å¯è§ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>StoreLoadå±éšœ&lt;/strong>ï¼šï¼ˆæŒ‡ä»¤Store1; StoreLoad; Load2ï¼‰ï¼Œåœ¨Load2åŠåç»­æ‰€æœ‰è¯»å–æ“ä½œæ‰§è¡Œå‰ï¼Œä¿è¯Store1çš„å†™å…¥å¯¹æ‰€æœ‰å¤„ç†å™¨å¯è§ã€‚å®ƒçš„å¼€é”€æ˜¯å››ç§å±éšœä¸­æœ€å¤§çš„ã€‚åœ¨å¤§å¤šæ•°å¤„ç†å™¨çš„å®ç°ä¸­ï¼Œè¿™ä¸ªå±éšœæ˜¯ä¸ªä¸‡èƒ½å±éšœï¼Œå…¼å…·å…¶å®ƒä¸‰ç§å†…å­˜å±éšœçš„åŠŸèƒ½&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>ç”±äºx86åªæœ‰store loadå¯èƒ½ä¼šé‡æ’åºï¼Œæ‰€ä»¥åªæœ‰JSRçš„StoreLoadå±éšœå¯¹åº”å®ƒçš„mfenceæˆ–lockå‰ç¼€æŒ‡ä»¤ï¼Œå…¶ä»–å±éšœå¯¹åº”ç©ºæ“ä½œ&lt;/p>
&lt;h3 id="ç¡¬ä»¶å±‚å†…å­˜å±éšœ">ç¡¬ä»¶å±‚å†…å­˜å±éšœ&lt;/h3>
&lt;p>ç¡¬ä»¶å±‚æä¾›äº†ä¸€ç³»åˆ—çš„å†…å­˜å±éšœ memory barrier / memory fence(Intelçš„ææ³•)æ¥æä¾›ä¸€è‡´æ€§çš„èƒ½åŠ›ã€‚&lt;/p>
&lt;p>æ‹¿X86å¹³å°æ¥è¯´ï¼Œæœ‰å‡ ç§ä¸»è¦çš„å†…å­˜å±éšœï¼š&lt;/p>
&lt;ol>
&lt;li>lfenceï¼Œæ˜¯ä¸€ç§Load Barrier è¯»å±éšœ&lt;/li>
&lt;li>sfence, æ˜¯ä¸€ç§Store Barrier å†™å±éšœ&lt;/li>
&lt;li>mfence, æ˜¯ä¸€ç§å…¨èƒ½å‹çš„å±éšœï¼Œå…·å¤‡lfenceå’Œsfenceçš„èƒ½åŠ›&lt;/li>
&lt;li>Lockå‰ç¼€ï¼ŒLockä¸æ˜¯ä¸€ç§å†…å­˜å±éšœï¼Œä½†æ˜¯å®ƒèƒ½å®Œæˆç±»ä¼¼å†…å­˜å±éšœçš„åŠŸèƒ½ã€‚Lockä¼šå¯¹CPUæ€»çº¿å’Œé«˜é€Ÿç¼“å­˜åŠ é”ï¼Œå¯ä»¥ç†è§£ä¸ºCPUæŒ‡ä»¤çº§çš„ä¸€ç§é”ã€‚å®ƒåé¢å¯ä»¥è·ŸADD, ADC, AND, BTC, BTR, BTS, CMPXCHG, CMPXCH8B, DEC, INC, NEG, NOT, OR, SBB, SUB, XOR, XADD, and XCHGç­‰æŒ‡ä»¤ã€‚&lt;/li>
&lt;/ol>
&lt;h4 id="å†…å­˜å±éšœæœ‰ä¸¤ä¸ªèƒ½åŠ›">å†…å­˜å±éšœæœ‰ä¸¤ä¸ªèƒ½åŠ›&lt;/h4>
&lt;ol>
&lt;li>é˜»æ­¢å±éšœä¸¤è¾¹çš„æŒ‡ä»¤é‡æ’åº&lt;/li>
&lt;li>åˆ·æ–°å¤„ç†å™¨ç¼“å­˜/å†²åˆ·å¤„ç†å™¨ç¼“å­˜&lt;/li>
&lt;/ol>
&lt;p>å¯¹Load Barrieræ¥è¯´ï¼Œåœ¨è¯»æŒ‡ä»¤å‰æ’å…¥è¯»å±éšœï¼Œå¯ä»¥è®©é«˜é€Ÿç¼“å­˜ä¸­çš„æ•°æ®å¤±æ•ˆï¼Œé‡æ–°ä»ä¸»å†…å­˜åŠ è½½æ•°æ®ï¼›å¯¹Store Barrieræ¥è¯´ï¼Œåœ¨å†™æŒ‡ä»¤ä¹‹åæ’å…¥å†™å±éšœï¼Œèƒ½è®©å†™å…¥ç¼“å­˜çš„æœ€æ–°æ•°æ®å†™å›åˆ°ä¸»å†…å­˜ã€‚&lt;/p>
&lt;p>Lockå‰ç¼€å®ç°äº†ç±»ä¼¼çš„èƒ½åŠ›ï¼Œå®ƒå…ˆå¯¹æ€»çº¿å’Œç¼“å­˜åŠ é”ï¼Œç„¶åæ‰§è¡Œåé¢çš„æŒ‡ä»¤ï¼Œæœ€åé‡Šæ”¾é”åä¼šæŠŠé«˜é€Ÿç¼“å­˜ä¸­çš„æ•°æ®åˆ·æ–°å›ä¸»å†…å­˜ã€‚åœ¨Locké”ä½æ€»çº¿çš„æ—¶å€™ï¼Œå…¶ä»–CPUçš„è¯»å†™è¯·æ±‚éƒ½ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é”é‡Šæ”¾ã€‚&lt;/p>
&lt;p>ä¸åŒç¡¬ä»¶å®ç°å†…å­˜å±éšœçš„æ–¹å¼ä¸åŒï¼ŒJavaå†…å­˜æ¨¡å‹å±è”½äº†è¿™ç§åº•å±‚ç¡¬ä»¶å¹³å°çš„å·®å¼‚ï¼Œç”±JVMæ¥ä¸ºä¸åŒçš„å¹³å°ç”Ÿæˆç›¸åº”çš„æœºå™¨ç ã€‚&lt;/p></description></item><item><title>Javaå¹¶å‘ç¼–ç¨‹ï¼ˆä¸‰ï¼‰å¹¶å‘ä¸‰å¤§ç‰¹æ€§-å¯è§æ€§</title><link>https://www.hinathan.online/blog/03-visibility/</link><pubDate>Wed, 15 Jan 2020 22:20:16 +0800</pubDate><guid>https://www.hinathan.online/blog/03-visibility/</guid><description>&lt;h2 id="å¯è§æ€§">å¯è§æ€§&lt;/h2>
&lt;p>å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°ä¿®æ”¹çš„å€¼ã€‚Java å†…å­˜æ¨¡å‹æ˜¯é€šè¿‡åœ¨å˜é‡ä¿®æ”¹åå°†æ–°å€¼åŒæ­¥å›ä¸»å†…å­˜ï¼Œåœ¨å˜é‡è¯»å–å‰ä»ä¸»å†…å­˜åˆ·æ–°å˜é‡å€¼è¿™ç§ä¾èµ–ä¸»å†…å­˜ä½œä¸ºä¼ é€’åª’ä»‹çš„æ–¹æ³•æ¥å®ç°å¯è§æ€§çš„ã€‚&lt;/p>
&lt;h3 id="å¦‚ä½•ä¿è¯å¯è§æ€§">å¦‚ä½•ä¿è¯å¯è§æ€§&lt;/h3>
&lt;ul>
&lt;li>é€šè¿‡ &lt;code>volatile&lt;/code> å…³é”®å­—ä¿è¯å¯è§æ€§ã€‚&lt;/li>
&lt;li>é€šè¿‡ &lt;code>å†…å­˜å±éšœ&lt;/code>ä¿è¯å¯è§æ€§ã€‚&lt;/li>
&lt;li>é€šè¿‡ &lt;code>synchronized&lt;/code> å…³é”®å­—ä¿è¯å¯è§æ€§ã€‚&lt;/li>
&lt;li>é€šè¿‡ &lt;code>Lock&lt;/code>ä¿è¯å¯è§æ€§ã€‚&lt;/li>
&lt;li>é€šè¿‡ &lt;code>final&lt;/code> å…³é”®å­—ä¿è¯å¯è§æ€§&lt;/li>
&lt;/ul>
&lt;h3 id="å¯è§æ€§é—®é¢˜æ·±å…¥åˆ†æ">å¯è§æ€§é—®é¢˜æ·±å…¥åˆ†æ&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly -Xcomp
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">VisibilityTest&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> flag &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">refresh&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> flag &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">currentThread&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;ä¿®æ”¹flag&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">load&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">currentThread&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;å¼€å§‹æ‰§è¡Œ.....&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> &lt;span style="color:#f92672">(&lt;/span>flag&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> i&lt;span style="color:#f92672">++;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//TODO ä¸šåŠ¡é€»è¾‘
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">currentThread&lt;/span>&lt;span style="color:#f92672">().&lt;/span>&lt;span style="color:#a6e22e">getName&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#e6db74">&amp;#34;è·³å‡ºå¾ªç¯: i=&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> i&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> InterruptedException &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> VisibilityTest test &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> VisibilityTest&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// çº¿ç¨‹threadAæ¨¡æ‹Ÿæ•°æ®åŠ è½½åœºæ™¯
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Thread threadA &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(&lt;/span>test&lt;span style="color:#f92672">::&lt;/span>load&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;threadA&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> threadA&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// è®©threadAæ‰§è¡Œä¸€ä¼šå„¿
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sleep&lt;/span>&lt;span style="color:#f92672">(&lt;/span>1000&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// çº¿ç¨‹threadBé€šè¿‡flagæ§åˆ¶threadAçš„æ‰§è¡Œæ—¶é—´
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Thread threadB &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(&lt;/span>test&lt;span style="color:#f92672">::&lt;/span>refresh&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#e6db74">&amp;#34;threadB&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> threadB&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">shortWait&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">long&lt;/span> interval&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> start &lt;span style="color:#f92672">=&lt;/span> System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">nanoTime&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">long&lt;/span> end&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">do&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> end &lt;span style="color:#f92672">=&lt;/span> System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">nanoTime&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">while&lt;/span> &lt;span style="color:#f92672">(&lt;/span>start &lt;span style="color:#f92672">+&lt;/span> interval &lt;span style="color:#f92672">&amp;gt;=&lt;/span> end&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢çš„ä¾‹å­å­˜åœ¨å¯è§æ€§é—®é¢˜ï¼&lt;/p>
&lt;h2 id="jmmçš„å†…å­˜å¯è§æ€§ä¿è¯">JMMçš„å†…å­˜å¯è§æ€§ä¿è¯&lt;/h2>
&lt;blockquote>
&lt;p>ä»€ä¹ˆæ—¶å€™åˆ·ä¸»å†…å­˜ï¼Œçº¿ç¨‹æ‰§è¡Œç»“æŸåˆ·å›ä¸»å†…å­˜å—ï¼Ÿè¿˜æ˜¯ä¸€æ—¦æ›´æ–°å®Œä¹‹åå°±ç«‹é©¬åˆ·ä¸»å†…å­˜ï¼Ÿæœ¬åœ°å†…å­˜ä»€ä¹ˆæ—¶å€™ä¼šæ²¡æœ‰ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>æŒ‰ç¨‹åºç±»å‹ï¼ŒJavaç¨‹åºçš„å†…å­˜å¯è§æ€§ä¿è¯å¯ä»¥åˆ†ä¸ºä¸‹åˆ—3ç±»ï¼š&lt;/p>
&lt;ul>
&lt;li>å•çº¿ç¨‹ç¨‹åºã€‚å•çº¿ç¨‹ç¨‹åºä¸ä¼šå‡ºç°å†…å­˜å¯è§æ€§é—®é¢˜ã€‚ç¼–è¯‘å™¨ã€runtimeå’Œå¤„ç†å™¨ä¼šå…±åŒç¡®ä¿å•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœç›¸åŒã€‚&lt;/li>
&lt;li>æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºã€‚æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œå°†å…·æœ‰é¡ºåºä¸€è‡´æ€§ï¼ˆç¨‹åºçš„æ‰§è¡Œç»“æœä¸è¯¥ç¨‹åºåœ¨é¡ºåºä¸€è‡´æ€§å†…å­˜æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœç›¸åŒï¼‰ã€‚è¿™æ˜¯JMMå…³æ³¨çš„é‡ç‚¹ï¼ŒJMMé€šè¿‡&lt;code>é™åˆ¶ç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„é‡æ’åº&lt;/code>æ¥ä¸ºç¨‹åºå‘˜æä¾›å†…å­˜å¯è§æ€§ä¿è¯ã€‚&lt;/li>
&lt;li>æœªåŒæ­¥/æœªæ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºã€‚JMMä¸ºå®ƒä»¬æä¾›äº†æœ€å°å®‰å…¨æ€§ä¿éšœï¼šçº¿ç¨‹æ‰§è¡Œæ—¶è¯»å–åˆ°çš„å€¼ï¼Œè¦ä¹ˆæ˜¯ä¹‹å‰æŸä¸ªçº¿ç¨‹å†™å…¥çš„å€¼ï¼Œè¦ä¹ˆæ˜¯é»˜è®¤å€¼ã€‚
&lt;ul>
&lt;li>æœªåŒæ­¥ç¨‹åºåœ¨JMMä¸­æ‰§è¡Œæ—¶ï¼Œæ•´ä½“ä¸Šæ˜¯æ— åºçš„ï¼Œå…¶æ‰§è¡Œç»“æœæ— æ³•é¢„çŸ¥ã€‚&lt;/li>
&lt;li>JMMä¸ä¿è¯&lt;u>æœªåŒæ­¥ç¨‹åºçš„æ‰§è¡Œç»“æœ&lt;/u>ä¸è¯¥ç¨‹åº&lt;u>åœ¨é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­çš„æ‰§è¡Œç»“æœ&lt;/u>ä¸€è‡´ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="æœªåŒæ­¥ç¨‹åºåœ¨ä¸¤ä¸ªæ¨¡å‹ä¸­çš„æ‰§è¡Œç‰¹æ€§æœ‰å¦‚ä¸‹å‡ ä¸ªå·®å¼‚">æœªåŒæ­¥ç¨‹åºåœ¨ä¸¤ä¸ªæ¨¡å‹ä¸­çš„æ‰§è¡Œç‰¹æ€§æœ‰å¦‚ä¸‹å‡ ä¸ªå·®å¼‚&lt;/h3>
&lt;ol>
&lt;li>&lt;code>é¡ºåºä¸€è‡´æ€§æ¨¡å‹&lt;/code>ä¿è¯å•çº¿ç¨‹å†…çš„æ“ä½œä¼šæŒ‰ç¨‹åºçš„é¡ºåºæ‰§è¡Œï¼Œè€ŒJMMä¸ä¿è¯å•çº¿ç¨‹å†…çš„æ“ä½œä¼šæŒ‰ç¨‹åºçš„é¡ºåºæ‰§è¡Œï¼Œæ¯”å¦‚æ­£ç¡®åŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºåœ¨ä¸´ç•ŒåŒºå†…çš„é‡æ’åºã€‚&lt;/li>
&lt;li>é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¿è¯æ‰€æœ‰çº¿ç¨‹åªèƒ½çœ‹åˆ°ä¸€è‡´çš„æ“ä½œæ‰§è¡Œé¡ºåºï¼Œè€ŒJMMä¸ä¿è¯æ‰€æœ‰çº¿ç¨‹èƒ½çœ‹åˆ°ä¸€è‡´çš„æ“ä½œæ‰§è¡Œé¡ºåºã€‚&lt;/li>
&lt;li>é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¿è¯å¯¹æ‰€æœ‰çš„å†…å­˜è¯»/å†™æ“ä½œéƒ½å…·æœ‰åŸå­æ€§ï¼Œè€ŒJMMä¸ä¿è¯å¯¹64ä½çš„longå‹å’Œdoubleå‹å˜é‡çš„å†™æ“ä½œå…·æœ‰åŸå­æ€§ï¼ˆ32ä½å¤„ç†å™¨ï¼‰ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="volatile">volatile&lt;/h3>
&lt;h4 id="volatileçš„ç‰¹æ€§">volatileçš„ç‰¹æ€§&lt;/h4>
&lt;ul>
&lt;li>å¯è§æ€§ï¼šå¯¹ä¸€ä¸ªvolatileå˜é‡çš„è¯»ï¼Œæ€»æ˜¯èƒ½çœ‹åˆ°ï¼ˆä»»æ„çº¿ç¨‹ï¼‰å¯¹è¿™ä¸ªvolatileå˜é‡æœ€åçš„å†™å…¥ã€‚&lt;/li>
&lt;li>åŸå­æ€§ï¼šå¯¹ä»»æ„å•ä¸ªvolatileå˜é‡çš„è¯»/å†™å…·æœ‰åŸå­æ€§ï¼Œä½†ç±»ä¼¼äº&lt;code>volatile++&lt;/code>è¿™ç§å¤åˆæ“ä½œä¸å…·æœ‰åŸå­æ€§ï¼ˆ&lt;u>åŸºäºè¿™ç‚¹ï¼Œæˆ‘ä»¬é€šè¿‡ä¼šè®¤ä¸ºvolatileä¸å…·å¤‡åŸå­æ€§&lt;/u>ï¼‰ã€‚volatileä»…ä»…ä¿è¯å¯¹å•ä¸ªvolatileå˜é‡çš„è¯»/å†™å…·æœ‰åŸå­æ€§ï¼Œè€Œé”çš„äº’æ–¥æ‰§è¡Œçš„ç‰¹æ€§å¯ä»¥ç¡®ä¿å¯¹æ•´ä¸ªä¸´ç•ŒåŒºä»£ç çš„æ‰§è¡Œå…·æœ‰åŸå­æ€§ã€‚&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>64ä½çš„longå‹å’Œdoubleå‹å˜é‡ï¼Œåªè¦å®ƒæ˜¯volatileå˜é‡ï¼Œå¯¹è¯¥å˜é‡çš„è¯»/å†™å°±å…·æœ‰åŸå­æ€§ã€‚&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>æœ‰åºæ€§ï¼šå¯¹volatileä¿®é¥°çš„å˜é‡çš„è¯»å†™æ“ä½œ**&lt;u>å‰ååŠ ä¸Šå„ç§ç‰¹å®šçš„å†…å­˜å±éšœæ¥ç¦æ­¢æŒ‡ä»¤é‡æ’åº&lt;/u>**æ¥ä¿éšœæœ‰åºæ€§ã€‚&lt;/li>
&lt;/ul>
&lt;p>åœ¨&lt;code>JSR-133&lt;/code>ä¹‹å‰çš„æ—§Javaå†…å­˜æ¨¡å‹ä¸­ï¼Œè™½ç„¶ä¸å…è®¸volatileå˜é‡ä¹‹é—´é‡æ’åºï¼Œä½†æ—§çš„Javaå†…å­˜æ¨¡å‹å…è®¸volatileå˜é‡ä¸æ™®é€šå˜é‡é‡æ’åºã€‚ä¸ºäº†æä¾›ä¸€ç§æ¯”é”æ›´è½»é‡çº§çš„çº¿ç¨‹ä¹‹é—´é€šä¿¡çš„æœºåˆ¶ï¼ŒJSR-133ä¸“å®¶ç»„å†³å®šå¢å¼ºvolatileçš„å†…å­˜è¯­ä¹‰ï¼š&lt;/p>
&lt;p>&lt;strong>ä¸¥æ ¼é™åˆ¶ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯¹volatileå˜é‡ä¸æ™®é€šå˜é‡çš„é‡æ’åºï¼Œç¡®ä¿volatileçš„å†™-è¯»å’Œé”çš„é‡Šæ”¾-è·å–å…·æœ‰ç›¸åŒçš„å†…å­˜è¯­ä¹‰ã€‚&lt;/strong>&lt;/p>
&lt;h4 id="volatileå†™-è¯»çš„å†…å­˜è¯­ä¹‰">volatileå†™-è¯»çš„å†…å­˜è¯­ä¹‰&lt;/h4>
&lt;ul>
&lt;li>å½“å†™ä¸€ä¸ªvolatileå˜é‡æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ä¸­çš„å…±äº«å˜é‡å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ã€‚&lt;/li>
&lt;li>å½“è¯»ä¸€ä¸ªvolatileå˜é‡æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ç½®ä¸ºæ— æ•ˆï¼Œçº¿ç¨‹æ¥ä¸‹æ¥å°†ä»ä¸»å†…å­˜ä¸­è¯»å–å…±äº«å˜é‡ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="volatileå¯è§æ€§å®ç°åŸç†">volatileå¯è§æ€§å®ç°åŸç†&lt;/h4>
&lt;h5 id="jmmå†…å­˜äº¤äº’å±‚é¢å®ç°">JMMå†…å­˜äº¤äº’å±‚é¢å®ç°&lt;/h5>
&lt;p>volatileä¿®é¥°çš„å˜é‡çš„&lt;code>readã€loadã€use&lt;/code>æ“ä½œå’Œ&lt;code>assignã€storeã€write&lt;/code>å¿…é¡»æ˜¯è¿ç»­çš„ï¼Œå³ä¿®æ”¹åå¿…é¡»ç«‹å³åŒæ­¥å›ä¸»å†…å­˜ï¼Œä½¿ç”¨æ—¶å¿…é¡»ä»ä¸»å†…å­˜åˆ·æ–°ï¼Œç”±æ­¤ä¿è¯volatileå˜é‡æ“ä½œå¯¹å¤šçº¿ç¨‹çš„å¯è§æ€§ã€‚&lt;/p>
&lt;h5 id="ç¡¬ä»¶å±‚é¢å®ç°">ç¡¬ä»¶å±‚é¢å®ç°&lt;/h5>
&lt;p>é€šè¿‡&lt;code>lockå‰ç¼€æŒ‡ä»¤&lt;/code>ï¼Œä¼šé”å®šå˜é‡ç¼“å­˜è¡ŒåŒºåŸŸå¹¶å†™å›ä¸»å†…å­˜ï¼Œè¿™ä¸ªæ“ä½œç§°ä¸ºâ€œç¼“å­˜é”å®šâ€ï¼Œç¼“å­˜ä¸€è‡´æ€§æœºåˆ¶ä¼šé˜»æ­¢åŒæ—¶ä¿®æ”¹è¢«ä¸¤ä¸ªä»¥ä¸Šå¤„ç†å™¨ç¼“å­˜çš„å†…å­˜åŒºåŸŸæ•°æ®ã€‚&lt;u>ä¸€ä¸ªå¤„ç†å™¨çš„ç¼“å­˜å›å†™åˆ°å†…å­˜ä¼šå¯¼è‡´å…¶ä»–å¤„ç†å™¨çš„ç¼“å­˜æ— æ•ˆã€‚&lt;/u>&lt;/p>
&lt;h5 id="volatileåœ¨hotspotçš„å®ç°">volatileåœ¨hotspotçš„å®ç°&lt;/h5>
&lt;h6 id="å­—èŠ‚ç è§£é‡Šå™¨å®ç°">å­—èŠ‚ç è§£é‡Šå™¨å®ç°&lt;/h6>
&lt;p>JVMä¸­çš„å­—èŠ‚ç è§£é‡Šå™¨(bytecodeInterpreter)ï¼Œç”¨C++å®ç°äº†JVMæŒ‡ä»¤ã€‚&lt;/p>
&lt;p>&lt;code>src/hotspot/share/interpreter/zero/bytecodeInterpreter.cpp&lt;/code>æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> (cache&lt;span style="color:#f92672">-&amp;gt;&lt;/span>is_volatile()) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">switch&lt;/span> (tos_type) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> ztos:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> obj&lt;span style="color:#f92672">-&amp;gt;&lt;/span>release_byte_field_put(field_offset, (STACK_INT(&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>) &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>)); &lt;span style="color:#75715e">// only store LSB
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> btos:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> obj&lt;span style="color:#f92672">-&amp;gt;&lt;/span>release_byte_field_put(field_offset, STACK_INT(&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> ctos:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> obj&lt;span style="color:#f92672">-&amp;gt;&lt;/span>release_char_field_put(field_offset, STACK_INT(&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> stos:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> obj&lt;span style="color:#f92672">-&amp;gt;&lt;/span>release_short_field_put(field_offset, STACK_INT(&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> itos:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> obj&lt;span style="color:#f92672">-&amp;gt;&lt;/span>release_int_field_put(field_offset, STACK_INT(&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> ftos:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> obj&lt;span style="color:#f92672">-&amp;gt;&lt;/span>release_float_field_put(field_offset, STACK_FLOAT(&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> ltos:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> obj&lt;span style="color:#f92672">-&amp;gt;&lt;/span>release_long_field_put(field_offset, STACK_LONG(&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> dtos:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> obj&lt;span style="color:#f92672">-&amp;gt;&lt;/span>release_double_field_put(field_offset, STACK_DOUBLE(&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> atos: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> oop val &lt;span style="color:#f92672">=&lt;/span> STACK_OBJECT(&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> VERIFY_OOP(val);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> obj&lt;span style="color:#f92672">-&amp;gt;&lt;/span>release_obj_field_put(field_offset, val);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">default&lt;/span>&lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ShouldNotReachHere();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OrderAccess&lt;span style="color:#f92672">::&lt;/span>storeload();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h6 id="æ¨¡æ¿è§£é‡Šå™¨å®ç°">æ¨¡æ¿è§£é‡Šå™¨å®ç°&lt;/h6>
&lt;p>æ¨¡æ¿è§£é‡Šå™¨(&lt;code>templateInterpreter&lt;/code>)ï¼Œå…¶å¯¹æ¯ä¸ªæŒ‡ä»¤éƒ½å†™äº†ä¸€æ®µå¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼Œå¯åŠ¨æ—¶å°†æ¯ä¸ªæŒ‡ä»¤ä¸å¯¹åº”æ±‡ç¼–ä»£ç å…¥å£ç»‘å®šï¼Œå¯ä»¥è¯´æ˜¯æ•ˆç‡åšåˆ°äº†æè‡´ã€‚&lt;/p>
&lt;p>&lt;code>src/hotspot/os_cpu&lt;/code> åŒ…å«äº†ä¸åŒcpuçš„æ–¹æ³•å®ç°&lt;/p>
&lt;p>&lt;code>src/hotspot/cpu/x86/templateTable_x86.cpp&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">void&lt;/span> TemplateTable&lt;span style="color:#f92672">::&lt;/span>volatile_barrier(Assembler&lt;span style="color:#f92672">::&lt;/span>Membar_mask_bits
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> order_constraint) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Helper function to insert a is-volatile test and memory barrier
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> (os&lt;span style="color:#f92672">::&lt;/span>is_MP()) { &lt;span style="color:#75715e">// Not needed on single CPU
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> __ &lt;span style="color:#a6e22e">membar&lt;/span>(order_constraint);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// è´Ÿè´£æ‰§è¡Œputfieldæˆ–putstaticæŒ‡ä»¤
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">void&lt;/span> TemplateTable&lt;span style="color:#f92672">::&lt;/span>putfield_or_static(&lt;span style="color:#66d9ef">int&lt;/span> byte_no, &lt;span style="color:#66d9ef">bool&lt;/span> is_static, RewriteControl rc) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// Check for volatile store
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> __ &lt;span style="color:#a6e22e">testl&lt;/span>(rdx, rdx);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> __ &lt;span style="color:#a6e22e">jcc&lt;/span>(Assembler&lt;span style="color:#f92672">::&lt;/span>zero, notVolatile);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> putfield_or_static_helper(byte_no, is_static, rc, obj, off, flags);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> volatile_barrier(Assembler&lt;span style="color:#f92672">::&lt;/span>Membar_mask_bits(Assembler&lt;span style="color:#f92672">::&lt;/span>StoreLoad &lt;span style="color:#f92672">|&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Assembler&lt;span style="color:#f92672">::&lt;/span>StoreStore));
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> __ &lt;span style="color:#a6e22e">jmp&lt;/span>(Done);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> __ &lt;span style="color:#a6e22e">bind&lt;/span>(notVolatile);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> putfield_or_static_helper(byte_no, is_static, rc, obj, off, flags);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> __ &lt;span style="color:#a6e22e">bind&lt;/span>(Done);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>src/hotspot/cpu/x86/assembler_x86.hpp&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// Serializes memory and blows flags
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">membar&lt;/span>(Membar_mask_bits order_constraint) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// We only have to handle StoreLoad
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// x86å¹³å°åªéœ€è¦å¤„ç†StoreLoad
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">if&lt;/span> (order_constraint &lt;span style="color:#f92672">&amp;amp;&lt;/span> StoreLoad) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> offset &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">-&lt;/span>VM_Version&lt;span style="color:#f92672">::&lt;/span>L1_line_size();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> (offset &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">128&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> offset &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">128&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ä¸‹é¢è¿™ä¸¤å¥æ’å…¥äº†ä¸€æ¡lockå‰ç¼€æŒ‡ä»¤: lock addl $0, $0(%rsp)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> lock(); &lt;span style="color:#75715e">// lockå‰ç¼€æŒ‡ä»¤
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> addl(Address(rsp, offset), &lt;span style="color:#ae81ff">0&lt;/span>); &lt;span style="color:#75715e">// addl $0, $0(%rsp)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨linuxç³»ç»Ÿx86ä¸­çš„å®ç°&lt;/p>
&lt;p>x86å¤„ç†å™¨ä¸­åˆ©ç”¨lockå®ç°ç±»ä¼¼å†…å­˜å±éšœçš„æ•ˆæœã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-cpp" data-lang="cpp">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> OrderAccess&lt;span style="color:#f92672">::&lt;/span>loadload() { compiler_barrier(); }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> OrderAccess&lt;span style="color:#f92672">::&lt;/span>storestore() { compiler_barrier(); }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> OrderAccess&lt;span style="color:#f92672">::&lt;/span>loadstore() { compiler_barrier(); }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> OrderAccess&lt;span style="color:#f92672">::&lt;/span>storeload() { fence(); }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> OrderAccess&lt;span style="color:#f92672">::&lt;/span>acquire() { compiler_barrier(); }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> OrderAccess&lt;span style="color:#f92672">::&lt;/span>release() { compiler_barrier(); }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">inline&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> OrderAccess&lt;span style="color:#f92672">::&lt;/span>fence() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// always use locked addl since mfence is sometimes expensive
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#75715e">#ifdef AMD64
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> __asm__ &lt;span style="color:#66d9ef">volatile&lt;/span> (&lt;span style="color:#e6db74">&amp;#34;lock; addl $0,0(%%rsp)&amp;#34;&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;cc&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;memory&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#else
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> __asm__ &lt;span style="color:#66d9ef">volatile&lt;/span> (&lt;span style="color:#e6db74">&amp;#34;lock; addl $0,0(%%esp)&amp;#34;&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#e6db74">&amp;#34;cc&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;memory&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#endif
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> compiler_barrier();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="lockå‰ç¼€æŒ‡ä»¤çš„ä½œç”¨">lockå‰ç¼€æŒ‡ä»¤çš„ä½œç”¨&lt;/h3>
&lt;ol>
&lt;li>ç¡®ä¿åç»­æŒ‡ä»¤æ‰§è¡Œçš„åŸå­æ€§ã€‚åœ¨PentiumåŠä¹‹å‰çš„å¤„ç†å™¨ä¸­ï¼Œå¸¦æœ‰lockå‰ç¼€çš„æŒ‡ä»¤åœ¨æ‰§è¡ŒæœŸé—´ä¼šé”ä½æ€»çº¿ï¼Œä½¿å¾—å…¶å®ƒå¤„ç†å™¨æš‚æ—¶æ— æ³•é€šè¿‡æ€»çº¿è®¿é—®å†…å­˜ï¼Œå¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªå¼€é”€å¾ˆå¤§ã€‚åœ¨æ–°çš„å¤„ç†å™¨ä¸­ï¼ŒIntelä½¿ç”¨ç¼“å­˜é”å®šæ¥ä¿è¯æŒ‡ä»¤æ‰§è¡Œçš„åŸå­æ€§ï¼Œç¼“å­˜é”å®šå°†å¤§å¤§é™ä½lockå‰ç¼€æŒ‡ä»¤çš„æ‰§è¡Œå¼€é”€ã€‚&lt;/li>
&lt;li>LOCKå‰ç¼€æŒ‡ä»¤å…·æœ‰ç±»ä¼¼äºå†…å­˜å±éšœçš„åŠŸèƒ½ï¼Œç¦æ­¢è¯¥æŒ‡ä»¤ä¸å‰é¢å’Œåé¢çš„è¯»å†™æŒ‡ä»¤é‡æ’åºã€‚&lt;/li>
&lt;li>LOCKå‰ç¼€æŒ‡ä»¤ä¼šç­‰å¾…å®ƒä¹‹å‰æ‰€æœ‰çš„æŒ‡ä»¤å®Œæˆã€å¹¶ä¸”æ‰€æœ‰ç¼“å†²çš„å†™æ“ä½œå†™å›å†…å­˜(ä¹Ÿå°±æ˜¯å°†store bufferä¸­çš„å†…å®¹å†™å…¥å†…å­˜)ä¹‹åæ‰å¼€å§‹æ‰§è¡Œï¼Œå¹¶ä¸”æ ¹æ®ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œåˆ·æ–°store bufferçš„æ“ä½œä¼šå¯¼è‡´å…¶ä»–cacheä¸­çš„å‰¯æœ¬å¤±æ•ˆã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="æ±‡ç¼–å±‚é¢volatileçš„å®ç°">æ±‡ç¼–å±‚é¢volatileçš„å®ç°&lt;/h3>
&lt;p>æ·»åŠ ä¸‹é¢çš„jvmå‚æ•°æŸ¥çœ‹ä¹‹å‰å¯è§æ€§Demoçš„æ±‡ç¼–æŒ‡ä»¤&lt;/p>
&lt;p>&lt;code>-XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly -Xcomp&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://img.hinathan.online/2025/07/343842034.png" alt="343842034">&lt;/p>
&lt;p>éªŒè¯äº†å¯è§æ€§ä½¿ç”¨äº†&lt;strong>lockå‰ç¼€æŒ‡ä»¤&lt;/strong>&lt;/p>
&lt;h3 id="ä»ç¡¬ä»¶å±‚é¢åˆ†ælockå‰ç¼€æŒ‡ä»¤">ä»ç¡¬ä»¶å±‚é¢åˆ†æLockå‰ç¼€æŒ‡ä»¤&lt;/h3>
&lt;p>ã€Š64-ia-32-architectures-software-developer-vol-3a-part-1-manual.pdfã€‹ä¸­æœ‰å¦‚ä¸‹æè¿°ï¼š&lt;/p>
&lt;blockquote>
&lt;p>The 32-bit IA-32 processors support locked atomic operations on locations in system memory. These operations are typically used to manage shared data structures (such as semaphores, segment descriptors, system segments, or page tables) in which two or more processors may try simultaneously to modify the same field or flag. The processor uses three interdependent mechanisms for carrying out locked atomic operations:&lt;/p>
&lt;p>â€¢ Guaranteed atomic operations&lt;/p>
&lt;p>â€¢ Bus locking, using the LOCK# signal and the LOCK instruction prefix&lt;/p>
&lt;p>â€¢ Cache coherency protocols that ensure that atomic operations can be carried out on cached data structures (cache lock); this mechanism is present in the Pentium 4, Intel Xeon, and P6 family processors&lt;/p>
&lt;/blockquote>
&lt;p>32ä½çš„IA-32å¤„ç†å™¨æ”¯æŒå¯¹ç³»ç»Ÿå†…å­˜ä¸­çš„ä½ç½®è¿›è¡Œé”å®šçš„åŸå­æ“ä½œã€‚è¿™äº›æ“ä½œé€šå¸¸ç”¨äºç®¡ç†å…±äº«çš„æ•°æ®ç»“æ„(å¦‚ä¿¡å·é‡ã€æ®µæè¿°ç¬¦ã€ç³»ç»Ÿæ®µæˆ–é¡µè¡¨)ï¼Œåœ¨è¿™äº›ç»“æ„ä¸­ï¼Œä¸¤ä¸ªæˆ–å¤šä¸ªå¤„ç†å™¨å¯èƒ½åŒæ—¶è¯•å›¾ä¿®æ”¹ç›¸åŒçš„å­—æ®µæˆ–æ ‡å¿—ã€‚&lt;/p>
&lt;p>å¤„ç†å™¨ä½¿ç”¨ä¸‰ç§ç›¸äº’ä¾èµ–çš„æœºåˆ¶æ¥æ‰§è¡Œé”å®šçš„åŸå­æ“ä½œ:&lt;/p>
&lt;ul>
&lt;li>æœ‰ä¿è¯çš„åŸå­æ“ä½œ&lt;/li>
&lt;li>æ€»çº¿é”å®šï¼Œä½¿ç”¨LOCK#ä¿¡å·å’ŒLOCKæŒ‡ä»¤å‰ç¼€&lt;/li>
&lt;li>ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œç¡®ä¿åŸå­æ“ä½œå¯ä»¥åœ¨ç¼“å­˜çš„æ•°æ®ç»“æ„ä¸Šæ‰§è¡Œ(ç¼“å­˜é”);è¿™ç§æœºåˆ¶å‡ºç°åœ¨Pentium 4ã€Intel Xeonå’ŒP6ç³»åˆ—å¤„ç†å™¨ä¸­&lt;/li>
&lt;/ul></description></item><item><title>Javaå¹¶å‘ç¼–ç¨‹ï¼ˆäºŒï¼‰JMM&amp;å¹¶å‘ä¸‰å¤§ç‰¹æ€§-åŸå­æ€§</title><link>https://www.hinathan.online/blog/02-jmm_and_atomicity/</link><pubDate>Fri, 10 Jan 2020 21:20:16 +0800</pubDate><guid>https://www.hinathan.online/blog/02-jmm_and_atomicity/</guid><description>&lt;h2 id="ä»ä¸‰ä¸ªè§’åº¦åˆ†æ">ä»ä¸‰ä¸ªè§’åº¦åˆ†æ&lt;/h2>
&lt;ol>
&lt;li>Javaå±‚é¢&lt;/li>
&lt;li>Jvmå±‚é¢&lt;/li>
&lt;li>ç¡¬ä»¶å±‚é¢&lt;/li>
&lt;/ol>
&lt;p>è¿™éƒ¨åˆ†ç†è§£å¹¶å‘çš„ä¸‰å¤§ç‰¹æ€§ï¼ŒJMMå·¥ä½œå†…å­˜å’Œä¸»å†…å­˜å…³ç³»ï¼ŒçŸ¥é“å¤šçº¿ç¨‹ä¹‹é—´å¦‚ä½•é€šä¿¡çš„ï¼ŒæŒæ¡&lt;code>volatile&lt;/code>èƒ½ä¿è¯å¯è§æ€§å’Œæœ‰åºæ€§ï¼Œ&lt;code>CAS&lt;/code>å°±å¯ä»¥äº†ï¼Œåç»­JVMå±‚é¢å’Œç¡¬ä»¶å±‚é¢çš„åˆ†æï¼ˆå¯ä»¥çœ‹å®ŒJavaé”æœºåˆ¶ï¼Œå¸¸ç”¨çš„å¹¶å‘å·¥å…·ç±»ï¼Œå¹¶å‘å®¹å™¨ä¹‹åå†æ¥çœ‹JMMè¿™å—ã€‚ï¼‰&lt;/p>
&lt;h2 id="å¹¶å‘ä¸‰å¤§ç‰¹æ€§">å¹¶å‘ä¸‰å¤§ç‰¹æ€§&lt;/h2>
&lt;p>å¹¶å‘ç¼–ç¨‹Bugçš„æºå¤´ï¼šå¯è§æ€§ã€åŸå­æ€§å’Œæœ‰åºæ€§é—®é¢˜&lt;/p>
&lt;h3 id="åŸå­æ€§">åŸå­æ€§&lt;/h3>
&lt;p>ä¸€ä¸ªæˆ–å¤šä¸ªæ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œä¸”åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸è¢«ä»»ä½•å› ç´ æ‰“æ–­ï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œã€‚åœ¨ Java ä¸­ï¼Œ&lt;u>å¯¹åŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡çš„è¯»å–å’Œèµ‹å€¼æ“ä½œæ˜¯åŸå­æ€§æ“ä½œï¼ˆ64ä½å¤„ç†å™¨ï¼‰ã€‚&lt;/u>ä¸é‡‡å–ä»»ä½•çš„åŸå­æ€§ä¿éšœæªæ–½çš„è‡ªå¢æ“ä½œå¹¶ä¸æ˜¯åŸå­æ€§çš„ã€‚&lt;/p>
&lt;h4 id="å¦‚ä½•ä¿è¯åŸå­æ€§">å¦‚ä½•ä¿è¯åŸå­æ€§&lt;/h4>
&lt;ul>
&lt;li>é€šè¿‡&lt;code>synchronized&lt;/code>å…³é”®å­—ä¿è¯åŸå­æ€§ã€‚&lt;/li>
&lt;li>é€šè¿‡&lt;code>Lock&lt;/code>ä¿è¯åŸå­æ€§ã€‚&lt;/li>
&lt;li>é€šè¿‡&lt;code>CAS&lt;/code>ä¿è¯åŸå­æ€§ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="åœ¨-32-ä½çš„æœºå™¨ä¸Šå¯¹-long-å‹å˜é‡è¿›è¡ŒåŠ å‡æ“ä½œæ˜¯å¦å­˜åœ¨å¹¶å‘éšæ‚£">åœ¨ 32 ä½çš„æœºå™¨ä¸Šå¯¹ long å‹å˜é‡è¿›è¡ŒåŠ å‡æ“ä½œæ˜¯å¦å­˜åœ¨å¹¶å‘éšæ‚£ï¼Ÿ&lt;/h4>
&lt;p>æ˜¯çš„ï¼åœ¨ 32 ä½æœºå™¨ä¸Šå¯¹ &lt;strong>long å‹å˜é‡&lt;/strong> è¿›è¡Œç®€å•çš„åŠ å‡æ“ä½œï¼ˆä¾‹å¦‚ &lt;code>count++&lt;/code> æˆ– &lt;code>count += 1&lt;/code>ï¼‰å­˜åœ¨æ˜æ˜¾çš„å¹¶å‘éšæ‚£ã€‚&lt;/p>
&lt;blockquote>
&lt;p>For the purposes of the Java programming language memory model, a single write to a non-volatile &lt;code>long&lt;/code> or &lt;code>double&lt;/code> value is treated as two separate writes: one to each 32-bit half. This can result in a situation where a thread sees the first 32 bits of a 64-bit value from one write, and the second 32 bits from another write.&lt;/p>
&lt;p>Writes and reads of volatile &lt;code>long&lt;/code> and &lt;code>double&lt;/code> values are always atomic.&lt;/p>
&lt;p>Writes to and reads of references are always atomic, regardless of whether they are implemented as 32-bit or 64-bit values.&lt;/p>
&lt;p>Some implementations may find it convenient to divide a single write action on a 64-bit &lt;code>long&lt;/code> or &lt;code>double&lt;/code> value into two write actions on adjacent 32-bit values. For efficiency&amp;rsquo;s sake, this behavior is implementation-specific; an implementation of the Java Virtual Machine is free to perform writes to &lt;code>long&lt;/code> and &lt;code>double&lt;/code> values atomically or in two parts.&lt;/p>
&lt;p>Implementations of the Java Virtual Machine are encouraged to avoid splitting 64-bit values where possible. Programmers are encouraged to declare shared 64-bit values as &lt;code>volatile&lt;/code> or synchronize their programs correctly to avoid possible complications.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>å¯¹äº Java ç¼–ç¨‹è¯­è¨€çš„å†…å­˜æ¨¡å‹è€Œè¨€ï¼Œå¯¹ä¸€ä¸ªé volatile çš„ long æˆ– double å€¼çš„å•æ¬¡å†™å…¥ä¼šè¢«è§†ä¸ºä¸¤æ¬¡å•ç‹¬çš„å†™å…¥æ“ä½œï¼šåˆ†åˆ«å¯¹è¯¥å€¼çš„é«˜32ä½å’Œä½32ä½è¿›è¡Œå†™å…¥ã€‚è¿™å¯èƒ½å¯¼è‡´æŸä¸ªçº¿ç¨‹çœ‹åˆ°çš„64ä½æ•°å€¼ä¸­ï¼Œå‰32ä½æ¥è‡ªæŸæ¬¡å†™æ“ä½œï¼Œè€Œå32ä½å´æ¥è‡ªå¦ä¸€æ¬¡å†™æ“ä½œã€‚&lt;/p>
&lt;p>å¯¹ volatile ä¿®é¥°çš„ long å’Œ double å€¼çš„è¯»å†™æ“ä½œå§‹ç»ˆæ˜¯åŸå­æ€§çš„ã€‚&lt;/p>
&lt;p>å¯¹å¼•ç”¨ç±»å‹ï¼ˆreferencesï¼‰çš„è¯»å†™æ“ä½œå§‹ç»ˆæ˜¯åŸå­æ€§çš„ï¼Œæ— è®ºå®ƒä»¬å…·ä½“æ˜¯ä»¥32ä½è¿˜æ˜¯64ä½çš„æ–¹å¼å®ç°ã€‚&lt;/p>
&lt;p>æŸäº› Java è™šæ‹Ÿæœºçš„å®ç°å‡ºäºä¾¿åˆ©ï¼Œå¯èƒ½ä¼šå°†å¯¹64ä½çš„ long æˆ– double å€¼çš„ä¸€æ¬¡å†™æ“ä½œæ‹†åˆ†æˆå¯¹ä¸¤ä¸ªè¿ç»­32ä½æ•°å€¼çš„ä¸¤æ¬¡å†™æ“ä½œã€‚ä¸ºäº†æ•ˆç‡èµ·è§ï¼Œè¿™ç§è¡Œä¸ºæ˜¯ä¾èµ–äºå…·ä½“å®ç°çš„ï¼›Java è™šæ‹Ÿæœºçš„å®ç°å¯ä»¥è‡ªç”±é€‰æ‹©å°†å¯¹ long å’Œ double çš„å†™æ“ä½œä½œä¸ºåŸå­æ“ä½œè¿›è¡Œï¼Œæˆ–åˆ†ä¸ºä¸¤éƒ¨åˆ†è¿›è¡Œã€‚&lt;/p>
&lt;p>å»ºè®® Java è™šæ‹Ÿæœºçš„å®ç°å°½é‡é¿å…å¯¹64ä½æ•°å€¼çš„å†™å…¥è¿›è¡Œæ‹†åˆ†ã€‚åŒæ—¶å»ºè®®ç¨‹åºå‘˜åœ¨å£°æ˜å…±äº«çš„64ä½å˜é‡æ—¶ä½¿ç”¨ volatile ä¿®é¥°ï¼Œæˆ–æ­£ç¡®åœ°å¯¹ç¨‹åºè¿›è¡ŒåŒæ­¥ï¼Œä»¥é¿å…æ½œåœ¨çš„é—®é¢˜ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="javaå†…å­˜æ¨¡å‹jmm">Javaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰&lt;/h2>
&lt;h3 id="jmmå®šä¹‰">JMMå®šä¹‰&lt;/h3>
&lt;p>Javaè™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰äº†Javaå†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼ŒJMMï¼‰ï¼Œç”¨äºå±è”½æ‰å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥å®ç°è®©Javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å¹¶å‘æ•ˆæœã€‚&lt;/p>
&lt;p>JMMè§„èŒƒäº†Javaè™šæ‹Ÿæœºä¸è®¡ç®—æœºå†…å­˜æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼šè§„å®šäº†ä¸€ä¸ªçº¿ç¨‹&lt;code>å¦‚ä½•&lt;/code>å’Œ&lt;code>ä½•æ—¶&lt;/code>å¯ä»¥çœ‹åˆ°ç”±å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡åçš„å…±äº«å˜é‡çš„å€¼ï¼Œä»¥åŠåœ¨å¿…é¡»æ—¶&lt;code>å¦‚ä½•åŒæ­¥&lt;/code>çš„è®¿é—®å…±äº«å˜é‡ã€‚JMMæè¿°çš„æ˜¯ä¸€ç§æŠ½è±¡çš„æ¦‚å¿µï¼Œä¸€ç»„è§„åˆ™ï¼Œé€šè¿‡è¿™ç»„è§„åˆ™æ§åˆ¶ç¨‹åºä¸­å„ä¸ªå˜é‡åœ¨å…±äº«æ•°æ®åŒºåŸŸå’Œç§æœ‰æ•°æ®åŒºåŸŸçš„è®¿é—®æ–¹å¼ï¼Œ&lt;u>JMMæ˜¯å›´ç»•åŸå­æ€§ã€æœ‰åºæ€§ã€å¯è§æ€§å±•å¼€çš„&lt;/u>ã€‚&lt;/p>
&lt;p>&lt;img src="https://img.hinathan.online/2025/07/28523.png" alt="">&lt;/p>
&lt;h3 id="jmmä¸ç¡¬ä»¶å†…å­˜æ¶æ„çš„å…³ç³»">JMMä¸ç¡¬ä»¶å†…å­˜æ¶æ„çš„å…³ç³»&lt;/h3>
&lt;p>Javaå†…å­˜æ¨¡å‹ä¸ç¡¬ä»¶å†…å­˜æ¶æ„ä¹‹é—´å­˜åœ¨å·®å¼‚ã€‚ç¡¬ä»¶å†…å­˜æ¶æ„æ²¡æœ‰åŒºåˆ†çº¿ç¨‹æ ˆå’Œå †ã€‚å¯¹äºç¡¬ä»¶ï¼Œæ‰€æœ‰çš„çº¿ç¨‹æ ˆå’Œå †éƒ½åˆ†å¸ƒåœ¨ä¸»å†…å­˜ä¸­ã€‚éƒ¨åˆ†çº¿ç¨‹æ ˆå’Œå †å¯èƒ½æœ‰æ—¶å€™ä¼šå‡ºç°åœ¨CPUç¼“å­˜ä¸­å’ŒCPUå†…éƒ¨çš„å¯„å­˜å™¨ä¸­ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒJavaå†…å­˜æ¨¡å‹å’Œè®¡ç®—æœºç¡¬ä»¶å†…å­˜æ¶æ„æ˜¯ä¸€ä¸ªäº¤å‰å…³ç³»ï¼š&lt;/p>
&lt;p>&lt;img src="https://img.hinathan.online/2025/07/42981.png" alt="">&lt;/p>
&lt;h3 id="å†…å­˜äº¤äº’æ“ä½œ">å†…å­˜äº¤äº’æ“ä½œ&lt;/h3>
&lt;p>å…³äºä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´çš„å…·ä½“äº¤äº’åè®®ï¼Œå³ä¸€ä¸ªå˜é‡å¦‚ä½•ä»ä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ã€å¦‚ä½•ä»å·¥ä½œå†…å­˜åŒæ­¥åˆ°ä¸»å†…å­˜ä¹‹é—´çš„å®ç°ç»†èŠ‚ï¼Œ&lt;code>Javaå†…å­˜æ¨¡å‹å®šä¹‰äº†ä»¥ä¸‹å…«ç§æ“ä½œ&lt;/code>æ¥å®Œæˆï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>lock&lt;/code>ï¼šé”å®šï¼Œä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼ŒæŠŠä¸€ä¸ªå˜é‡æ ‡è¯†ä¸ºä¸€æ¡çº¿ç¨‹ç‹¬å çŠ¶æ€ã€‚&lt;/li>
&lt;li>&lt;code>read&lt;/code>ï¼šè¯»å–ï¼Œä½œç”¨äºä¸»å†…å­˜å˜é‡ï¼ŒæŠŠä¸€ä¸ªå˜é‡å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„loadåŠ¨ä½œä½¿ç”¨&lt;/li>
&lt;li>&lt;code>load&lt;/code>ï¼šè½½å…¥ï¼Œä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠreadæ“ä½œä»ä¸»å†…å­˜ä¸­å¾—åˆ°çš„å˜é‡å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­ã€‚&lt;/li>
&lt;li>&lt;code>use&lt;/code>ï¼šä½¿ç”¨ï¼Œä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼ŒæŠŠå·¥ä½œå†…å­˜ä¸­çš„ä¸€ä¸ªå˜é‡å€¼ä¼ é€’ç»™&lt;code>æ‰§è¡Œå¼•æ“&lt;/code>ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªéœ€è¦ä½¿ç”¨å˜é‡çš„å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶å°†ä¼šæ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚&lt;/li>
&lt;li>&lt;code>assign&lt;/code>ï¼šèµ‹å€¼ï¼Œä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»&lt;code>æ‰§è¡Œå¼•æ“&lt;/code>æ¥æ”¶åˆ°çš„å€¼èµ‹å€¼ç»™&lt;code>å·¥ä½œå†…å­˜&lt;/code>çš„å˜é‡ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªç»™å˜é‡èµ‹å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶æ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚&lt;/li>
&lt;li>&lt;code>store&lt;/code>ï¼šå­˜å‚¨ï¼Œä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼ŒæŠŠå·¥ä½œå†…å­˜ä¸­çš„ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„writeçš„æ“ä½œã€‚&lt;/li>
&lt;li>&lt;code>write&lt;/code>ï¼šå†™å…¥ï¼Œä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠstoreæ“ä½œä»å·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜çš„å˜é‡ä¸­ã€‚&lt;/li>
&lt;li>&lt;code>unlock&lt;/code>ï¼šè§£é”ï¼Œä½œç”¨äºä¸»å†…å­˜å˜é‡ï¼ŒæŠŠä¸€ä¸ªå¤„äºé”å®šçŠ¶æ€çš„å˜é‡é‡Šæ”¾å‡ºæ¥ï¼Œé‡Šæ”¾åçš„å˜é‡æ‰å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®šã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://img.hinathan.online/2025/07/27711.png" alt="">&lt;/p>
&lt;ul>
&lt;li>readå’Œloadæˆå¯¹å‡ºç°&lt;/li>
&lt;li>storeå’Œwriteæˆå¯¹å‡ºç°&lt;/li>
&lt;/ul>
&lt;p>å…¶å®å¾ˆå¥½ç†è§£ï¼Œä¸‹é¢æ˜¯å…·ä½“çš„è§„åˆ™â†“â†“â†“&lt;/p>
&lt;h4 id="å†…å­˜äº¤äº’æ“ä½œè§„åˆ™">å†…å­˜äº¤äº’æ“ä½œè§„åˆ™&lt;/h4>
&lt;p>Javaå†…å­˜æ¨¡å‹è¿˜è§„å®šäº†åœ¨æ‰§è¡Œä¸Šè¿°å…«ç§åŸºæœ¬æ“ä½œæ—¶ï¼Œå¿…é¡»æ»¡è¶³å¦‚ä¸‹è§„åˆ™ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœè¦æŠŠä¸€ä¸ªå˜é‡ä»ä¸»å†…å­˜ä¸­å¤åˆ¶åˆ°å·¥ä½œå†…å­˜ï¼Œå°±éœ€è¦æŒ‰é¡ºå¯»åœ°æ‰§è¡Œreadå’Œloadæ“ä½œï¼Œ å¦‚æœæŠŠå˜é‡ä»å·¥ä½œå†…å­˜ä¸­åŒæ­¥å›ä¸»å†…å­˜ä¸­ï¼Œå°±è¦æŒ‰é¡ºåºåœ°æ‰§è¡Œstoreå’Œwriteæ“ä½œã€‚ä½†Javaå†…å­˜æ¨¡å‹åªè¦æ±‚ä¸Šè¿°æ“ä½œå¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œè€Œæ²¡æœ‰ä¿è¯å¿…é¡»æ˜¯è¿ç»­æ‰§è¡Œã€‚&lt;/li>
&lt;li>ä¸å…è®¸readå’Œloadã€storeå’Œwriteæ“ä½œä¹‹ä¸€å•ç‹¬å‡ºç°&lt;/li>
&lt;li>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹ä¸¢å¼ƒå®ƒçš„æœ€è¿‘assignçš„æ“ä½œï¼Œå³å˜é‡åœ¨å·¥ä½œå†…å­˜ä¸­æ”¹å˜äº†ä¹‹åå¿…é¡»åŒæ­¥åˆ°ä¸»å†…å­˜ä¸­ã€‚&lt;/li>
&lt;li>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŸå› åœ°ï¼ˆæ²¡æœ‰å‘ç”Ÿè¿‡ä»»ä½•assignæ“ä½œï¼‰æŠŠæ•°æ®ä»å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ä¸­ã€‚&lt;/li>
&lt;li>ä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­è¯ç”Ÿï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–ï¼ˆloadæˆ–assignï¼‰çš„å˜é‡ã€‚å³å°±æ˜¯å¯¹ä¸€ä¸ªå˜é‡å®æ–½useå’Œstoreæ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæ‰§è¡Œè¿‡äº†assignå’Œloadæ“ä½œã€‚&lt;/li>
&lt;li>ä¸€ä¸ªå˜é‡åœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œlockæ“ä½œï¼Œä½†lockæ“ä½œå¯ä»¥è¢«åŒä¸€æ¡çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œlockåï¼Œåªæœ‰æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„unlockæ“ä½œï¼Œå˜é‡æ‰ä¼šè¢«è§£é”ã€‚lockå’Œunlockå¿…é¡»æˆå¯¹å‡ºç°&lt;/li>
&lt;li>å¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œlockæ“ä½œï¼Œå°†ä¼šæ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡å‰éœ€è¦é‡æ–°æ‰§è¡Œloadæˆ–assignæ“ä½œåˆå§‹åŒ–å˜é‡çš„å€¼&lt;/li>
&lt;li>å¦‚æœä¸€ä¸ªå˜é‡äº‹å…ˆæ²¡æœ‰è¢«lockæ“ä½œé”å®šï¼Œåˆ™ä¸å…è®¸å¯¹å®ƒæ‰§è¡Œunlockæ“ä½œï¼›ä¹Ÿä¸å…è®¸å»unlockä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”å®šçš„å˜é‡ã€‚&lt;/li>
&lt;li>å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œunlockæ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥åˆ°ä¸»å†…å­˜ä¸­ï¼ˆæ‰§è¡Œstoreå’Œwriteæ“ä½œï¼‰ã€‚&lt;/li>
&lt;/ul></description></item><item><title>Javaå¹¶å‘ç¼–ç¨‹ï¼ˆä¸€ï¼‰çº¿ç¨‹åŸºç¡€ã€çº¿ç¨‹ä¹‹é—´çš„å…±äº«å’Œåä½œ</title><link>https://www.hinathan.online/blog/01-process_and_thread/</link><pubDate>Fri, 03 Jan 2020 20:28:34 +0800</pubDate><guid>https://www.hinathan.online/blog/01-process_and_thread/</guid><description>&lt;h2 id="ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹">ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹&lt;/h2>
&lt;h3 id="è¿›ç¨‹æ˜¯ç¨‹åºè¿è¡Œèµ„æºåˆ†é…çš„æœ€å°å•ä½">è¿›ç¨‹æ˜¯ç¨‹åºè¿è¡Œèµ„æºåˆ†é…çš„æœ€å°å•ä½&lt;/h3>
&lt;p>è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œå…¶ä¸­èµ„æºåŒ…æ‹¬:CPUã€å†…å­˜ç©ºé—´ã€ç£ç›˜ IO ç­‰ï¼ŒåŒä¸€è¿›ç¨‹ä¸­çš„å¤šæ¡çº¿ç¨‹å…±äº«è¯¥è¿›ç¨‹ä¸­çš„å…¨éƒ¨ç³»ç»Ÿèµ„æºï¼Œè€Œè¿›ç¨‹å’Œè¿›ç¨‹ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚è¿›ç¨‹æ˜¯å…·æœ‰ä¸€å®šç‹¬ç«‹åŠŸèƒ½çš„ç¨‹åºå…³äºæŸä¸ªæ•°æ®é›†åˆä¸Šçš„ä¸€æ¬¡è¿è¡Œæ´»åŠ¨ï¼Œ&lt;strong>è¿›ç¨‹æ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„ä¸€ä¸ªç‹¬ç«‹å•ä½ã€‚&lt;/strong>&lt;/p>
&lt;p>è¿›ç¨‹æ˜¯ç¨‹åºåœ¨è®¡ç®—æœºä¸Šçš„ä¸€æ¬¡æ‰§è¡Œæ´»åŠ¨ã€‚å½“ä½ è¿è¡Œä¸€ä¸ªç¨‹åºï¼Œä½ å°±å¯åŠ¨äº†ä¸€ä¸ªè¿›ç¨‹ã€‚æ˜¾ç„¶,ç¨‹åºæ˜¯æ­»çš„ã€é™æ€çš„,è¿›ç¨‹æ˜¯æ´»çš„ã€åŠ¨æ€çš„ã€‚è¿›ç¨‹å¯ä»¥åˆ†ä¸ºç³»ç»Ÿè¿›ç¨‹å’Œç”¨æˆ·è¿›ç¨‹ã€‚å‡¡æ˜¯ç”¨äºå®Œæˆæ“ä½œç³»ç»Ÿçš„å„ç§åŠŸèƒ½çš„è¿›ç¨‹å°±æ˜¯ç³»ç»Ÿè¿›ç¨‹ï¼Œå®ƒä»¬å°±æ˜¯å¤„äºè¿è¡ŒçŠ¶æ€ä¸‹çš„æ“ä½œç³»ç»Ÿæœ¬èº«ï¼Œç”¨æˆ·è¿›ç¨‹å°±æ˜¯æ‰€æœ‰ç”±ä½ å¯åŠ¨çš„è¿›ç¨‹ã€‚&lt;/p>
&lt;p>&lt;strong>çº¿ç¨‹æ˜¯ CPUè°ƒåº¦çš„æœ€å°å•ä½ï¼Œå¿…é¡»ä¾èµ–äºè¿›ç¨‹è€Œå­˜åœ¨ï¼&lt;/strong>&lt;/p>
&lt;p>çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå®ä½“ï¼Œæ˜¯ CPU è°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½ï¼Œå®ƒæ˜¯æ¯”è¿›ç¨‹æ›´å°çš„ã€èƒ½ç‹¬ç«‹è¿è¡Œçš„åŸºæœ¬å•ä½ã€‚çº¿ç¨‹è‡ªå·±åŸºæœ¬ä¸Šä¸æ‹¥æœ‰ç³»ç»Ÿèµ„æºï¼Œåªæ‹¥æœ‰ä¸€ç‚¹åœ¨è¿è¡Œä¸­å¿…ä¸å¯å°‘çš„èµ„æºï¼ˆå¦‚ç¨‹åºè®¡æ•°å™¨ï¼Œä¸€ç»„å¯„å­˜å™¨å’Œæ ˆï¼‰ï¼Œä½†æ˜¯å®ƒå¯ä¸åŒå±ä¸€ä¸ªè¿›ç¨‹çš„å…¶ä»–çš„çº¿ç¨‹å…±äº«è¿›ç¨‹æ‰€æ‹¥æœ‰çš„å…¨éƒ¨èµ„æºã€‚&lt;/p>
&lt;h3 id="çº¿ç¨‹æ— å¤„ä¸åœ¨">çº¿ç¨‹æ— å¤„ä¸åœ¨&lt;/h3>
&lt;p>ä»»ä½•ä¸€ä¸ªç¨‹åºéƒ½å¿…é¡»è¦åˆ›å»ºçº¿ç¨‹ï¼Œç‰¹åˆ«æ˜¯ Java ä¸ç®¡ä»»ä½•ç¨‹åºéƒ½å¿…é¡»å¯åŠ¨ä¸€ä¸ª&lt;/p>
&lt;p>main å‡½æ•°çš„ä¸»çº¿ç¨‹ï¼›Java Web å¼€å‘é‡Œé¢çš„å®šæ—¶ä»»åŠ¡ã€å®šæ—¶å™¨ã€JSP å’Œ Servletã€å¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶ï¼Œè¿œç¨‹è®¿é—®æ¥å£RM ç­‰ï¼Œä»»ä½•ä¸€ä¸ªç›‘å¬äº‹ä»¶,ï¼Œonclick çš„è§¦å‘äº‹ä»¶ç­‰éƒ½ç¦»ä¸å¼€çº¿ç¨‹å’Œå¹¶å‘çš„çŸ¥è¯†ã€‚&lt;/p>
&lt;h3 id="cpuæ ¸å¿ƒæ•°å’Œçº¿ç¨‹æ•°çš„å…³ç³»">CPUæ ¸å¿ƒæ•°å’Œçº¿ç¨‹æ•°çš„å…³ç³»&lt;/h3>
&lt;p>å¤šæ ¸å¿ƒï¼šä¹ŸæŒ‡å•èŠ¯ç‰‡å¤šå¤„ç†å™¨( &lt;code>Chip Multiprocessors&lt;/code>ï¼Œç®€ç§° &lt;code>CMP&lt;/code>)ï¼ŒCMP æ˜¯ç”±ç¾å›½æ–¯å¦ç¦å¤§å­¦æå‡ºçš„ï¼Œå…¶æ€æƒ³æ˜¯å°†å¤§è§„æ¨¡å¹¶è¡Œå¤„ç†å™¨ä¸­çš„ SMPï¼ˆå¯¹ç§°å¤šå¤„ç†å™¨ï¼‰é›†æˆåˆ°åŒä¸€èŠ¯ç‰‡å†…ï¼Œå„ä¸ªå¤„ç†å™¨å¹¶è¡Œæ‰§è¡Œä¸åŒçš„è¿›ç¨‹ã€‚è¿™ç§ä¾é å¤šä¸ª CPU åŒæ—¶å¹¶è¡Œåœ°è¿è¡Œç¨‹åºæ˜¯å®ç°è¶…é«˜é€Ÿè®¡ç®—çš„ä¸€ä¸ªé‡è¦æ–¹å‘,ç§°ä¸ºå¹¶è¡Œå¤„ç†&lt;/p>
&lt;p>å¤šçº¿ç¨‹: &lt;code>Simultaneous Multithreading&lt;/code>ï¼Œç®€ç§° &lt;code>SMT&lt;/code>ã€‚è®©åŒä¸€ä¸ªå¤„ç†å™¨ä¸Šçš„å¤šä¸ªçº¿ç¨‹åŒæ­¥æ‰§è¡Œå¹¶å…±äº«å¤„ç†å™¨çš„æ‰§è¡Œèµ„æºã€‚&lt;/p>
&lt;p>æ ¸å¿ƒæ•°ã€çº¿ç¨‹æ•°:ç›®å‰ä¸»æµ CPU éƒ½æ˜¯å¤šæ ¸çš„ã€‚å¢åŠ æ ¸å¿ƒæ•°ç›®å°±æ˜¯ä¸ºäº†å¢åŠ çº¿ç¨‹æ•°,å› ä¸ºæ“ä½œç³»ç»Ÿæ˜¯é€šè¿‡çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡çš„,ä¸€èˆ¬æƒ…å†µä¸‹å®ƒä»¬æ˜¯ 1:1 å¯¹åº”å…³ç³»,ä¹Ÿå°±æ˜¯è¯´å››æ ¸ CPU ä¸€èˆ¬æ‹¥æœ‰å››ä¸ªçº¿ç¨‹ã€‚ä½† Intel å¼•å…¥è¶…çº¿ç¨‹æŠ€æœ¯å,ä½¿æ ¸å¿ƒæ•°ä¸çº¿ç¨‹æ•°å½¢æˆ 1:2 çš„å…³ç³»&lt;/p>
&lt;p style="text-align: center;">
&lt;img src="https://img.hinathan.online/2025/07/image-20250329071857402.png" alt="image-20250329071857402" style="zoom:50%;" />
&lt;/p>
&lt;h3 id="cpuæ—¶é—´ç‰‡è½®è½¬æœºåˆ¶">CPUæ—¶é—´ç‰‡è½®è½¬æœºåˆ¶&lt;/h3>
&lt;p>æˆ‘ä»¬å¹³æ—¶åœ¨å¼€å‘çš„æ—¶å€™ï¼Œæ„Ÿè§‰å¹¶æ²¡æœ‰å— cpu æ ¸å¿ƒæ•°çš„é™åˆ¶ï¼Œæƒ³å¯åŠ¨çº¿ç¨‹å°±å¯åŠ¨çº¿ç¨‹ï¼Œå“ªæ€•æ˜¯åœ¨å•æ ¸ CPU ä¸Šï¼Œä¸ºä»€ä¹ˆï¼Ÿè¿™æ˜¯å› ä¸ºæ“ä½œç³»ç»Ÿæä¾›äº†ä¸€ç§ CPU æ—¶é—´ç‰‡è½®è½¬æœºåˆ¶ã€‚&lt;/p>
&lt;p>æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦æ˜¯ä¸€ç§æœ€å¤è€ã€æœ€ç®€å•ã€æœ€å…¬å¹³ä¸”ä½¿ç”¨æœ€å¹¿çš„ç®—æ³•ï¼Œåˆç§° RRè°ƒåº¦ï¼ˆ&lt;code>Round Robin&lt;/code>ï¼‰ã€‚æ¯ä¸ªè¿›ç¨‹è¢«åˆ†é…ä¸€ä¸ªæ—¶é—´æ®µï¼Œç§°ä½œå®ƒçš„æ—¶é—´ç‰‡ï¼Œå³è¯¥è¿›ç¨‹å…è®¸è¿è¡Œçš„æ—¶é—´ã€‚ç™¾åº¦ç™¾ç§‘å¯¹ CPU æ—¶é—´ç‰‡è½®è½¬æœºåˆ¶åŸç†è§£é‡Šå¦‚ä¸‹ï¼š
&lt;a href="..%2F..%2F..%2F..%2FIdeaProjects%2FBlog%2Fout%2Fproduction%2FBlog%2FWorker.class">Worker.class&lt;/a>
å¦‚æœåœ¨æ—¶é—´ç‰‡ç»“æŸæ—¶è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œåˆ™ CPU å°†è¢«å‰¥å¤ºå¹¶åˆ†é…ç»™å¦ä¸€ä¸ªè¿›ç¨‹ã€‚å¦‚æœè¿›ç¨‹åœ¨æ—¶é—´ç‰‡ç»“æŸå‰é˜»å¡æˆ–ç»“æŸï¼Œåˆ™ CPU å½“å³è¿›è¡Œåˆ‡æ¢ã€‚è°ƒåº¦ç¨‹åºæ‰€è¦åšçš„å°±æ˜¯ç»´æŠ¤ä¸€å¼ å°±ç»ª&lt;code>è¿›ç¨‹åˆ—è¡¨&lt;/code>ï¼Œå½“è¿›ç¨‹ç”¨å®Œå®ƒçš„æ—¶é—´ç‰‡åï¼Œå®ƒè¢«ç§»åˆ°é˜Ÿåˆ—çš„æœ«å°¾ã€‚&lt;/p>
&lt;p>æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ä¸­å”¯ä¸€æœ‰è¶£çš„ä¸€ç‚¹æ˜¯æ—¶é—´ç‰‡çš„é•¿åº¦ã€‚ä»ä¸€ä¸ªè¿›ç¨‹åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹æ˜¯éœ€è¦å®šæ—¶é—´çš„ï¼ŒåŒ…æ‹¬ä¿å­˜å’Œè£…å…¥å¯„å­˜å™¨å€¼åŠå†…å­˜æ˜ åƒï¼Œæ›´æ–°å„ç§è¡¨æ ¼å’Œé˜Ÿåˆ—ç­‰ã€‚å‡å¦‚è¿›ç¨‹åˆ‡æ¢( &lt;code>processwitch&lt;/code>)ï¼Œæœ‰æ—¶ç§°ä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢(&lt;code> context switch&lt;/code>)ï¼Œéœ€è¦ 5msï¼Œå†å‡è®¾æ—¶é—´ç‰‡è®¾ä¸º 20msï¼Œåˆ™åœ¨åšå®Œ 20ms æœ‰ç”¨çš„å·¥ä½œä¹‹åï¼ŒCPU å°†èŠ±è´¹ 5ms æ¥è¿›è¡Œè¿›ç¨‹åˆ‡æ¢ã€‚CPU æ—¶é—´çš„ 20%è¢«æµªè´¹åœ¨äº†ç®¡ç†å¼€é”€ä¸Šäº†ã€‚&lt;/p>
&lt;p>ä¸ºäº†æé«˜ CPU æ•ˆç‡ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ—¶é—´ç‰‡è®¾ä¸º 5000msã€‚è¿™æ—¶æµªè´¹çš„æ—¶é—´åªæœ‰1%ã€‚ä½†è€ƒè™‘åˆ°åœ¨ä¸€ä¸ªåˆ†æ—¶ç³»ç»Ÿä¸­ï¼Œå¦‚æœæœ‰ 10 ä¸ªäº¤äº’ç”¨æˆ·å‡ ä¹åŒæ—¶æŒ‰ä¸‹å›è½¦é”®,ï¼Œå°†å‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿå‡è®¾æ‰€æœ‰å…¶ä»–è¿›ç¨‹éƒ½ç”¨è¶³å®ƒä»¬çš„æ—¶é—´ç‰‡çš„è¯ï¼Œæœ€åä¸€ä¸ªä¸å¹¸çš„è¿›ç¨‹ä¸å¾—ä¸ç­‰å¾… 5s æ‰è·å¾—è¿è¡Œæœºä¼šã€‚å¤šæ•°ç”¨æˆ·æ— æ³•å¿å—ä¸€æ¡ç®€çŸ­å‘½ä»¤è¦ 5 sæ‰èƒ½åšå‡ºå“åº”ï¼ŒåŒæ ·çš„é—®é¢˜åœ¨ä¸€å°æ”¯æŒå¤šé“ç¨‹åºçš„ä¸ªäººè®¡ç®—æœºä¸Šä¹Ÿä¼šå‘ç”Ÿã€‚&lt;/p>
&lt;p>ç»“è®ºå¯ä»¥å½’ç»“å¦‚ä¸‹ï¼šæ—¶é—´ç‰‡è®¾å¾—å¤ªçŸ­ä¼šå¯¼è‡´è¿‡å¤šçš„è¿›ç¨‹åˆ‡æ¢ï¼Œé™ä½äº†CPU æ•ˆç‡ï¼›è€Œè®¾å¾—å¤ªé•¿åˆå¯èƒ½å¼•èµ·å¯¹çŸ­çš„äº¤äº’è¯·æ±‚çš„å“åº”å˜å·®ã€‚å°†æ—¶é—´ç‰‡è®¾ä¸º 100ms é€šå¸¸æ˜¯ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„æŠ˜è¡·ã€‚&lt;/p>
&lt;p>åœ¨CPU æ­»æœºçš„æƒ…å†µä¸‹ï¼Œå…¶å®å¤§å®¶ä¸éš¾å‘ç°å½“è¿è¡Œä¸€ä¸ªç¨‹åºçš„æ—¶å€™æŠŠ CPU ç»™å¼„åˆ°äº†100%å†ä¸é‡å¯ç”µè„‘çš„æƒ…å†µä¸‹ï¼Œå…¶å®æˆ‘ä»¬è¿˜æ˜¯æœ‰æœºä¼šæŠŠå®ƒKillæ‰çš„ï¼Œæˆ‘æƒ³ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™ç§æœºåˆ¶çš„ç¼˜æ•…ã€‚&lt;/p>
&lt;h3 id="å¹¶è¡Œå’Œå¹¶å‘">å¹¶è¡Œå’Œå¹¶å‘&lt;/h3>
&lt;p>æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæœ‰æ¡é«˜é€Ÿå…¬è·¯ A ä¸Šé¢å¹¶æ’æœ‰ 8 æ¡è½¦é“ï¼Œé‚£ä¹ˆæœ€å¤§çš„&lt;strong>å¹¶è¡Œ&lt;/strong>è½¦è¾†å°±æ˜¯ 8 è¾†ã€‚æ­¤æ¡é«˜é€Ÿå…¬è·¯ A åŒæ—¶å¹¶æ’è¡Œèµ°çš„è½¦è¾†å°äºç­‰äº 8 è¾†çš„æ—¶å€™ï¼Œè½¦è¾†å°±å¯ä»¥å¹¶è¡Œè¿è¡Œã€‚CPU ä¹Ÿæ˜¯è¿™ä¸ªåŸç†ï¼Œä¸€ä¸ª CPU ç›¸å½“äºä¸€ä¸ªé«˜é€Ÿå…¬è·¯ Aï¼Œæ ¸å¿ƒæ•°æˆ–è€…çº¿ç¨‹æ•°å°±ç›¸å½“äºå¹¶æ’å¯ä»¥é€šè¡Œçš„è½¦é“ï¼›è€Œå¤šä¸ªCPU å°±ç›¸å½“äºå¹¶æ’æœ‰å¤šæ¡é«˜é€Ÿå…¬è·¯ï¼Œè€Œæ¯ä¸ªé«˜é€Ÿå…¬è·¯å¹¶æ’æœ‰å¤šä¸ªè½¦é“ã€‚&lt;/p>
&lt;p>å½“è°ˆè®º&lt;strong>å¹¶å‘&lt;/strong>çš„æ—¶å€™ä¸€å®šè¦åŠ ä¸ªå•ä½æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¯´å•ä½æ—¶é—´å†…å¹¶å‘é‡æ˜¯å¤šå°‘? ç¦»å¼€äº†å•ä½æ—¶é—´å…¶å®æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚&lt;/p>
&lt;p>ä¿—è¯è¯´ï¼Œä¸€å¿ƒä¸èƒ½äºŒç”¨ï¼Œè¿™å¯¹è®¡ç®—æœºä¹Ÿä¸€æ ·ï¼ŒåŸåˆ™ä¸Šä¸€ä¸ª CPU åªèƒ½åˆ†é…ç»™ä¸€ä¸ªè¿›ç¨‹ï¼Œä»¥ä¾¿è¿è¡Œè¿™ä¸ªè¿›ç¨‹ã€‚æˆ‘ä»¬é€šå¸¸ä½¿ç”¨çš„è®¡ç®—æœºä¸­åªæœ‰ä¸€ä¸ª CPUï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰ä¸€é¢—å¿ƒï¼Œè¦è®©å®ƒä¸€å¿ƒå¤šç”¨åŒæ—¶è¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼Œå°±å¿…é¡»ä½¿ç”¨å¹¶å‘æŠ€æœ¯ï¼å®ç°å¹¶å‘æŠ€æœ¯ç›¸å½“å¤æ‚ï¼Œæœ€å®¹æ˜“ç†è§£çš„æ˜¯â€œæ—¶é—´ç‰‡è½®è½¬è¿›ç¨‹è°ƒåº¦ç®—æ³•â€ã€‚&lt;/p>
&lt;p>ç»¼åˆæ¥è¯´ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¹¶å‘ï¼šæŒ‡åº”ç”¨èƒ½å¤Ÿäº¤æ›¿æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ï¼Œæ¯”å¦‚å•CPU æ ¸å¿ƒä¸‹æ‰§è¡Œå¤šçº¿ç¨‹å¹¶éæ˜¯åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œå¦‚æœä½ å¼€ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œå°±æ˜¯åœ¨ä½ å‡ ä¹ä¸å¯èƒ½å¯Ÿè§‰åˆ°çš„é€Ÿåº¦ä¸æ–­å»åˆ‡æ¢è¿™ä¸¤ä¸ªä»»åŠ¡ï¼Œå·²è¾¾åˆ°&amp;quot;åŒæ—¶æ‰§è¡Œæ•ˆæœ&amp;quot;ï¼Œå…¶å®å¹¶ä¸æ˜¯çš„ï¼Œåªæ˜¯è®¡ç®—æœºçš„é€Ÿåº¦å¤ªå¿«ï¼Œæˆ‘ä»¬æ— æ³•å¯Ÿè§‰åˆ°è€Œå·²ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¹¶è¡Œï¼šæŒ‡åº”ç”¨èƒ½å¤ŸåŒæ—¶æ‰§è¡Œä¸åŒçš„ä»»åŠ¡,ä¾‹:åƒé¥­çš„æ—¶å€™å¯ä»¥è¾¹åƒé¥­è¾¹æ‰“ç”µè¯ï¼Œè¿™ä¸¤ä»¶äº‹æƒ…å¯ä»¥åŒæ—¶æ‰§è¡Œã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä¸¤è€…åŒºåˆ«:ä¸€ä¸ªæ˜¯äº¤æ›¿æ‰§è¡Œï¼Œä¸€ä¸ªæ˜¯åŒæ—¶æ‰§è¡Œã€‚&lt;/p>
&lt;p>&lt;img src="https://img.hinathan.online/2025/07/image-20250329074107107.png" alt="image-20250329074107107">&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="é«˜å¹¶å‘ç¼–ç¨‹çš„æ„ä¹‰å¥½å¤„å’Œæ³¨æ„äº‹é¡¹">é«˜å¹¶å‘ç¼–ç¨‹çš„æ„ä¹‰ã€å¥½å¤„å’Œæ³¨æ„äº‹é¡¹&lt;/h3>
&lt;p>ç”±äºå¤šæ ¸å¤šçº¿ç¨‹çš„ CPU çš„è¯ç”Ÿï¼Œå¤šçº¿ç¨‹ã€é«˜å¹¶å‘çš„ç¼–ç¨‹è¶Šæ¥è¶Šå—é‡è§†å’Œå…³æ³¨ã€‚å¤šçº¿ç¨‹å¯ä»¥ç»™ç¨‹åºå¸¦æ¥å¦‚ä¸‹å¥½å¤„ã€‚&lt;/p>
&lt;ul>
&lt;li>å……åˆ†åˆ©ç”¨ CPU çš„èµ„æº&lt;/li>
&lt;/ul>
&lt;p>ä»ä¸Šé¢çš„CPU çš„ä»‹ç»ï¼Œå¯ä»¥çœ‹çš„å‡ºæ¥ï¼Œç°åœ¨å¸‚é¢ä¸Šæ²¡æœ‰CPU çš„å†…æ ¸ä¸ä½¿ç”¨å¤šçº¿ç¨‹å¹¶å‘æœºåˆ¶çš„ï¼Œç‰¹åˆ«æ˜¯æœåŠ¡å™¨è¿˜ä¸æ­¢ä¸€ä¸ªCPUï¼Œå¦‚æœè¿˜æ˜¯ä½¿ç”¨å•çº¿ç¨‹çš„æŠ€æœ¯åšæ€è·¯,ï¼Œæ˜æ˜¾å°± out äº†ã€‚å› ä¸ºç¨‹åºçš„åŸºæœ¬è°ƒåº¦å•å…ƒæ˜¯çº¿ç¨‹ï¼Œå¹¶ä¸”ä¸€ä¸ªçº¿ç¨‹ä¹Ÿåªèƒ½åœ¨ä¸€ä¸ª CPU çš„ä¸€ä¸ªæ ¸çš„ä¸€ä¸ªçº¿ç¨‹è·‘ï¼Œå¦‚æœä½ æ˜¯ä¸ªi3 çš„CPU çš„è¯,æœ€å·®ä¹Ÿæ˜¯åŒæ ¸å¿ƒ 4 çº¿ç¨‹çš„è¿ç®—èƒ½åŠ›ã€‚å¦‚æœæ˜¯ä¸€ä¸ªçº¿ç¨‹çš„ç¨‹åºçš„è¯ï¼Œé‚£æ˜¯è¦æµªè´¹ 3/4 çš„CPU æ€§èƒ½ã€‚å¦‚æœè®¾è®¡ä¸€ä¸ªå¤šçº¿ç¨‹çš„ç¨‹åºçš„è¯ï¼Œé‚£å®ƒå°±å¯ä»¥åŒæ—¶åœ¨å¤šä¸ªCPU çš„å¤šä¸ªæ ¸çš„å¤šä¸ªçº¿ç¨‹ä¸Šè·‘ï¼Œå¯ä»¥å……åˆ†åœ°åˆ©ç”¨ CPUï¼Œå‡å°‘ CPU çš„ç©ºé—²æ—¶é—´ï¼Œå‘æŒ¥å®ƒçš„è¿ç®—èƒ½åŠ›ï¼Œæé«˜å¹¶å‘é‡ã€‚&lt;/p>
&lt;p>&lt;u>&lt;strong>å°±åƒæˆ‘ä»¬å¹³æ—¶ååœ°é“ä¸€æ ·ï¼Œå¾ˆå¤šäººåé•¿çº¿åœ°é“çš„æ—¶å€™éƒ½åœ¨è®¤çœŸçœ‹ä¹¦ï¼Œè€Œä¸æ˜¯ä¸ºäº†ååœ°é“è€Œååœ°é“ï¼Œåˆ°å®¶äº†å†å»çœ‹ä¹¦ï¼Œè¿™æ ·ä½ çš„æ—¶é—´å°±ç›¸å½“äºæœ‰äº†ä¸¤å€ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæœ‰äº›äººæ—¶é—´å¾ˆå……è£•ï¼Œè€Œæœ‰äº›äººè€æ˜¯è¯´æ²¡æ—¶é—´çš„ä¸€ä¸ªåŸå› ï¼Œå·¥ä½œä¹Ÿæ˜¯è¿™æ ·ï¼Œæœ‰çš„æ—¶å€™å¯ä»¥å¹¶å‘åœ°å»åšå‡ ä»¶äº‹æƒ…ï¼Œå……åˆ†åˆ©ç”¨æˆ‘ä»¬çš„æ—¶é—´ï¼ŒCPU ä¹Ÿæ˜¯ä¸€æ ·ï¼Œä¹Ÿè¦å……åˆ†åˆ©ç”¨ã€‚&lt;/strong>&lt;/u>&lt;/p>
&lt;ul>
&lt;li>åŠ å¿«å“åº”ç”¨æˆ·çš„æ—¶é—´&lt;/li>
&lt;/ul>
&lt;p>æ¯”å¦‚æˆ‘ä»¬ç»å¸¸ç”¨çš„è¿…é›·ä¸‹è½½ï¼Œéƒ½å–œæ¬¢å¤šå¼€å‡ ä¸ªçº¿ç¨‹å»ä¸‹è½½ï¼Œè°éƒ½ä¸æ„¿æ„ç”¨ä¸€ä¸ªçº¿ç¨‹å»ä¸‹è½½ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿç­”æ¡ˆå¾ˆç®€å•ï¼Œå°±æ˜¯å¤šä¸ªçº¿ç¨‹ä¸‹è½½å¿«å•Šã€‚æˆ‘ä»¬åœ¨åšç¨‹åºå¼€å‘çš„æ—¶å€™æ›´åº”è¯¥å¦‚æ­¤ï¼Œç‰¹åˆ«æ˜¯æˆ‘ä»¬åšäº’è”ç½‘é¡¹ç›®ï¼Œç½‘é¡µçš„å“åº”æ—¶é—´è‹¥æå‡ 1sï¼Œå¦‚æœæµé‡å¤§çš„è¯ï¼Œå°±èƒ½å¢åŠ ä¸å°‘è½¬æ¢é‡ã€‚åšè¿‡é«˜æ€§èƒ½ web å‰ç«¯è°ƒä¼˜çš„éƒ½çŸ¥é“ï¼Œè¦å°†é™æ€èµ„æºåœ°å€ç”¨ä¸¤ä¸‰ä¸ªå­åŸŸåå»åŠ è½½ï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæ¯å¤šä¸€ä¸ªå­åŸŸåï¼Œæµè§ˆå™¨åœ¨åŠ è½½ä½ çš„é¡µé¢çš„æ—¶å€™å°±ä¼šå¤šå¼€å‡ ä¸ªçº¿ç¨‹å»åŠ è½½ä½ çš„é¡µé¢èµ„æºï¼Œæå‡ç½‘ç«™çš„å“åº”é€Ÿåº¦ã€‚å¤šçº¿ç¨‹ã€é«˜å¹¶å‘çœŸçš„æ˜¯æ— å¤„ä¸åœ¨ï¼&lt;/p>
&lt;ul>
&lt;li>å¯ä»¥ä½¿ä½ çš„ä»£ç æ¨¡å—åŒ–ï¼Œå¼‚æ­¥åŒ–ï¼Œç®€å•åŒ–&lt;/li>
&lt;/ul>
&lt;p>ä¾‹å¦‚æˆ‘ä»¬å®ç°ç”µå•†ç³»ç»Ÿï¼Œä¸‹è®¢å•å’Œç»™ç”¨æˆ·å‘é€çŸ­ä¿¡ã€é‚®ä»¶å°±å¯ä»¥è¿›è¡Œæ‹†åˆ†ï¼Œ å°†ç»™ç”¨æˆ·å‘é€çŸ­ä¿¡ã€é‚®ä»¶è¿™ä¸¤ä¸ªæ­¥éª¤ç‹¬ç«‹ä¸ºå•ç‹¬çš„æ¨¡å—ï¼Œå¹¶äº¤ç»™å…¶ä»–çº¿ç¨‹å»æ‰§è¡Œã€‚è¿™æ ·æ—¢å¢åŠ äº†å¼‚æ­¥çš„æ“ä½œï¼Œæå‡äº†ç³»ç»Ÿæ€§èƒ½ï¼Œåˆä½¿ç¨‹åºæ¨¡å—åŒ–ï¼Œæ¸…æ™°åŒ–å’Œç®€å•åŒ–ã€‚&lt;/p>
&lt;p>å¤šçº¿ç¨‹åº”ç”¨å¼€å‘çš„å¥½å¤„è¿˜æœ‰å¾ˆå¤šï¼Œå¤§å®¶åœ¨æ—¥åçš„ä»£ç ç¼–å†™è¿‡ç¨‹ä¸­å¯ä»¥æ…¢æ…¢ä½“ä¼šå®ƒçš„é­…åŠ›ã€‚&lt;/p>
&lt;h3 id="å¤šçº¿ç¨‹ç¨‹åºéœ€è¦æ³¨æ„äº‹é¡¹">å¤šçº¿ç¨‹ç¨‹åºéœ€è¦æ³¨æ„äº‹é¡¹&lt;/h3>
&lt;ul>
&lt;li>çº¿ç¨‹ä¹‹é—´çš„å®‰å…¨æ€§&lt;/li>
&lt;/ul>
&lt;p>ä»å‰é¢çš„ç« èŠ‚ä¸­æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹é‡Œé¢çš„å¤šçº¿ç¨‹æ˜¯èµ„æºå…±äº«çš„ï¼Œä¹Ÿå°±æ˜¯éƒ½å¯ä»¥è®¿é—®åŒä¸€ä¸ªå†…å­˜åœ°å€å½“ä¸­çš„ä¸€ä¸ªå˜é‡ã€‚ä¾‹å¦‚ï¼šè‹¥æ¯ä¸ªçº¿ç¨‹ä¸­å¯¹å…¨å±€å˜é‡ã€é™æ€å˜é‡åªæœ‰è¯»æ“ä½œï¼Œè€Œæ— å†™æ“ä½œï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªå…¨å±€å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚è‹¥æœ‰å¤š ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œå†™æ“ä½œï¼Œä¸€èˆ¬éƒ½éœ€è¦è€ƒè™‘çº¿ç¨‹åŒæ­¥ï¼Œå¦åˆ™å°±å¯èƒ½å½±å“çº¿ç¨‹å®‰å…¨ï¼&lt;/p>
&lt;ul>
&lt;li>çº¿ç¨‹ä¹‹é—´çš„æ­»é”&lt;/li>
&lt;/ul>
&lt;p>ä¸ºäº†è§£å†³çº¿ç¨‹ä¹‹é—´çš„å®‰å…¨æ€§å¼•å…¥äº† Java çš„é”æœºåˆ¶ï¼Œè€Œä¸€ä¸å°å¿ƒå°±ä¼šäº§ç”Ÿ Java çº¿ç¨‹æ­»é”çš„å¤šçº¿ç¨‹é—®é¢˜ï¼Œå› ä¸ºä¸åŒçš„çº¿ç¨‹éƒ½åœ¨ç­‰å¾…é‚£äº›æ ¹æœ¬ä¸å¯èƒ½è¢«é‡Šæ”¾çš„é”ï¼Œä»è€Œå¯¼è‡´æ‰€æœ‰çš„å·¥ä½œéƒ½æ— æ³•å®Œæˆã€‚å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«ä»£è¡¨ä¸¤ä¸ªé¥¥é¥¿çš„äººï¼Œä»–ä»¬å¿…é¡»å…±äº«åˆ€å‰å¹¶è½®æµåƒé¥­ã€‚ä»–ä»¬éƒ½éœ€è¦è·å¾—ä¸¤ä¸ªé”ï¼šå…±äº«åˆ€å’Œå…±äº«å‰çš„é”ã€‚&lt;/p>
&lt;p>å‡å¦‚çº¿ç¨‹ A è·å¾—äº†åˆ€ï¼Œè€Œçº¿ç¨‹ B è·å¾—äº†å‰ã€‚çº¿ç¨‹ A å°±ä¼šè¿›å…¥é˜»å¡çŠ¶æ€æ¥ç­‰å¾…è·å¾—å‰ï¼Œè€Œçº¿ç¨‹ B åˆ™é˜»å¡æ¥ç­‰å¾…çº¿ç¨‹ A æ‰€æ‹¥æœ‰çš„åˆ€ã€‚è¿™åªæ˜¯äººä¸ºè®¾è®¡çš„ä¾‹å­ï¼Œä½†å°½ç®¡åœ¨è¿è¡Œæ—¶å¾ˆéš¾æ¢æµ‹åˆ°è¿™ç±»æƒ…å†µå´æ—¶å¸¸å‘ç”Ÿã€‚&lt;/p>
&lt;ul>
&lt;li>çº¿ç¨‹å¤ªå¤šäº†ä¼šå°†æœåŠ¡å™¨èµ„æºè€—å°½å½¢æˆæ­»æœºå®•æœº&lt;/li>
&lt;/ul>
&lt;p>çº¿ç¨‹æ•°å¤ªå¤šæœ‰å¯èƒ½é€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œç³»ç»Ÿå†…å­˜ä»¥åŠ CPUçš„â€œè¿‡æ¸¡åˆ‡æ¢â€ï¼Œé€ æˆç³»ç»Ÿçš„æ­»æœºï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•è§£å†³è¿™ç±»é—®é¢˜å‘¢ï¼Ÿ&lt;/p>
&lt;p>æŸäº›ç³»ç»Ÿèµ„æºæ˜¯æœ‰é™çš„ï¼Œå¦‚æ–‡ä»¶æè¿°ç¬¦ã€‚å¤šçº¿ç¨‹ç¨‹åºå¯èƒ½è€—å°½èµ„æºï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½å¯èƒ½å¸Œæœ›æœ‰ä¸€ä¸ªè¿™æ ·çš„èµ„æºã€‚å¦‚æœçº¿ç¨‹æ•°ç›¸å½“å¤§ï¼Œæˆ–è€…æŸä¸ªèµ„æºçš„ä¾¯é€‰çº¿ç¨‹æ•°è¿œè¿œè¶…è¿‡äº†å¯ç”¨çš„èµ„æºæ•°åˆ™æœ€å¥½ä½¿ç”¨èµ„æºæ± ã€‚ä¸€ä¸ªæœ€å¥½çš„ç¤ºä¾‹æ˜¯æ•°æ®åº“è¿æ¥æ± ã€‚åªè¦çº¿ç¨‹éœ€è¦ä½¿ç”¨ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œå®ƒå°±ä»æ± ä¸­å–å‡ºä¸€ä¸ªï¼Œä½¿ç”¨ä»¥åå†å°†å®ƒè¿”å›æ± ä¸­ã€‚èµ„æºæ± ä¹Ÿç§°ä¸ºèµ„æºåº“ã€‚&lt;/p>
&lt;p>å¤šçº¿ç¨‹åº”ç”¨å¼€å‘çš„æ³¨æ„äº‹é¡¹å¾ˆå¤šï¼Œå¸Œæœ›å¤§å®¶åœ¨æ—¥åçš„å·¥ä½œä¸­å¯ä»¥æ…¢æ…¢ä½“ä¼šå®ƒçš„å±é™©æ‰€åœ¨ã€‚&lt;/p>
&lt;h2 id="è®¤è¯†java-é‡Œçš„çº¿ç¨‹">è®¤è¯†Java é‡Œçš„çº¿ç¨‹&lt;/h2>
&lt;h3 id="javaç¨‹åºå¤©ç”Ÿå°±æ˜¯å¤šçº¿ç¨‹çš„">Javaç¨‹åºå¤©ç”Ÿå°±æ˜¯å¤šçº¿ç¨‹çš„&lt;/h3>
&lt;p>ä¸€ä¸ª Java ç¨‹åºä» &lt;code>main()&lt;/code>æ–¹æ³•å¼€å§‹æ‰§è¡Œï¼Œç„¶åæŒ‰ç…§æ—¢å®šçš„ä»£ç é€»è¾‘æ‰§è¡Œï¼Œçœ‹ä¼¼æ²¡æœ‰å…¶ä»–çº¿ç¨‹å‚ä¸ï¼Œä½†å®é™…ä¸Š Java ç¨‹åºå¤©ç”Ÿå°±æ˜¯å¤šçº¿ç¨‹ç¨‹åºï¼Œå› ä¸ºæ‰§è¡Œ &lt;code>main()&lt;/code> æ–¹æ³•çš„æ˜¯ä¸€ä¸ªåç§°ä¸º &lt;code>main &lt;/code>çš„çº¿ç¨‹ã€‚&lt;/p>
&lt;h3 id="çº¿ç¨‹çš„å¯åŠ¨ä¸ä¸­æ­¢">çº¿ç¨‹çš„å¯åŠ¨ä¸ä¸­æ­¢&lt;/h3>
&lt;h4 id="å¯åŠ¨">å¯åŠ¨&lt;/h4>
&lt;p>å¯åŠ¨çº¿ç¨‹çš„æ–¹å¼æœ‰ï¼š&lt;/p>
&lt;ol>
&lt;li>X extends Thread;ï¼Œç„¶å X.start&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Main&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> Thread &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Main main &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Main&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> main&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>X implements Runnableï¼›ç„¶åäº¤ç»™ Thread è¿è¡Œ&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Main&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Thread thread &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> Runnable&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">run&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Hello World&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">});&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Thread å’Œ Runnable çš„åŒºåˆ«&lt;/p>
&lt;p>Thread æ‰æ˜¯ Java é‡Œå¯¹çº¿ç¨‹çš„å”¯ä¸€æŠ½è±¡ï¼ŒRunnable åªæ˜¯å¯¹ä»»åŠ¡ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰ çš„æŠ½è±¡ã€‚Thread å¯ä»¥æ¥å—ä»»æ„ä¸€ä¸ª Runnable çš„å®ä¾‹å¹¶æ‰§è¡Œã€‚&lt;/p>
&lt;h4 id="ä¸­æ­¢">ä¸­æ­¢&lt;/h4>
&lt;p>çº¿ç¨‹è‡ªç„¶ç»ˆæ­¢ï¼Œè¦ä¹ˆæ˜¯ run æ‰§è¡Œå®Œæˆäº†ï¼Œè¦ä¹ˆæ˜¯æŠ›å‡ºäº†ä¸€ä¸ªæœªå¤„ç†çš„å¼‚å¸¸å¯¼è‡´çº¿ç¨‹æå‰ç»“æŸã€‚&lt;/p>
&lt;h5 id="stop">stop&lt;/h5>
&lt;p>æš‚åœã€æ¢å¤å’Œåœæ­¢æ“ä½œå¯¹åº”åœ¨çº¿ç¨‹ Thread çš„ API å°±æ˜¯ &lt;code>suspend()&lt;/code>ã€&lt;code>resume()&lt;/code>å’Œ &lt;code>stop()&lt;/code>ã€‚ä½†æ˜¯è¿™äº› API æ˜¯è¿‡æœŸçš„ï¼Œä¹Ÿå°±æ˜¯ä¸å»ºè®®ä½¿ç”¨çš„ã€‚ä¸å»ºè®®ä½¿ç”¨çš„åŸå› ä¸»è¦æœ‰ï¼šä»¥ suspend()æ–¹æ³•ä¸ºä¾‹ï¼Œåœ¨è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šé‡Šæ”¾å·²ç»å æœ‰çš„èµ„æºï¼ˆæ¯”å¦‚é”ï¼‰ï¼Œè€Œæ˜¯å æœ‰ç€èµ„æºè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œè¿™æ ·å®¹æ˜“å¼•å‘æ­»é”é—®é¢˜ã€‚åŒæ ·ï¼Œstop()æ–¹ æ³•åœ¨ç»ˆç»“ä¸€ä¸ªçº¿ç¨‹æ—¶ä¸ä¼šä¿è¯çº¿ç¨‹çš„èµ„æºæ­£å¸¸é‡Šæ”¾ï¼Œé€šå¸¸æ˜¯æ²¡æœ‰ç»™äºˆçº¿ç¨‹å®Œæˆèµ„æºé‡Šæ”¾å·¥ä½œçš„æœºä¼šï¼Œå› æ­¤ä¼šå¯¼è‡´ç¨‹åºå¯èƒ½å·¥ä½œåœ¨ä¸ç¡®å®šçŠ¶æ€ä¸‹ã€‚æ­£å› ä¸º suspend()ã€resume()å’Œ stop()æ–¹æ³•å¸¦æ¥çš„å‰¯ä½œç”¨ï¼Œè¿™äº›æ–¹æ³•æ‰è¢«æ ‡æ³¨ä¸ºä¸å»ºè®®ä½¿ç”¨çš„è¿‡æœŸæ–¹æ³•ã€‚&lt;/p>
&lt;h4 id="ä¸­æ–­">ä¸­æ–­&lt;/h4>
&lt;p>å®‰å…¨çš„ä¸­æ­¢åˆ™æ˜¯å…¶ä»–çº¿ç¨‹é€šè¿‡è°ƒç”¨æŸä¸ªçº¿ç¨‹A çš„&lt;code> interrupt()&lt;/code>æ–¹æ³•å¯¹å…¶è¿›è¡Œä¸­æ–­æ“ä½œï¼Œä¸­æ–­å¥½æ¯”å…¶ä»–çº¿ç¨‹å¯¹è¯¥çº¿ç¨‹æ‰“äº†ä¸ªæ‹›å‘¼ï¼Œâ€œAï¼Œä½ è¦ä¸­æ–­äº†â€ï¼Œä¸ä»£è¡¨çº¿ç¨‹ A ä¼šç«‹å³åœæ­¢è‡ªå·±çš„å·¥ä½œï¼ŒåŒæ ·çš„ A çº¿ç¨‹å®Œå…¨å¯ä»¥ä¸ç†ä¼šè¿™ç§ä¸­æ–­è¯·æ±‚ã€‚çº¿ç¨‹é€šè¿‡æ£€æŸ¥è‡ªèº«çš„ä¸­æ–­æ ‡å¿—ä½æ˜¯å¦è¢«ç½®ä¸º true æ¥è¿›è¡Œå“åº”ã€‚&lt;/p>
&lt;p>çº¿ç¨‹é€šè¿‡æ–¹æ³• &lt;code>isInterrupted()&lt;/code>æ¥è¿›è¡Œåˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨é™æ€æ–¹æ³•&lt;/p>
&lt;p>&lt;code>Thread.interrupted()&lt;/code>æ¥è¿›è¡Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ï¼Œä¸è¿‡&lt;code> Thread.interrupted()&lt;/code>ä¼šåŒæ—¶å°†ä¸­æ–­æ ‡è¯†ä½æ”¹å†™ä¸º falseã€‚&lt;/p>
&lt;p>å¦‚æœä¸€ä¸ªçº¿ç¨‹å¤„äºäº†é˜»å¡çŠ¶æ€ï¼ˆå¦‚çº¿ç¨‹è°ƒç”¨äº† thread.sleepã€thread.joinã€thread.wait ç­‰ï¼‰ï¼Œåˆ™åœ¨çº¿ç¨‹åœ¨æ£€æŸ¥ä¸­æ–­æ ‡ç¤ºæ—¶å¦‚æœå‘ç°ä¸­æ–­æ ‡ç¤ºä¸º trueï¼Œåˆ™ä¼šåœ¨è¿™äº›é˜»å¡æ–¹æ³•è°ƒç”¨å¤„æŠ›å‡º &lt;code>InterruptedException&lt;/code> å¼‚å¸¸ï¼Œå¹¶ä¸”åœ¨æŠ›å‡ºå¼‚å¸¸åä¼šç«‹å³å°†çº¿ç¨‹çš„ä¸­æ–­æ ‡ç¤ºä½æ¸…é™¤ï¼Œå³é‡æ–°è®¾ç½®ä¸º falseã€‚&lt;/p>
&lt;p>ä¸å»ºè®®è‡ªå®šä¹‰ä¸€ä¸ªå–æ¶ˆæ ‡å¿—ä½æ¥ä¸­æ­¢çº¿ç¨‹çš„è¿è¡Œã€‚å› ä¸º run æ–¹æ³•é‡Œæœ‰é˜»å¡è°ƒç”¨æ—¶ä¼šæ— æ³•å¾ˆå¿«æ£€æµ‹åˆ°å–æ¶ˆæ ‡å¿—ï¼Œçº¿ç¨‹å¿…é¡»ä»é˜»å¡è°ƒç”¨è¿”å›åï¼Œæ‰ä¼šæ£€æŸ¥è¿™ä¸ªå–æ¶ˆæ ‡å¿—ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨ä¸­æ–­ä¼šæ›´å¥½ï¼Œå› ä¸ºï¼š&lt;/p>
&lt;ol>
&lt;li>ä¸€èˆ¬çš„é˜»å¡æ–¹æ³•ï¼Œå¦‚ sleep ç­‰æœ¬èº«å°±æ”¯æŒä¸­æ–­çš„æ£€æŸ¥ã€‚&lt;/li>
&lt;li>æ£€æŸ¥ä¸­æ–­ä½çš„çŠ¶æ€å’Œæ£€æŸ¥å–æ¶ˆæ ‡å¿—ä½æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œç”¨ä¸­æ–­ä½çš„çŠ¶æ€è¿˜å¯ä»¥é¿å…å£°æ˜å–æ¶ˆæ ‡å¿—ä½ï¼Œå‡å°‘èµ„æºçš„æ¶ˆè€—ã€‚&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>æ³¨æ„ï¼šå¤„äºæ­»é”çŠ¶æ€çš„çº¿ç¨‹æ— æ³•è¢«ä¸­æ–­&lt;/strong>&lt;/p>
&lt;h3 id="å¯¹javaé‡Œçš„çº¿ç¨‹å†å¤šä¸€ç‚¹ç‚¹è®¤è¯†">å¯¹Javaé‡Œçš„çº¿ç¨‹å†å¤šä¸€ç‚¹ç‚¹è®¤è¯†&lt;/h3>
&lt;h4 id="æ·±å…¥ç†è§£runå’Œstart">æ·±å…¥ç†è§£run()å’Œstart()&lt;/h4>
&lt;p>Thread ç±»æ˜¯Java é‡Œå¯¹çº¿ç¨‹æ¦‚å¿µçš„æŠ½è±¡ï¼Œå¯ä»¥è¿™æ ·ç†è§£ï¼šæˆ‘ä»¬é€šè¿‡new Thread() å…¶å®åªæ˜¯ new å‡ºä¸€ä¸ª Thread çš„å®ä¾‹ï¼Œè¿˜æ²¡æœ‰æ“ä½œç³»ç»Ÿä¸­çœŸæ­£çš„çº¿ç¨‹æŒ‚èµ·é’©æ¥ã€‚åªæœ‰æ‰§è¡Œäº† start()æ–¹æ³•åï¼Œæ‰å®ç°äº†çœŸæ­£æ„ä¹‰ä¸Šçš„å¯åŠ¨çº¿ç¨‹ã€‚&lt;/p>
&lt;p>start()æ–¹æ³•è®©ä¸€ä¸ªçº¿ç¨‹è¿›å…¥å°±ç»ªé˜Ÿåˆ—ç­‰å¾…åˆ†é… cpuï¼Œåˆ†åˆ° cpu åæ‰è°ƒç”¨å®ç°çš„ run()æ–¹æ³•ï¼Œstart()æ–¹æ³•ä¸èƒ½é‡å¤è°ƒç”¨ï¼Œå¦‚æœé‡å¤è°ƒç”¨ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚è€Œ run æ–¹æ³•æ˜¯ä¸šåŠ¡é€»è¾‘å®ç°çš„åœ°æ–¹ï¼Œæœ¬è´¨ä¸Šå’Œä»»æ„ä¸€ä¸ªç±»çš„ä»»æ„ä¸€ä¸ªæˆå‘˜æ–¹æ³•å¹¶æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œå¯ä»¥é‡å¤æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥è¢«å•ç‹¬è°ƒç”¨ã€‚&lt;/p>
&lt;h4 id="å…¶ä»–çš„çº¿ç¨‹ç›¸å…³æ–¹æ³•">å…¶ä»–çš„çº¿ç¨‹ç›¸å…³æ–¹æ³•&lt;/h4>
&lt;p>&lt;code>yield()&lt;/code>æ–¹æ³•ï¼šä½¿å½“å‰çº¿ç¨‹è®©å‡º CPU å æœ‰æƒï¼Œä½†è®©å‡ºçš„æ—¶é—´æ˜¯ä¸å¯è®¾å®šçš„ã€‚ä¹Ÿä¸ä¼šé‡Šæ”¾é”èµ„æºã€‚&lt;/p>
&lt;p>æ³¨æ„ï¼šå¹¶ä¸æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½éœ€è¦è¿™ä¸ªé”çš„ï¼Œè€Œä¸”æ‰§è¡Œ &lt;code>yield( )&lt;/code>çš„çº¿ç¨‹ä¸ä¸€å®šå°±ä¼šæŒæœ‰é”ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨é‡Šæ”¾é”åå†è°ƒç”¨ yield æ–¹æ³•ã€‚æ‰€æœ‰æ‰§è¡Œ yield()çš„çº¿ç¨‹æœ‰å¯èƒ½åœ¨è¿›å…¥åˆ°å°±ç»ªçŠ¶æ€åä¼šè¢«æ“ä½œç³»ç»Ÿå†æ¬¡é€‰ä¸­é©¬ä¸Šåˆè¢«æ‰§è¡Œã€‚&lt;/p>
&lt;h4 id="joinæ–¹æ³•">joinæ–¹æ³•&lt;/h4>
&lt;p>æŠŠæŒ‡å®šçš„çº¿ç¨‹åŠ å…¥åˆ°å½“å‰çº¿ç¨‹ï¼Œå¯ä»¥å°†ä¸¤ä¸ªäº¤æ›¿æ‰§è¡Œçš„çº¿ç¨‹åˆå¹¶ä¸ºé¡ºåºæ‰§è¡Œã€‚æ¯”å¦‚åœ¨çº¿ç¨‹ B ä¸­è°ƒç”¨äº†çº¿ç¨‹ A çš„ Join()æ–¹æ³•ï¼Œç›´åˆ°çº¿ç¨‹ A æ‰§è¡Œå®Œæ¯•åï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œçº¿ç¨‹ Bã€‚&lt;/p>
&lt;h4 id="çº¿ç¨‹çš„ä¼˜å…ˆçº§">çº¿ç¨‹çš„ä¼˜å…ˆçº§&lt;/h4>
&lt;p>åœ¨ Java çº¿ç¨‹ä¸­ï¼Œé€šè¿‡ä¸€ä¸ªæ•´å‹æˆå‘˜å˜é‡&lt;code> priority&lt;/code> æ¥æ§åˆ¶ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§çš„èŒƒå›´ä» 1~10ï¼Œåœ¨çº¿ç¨‹æ„å»ºçš„æ—¶å€™å¯ä»¥é€šè¿‡ &lt;code>setPriority(int)&lt;/code>æ–¹æ³•æ¥ä¿®æ”¹ä¼˜å…ˆçº§ï¼Œé»˜è®¤ä¼˜å…ˆçº§æ˜¯ 5ï¼Œä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡çš„æ•°é‡è¦å¤šäºä¼˜å…ˆçº§ä½çš„çº¿ç¨‹ã€‚&lt;/p>
&lt;p>è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§æ—¶ï¼Œé’ˆå¯¹é¢‘ç¹é˜»å¡ï¼ˆä¼‘çœ æˆ–è€… I/O æ“ä½œï¼‰çš„çº¿ç¨‹éœ€è¦è®¾ç½®è¾ƒé«˜ä¼˜å…ˆçº§ï¼Œè€Œåé‡è®¡ç®—ï¼ˆéœ€è¦è¾ƒå¤š CPU æ—¶é—´æˆ–è€…åè¿ç®—ï¼‰çš„çº¿ç¨‹åˆ™è®¾ç½®è¾ƒä½çš„ä¼˜å…ˆçº§ï¼Œç¡®ä¿å¤„ç†å™¨ä¸ä¼šè¢«ç‹¬å ã€‚åœ¨ä¸åŒçš„ JVM ä»¥åŠæ“ä½œç³»ç»Ÿä¸Šï¼Œçº¿ç¨‹è§„åˆ’ä¼šå­˜åœ¨å·®å¼‚ï¼Œæœ‰äº›æ“ä½œç³»ç»Ÿç”šè‡³ä¼šå¿½ç•¥å¯¹çº¿ç¨‹ä¼˜å…ˆçº§çš„è®¾å®šã€‚&lt;/p>
&lt;h2 id="çº¿ç¨‹çš„è°ƒåº¦">çº¿ç¨‹çš„è°ƒåº¦&lt;/h2>
&lt;p>çº¿ç¨‹è°ƒåº¦æ˜¯æŒ‡ç³»ç»Ÿä¸ºçº¿ç¨‹åˆ†é… CPU ä½¿ç”¨æƒçš„è¿‡ç¨‹ï¼Œä¸»è¦è°ƒåº¦æ–¹å¼æœ‰ä¸¤ç§ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ååŒå¼çº¿ç¨‹è°ƒåº¦(Cooperative Threads-Scheduling)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æŠ¢å å¼çº¿ç¨‹è°ƒåº¦(Preemptive Threads-Scheduling)&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>ä½¿ç”¨ååŒå¼çº¿ç¨‹è°ƒåº¦çš„å¤šçº¿ç¨‹ç³»ç»Ÿï¼Œçº¿ç¨‹æ‰§è¡Œçš„æ—¶é—´ç”±çº¿ç¨‹æœ¬èº«æ¥æ§åˆ¶ï¼Œçº¿ç¨‹æŠŠè‡ªå·±çš„å·¥ä½œæ‰§è¡Œå®Œä¹‹åï¼Œè¦ä¸»åŠ¨é€šçŸ¥ç³»ç»Ÿåˆ‡æ¢åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¸Šã€‚ä½¿ç”¨ååŒå¼çº¿ç¨‹è°ƒåº¦çš„æœ€å¤§å¥½å¤„æ˜¯å®ç°ç®€å•ï¼Œç”±äºçº¿ç¨‹è¦æŠŠè‡ªå·±çš„äº‹æƒ…åšå®Œåæ‰ä¼šé€šçŸ¥ç³»ç»Ÿè¿›è¡Œçº¿ç¨‹åˆ‡æ¢ï¼Œæ‰€ä»¥æ²¡æœ‰çº¿ç¨‹åŒæ­¥çš„é—®é¢˜ï¼Œä½†æ˜¯åå¤„ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹å‡ºäº†é—®é¢˜ï¼Œåˆ™ç¨‹åºå°±ä¼šä¸€ç›´é˜»å¡ã€‚&lt;/p>
&lt;p>ä½¿ç”¨æŠ¢å å¼çº¿ç¨‹è°ƒåº¦çš„å¤šçº¿ç¨‹ç³»ç»Ÿï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œçš„æ—¶é—´ä»¥åŠæ˜¯å¦åˆ‡æ¢éƒ½ç”±ç³»ç»Ÿå†³å®šã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ä¸å¯æ§ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ã€Œä¸€ä¸ªçº¿ç¨‹å¯¼è‡´æ•´ä¸ªè¿›ç¨‹é˜»å¡ã€çš„é—®é¢˜å‡ºç°ã€‚&lt;/p>
&lt;p>åœ¨ Java ä¸­ï¼ŒThread.yield()å¯ä»¥è®©å‡º CPU æ‰§è¡Œæ—¶é—´ï¼Œä½†æ˜¯å¯¹äºè·å–ï¼Œçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰åŠæ³•çš„ã€‚å¯¹äºè·å– CPU æ‰§è¡Œæ—¶é—´ï¼Œçº¿ç¨‹å”¯ä¸€å¯ä»¥ä½¿ç”¨çš„æ‰‹æ®µæ˜¯è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§ï¼ŒJava è®¾ç½®äº† 10 ä¸ªçº§åˆ«çš„ç¨‹åºä¼˜å…ˆçº§ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¤„äº Ready çŠ¶æ€æ—¶ï¼Œä¼˜å…ˆçº§è¶Šé«˜çš„çº¿ç¨‹è¶Šå®¹æ˜“è¢«ç³»ç»Ÿé€‰æ‹©æ‰§è¡Œã€‚&lt;/p>
&lt;p>Java ä¸­çš„çº¿ç¨‹ä¼˜å…ˆçº§æ˜¯é€šè¿‡æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¸Šå®ç°çš„ï¼Œæ‰€ä»¥çº¿ç¨‹çš„è°ƒåº¦æœ€ç»ˆå–å†³äºæ“ä½œç³»ç»Ÿï¼Œæ“ä½œç³»ç»Ÿä¸­çº¿ç¨‹çš„ä¼˜å…ˆçº§æœ‰æ—¶å¹¶ä¸èƒ½å’Œ Java ä¸­çš„ä¸€ä¸€å¯¹åº”ï¼Œ&lt;u>&lt;strong>æ‰€ä»¥ Java ä¼˜å…ˆçº§å¹¶ä¸æ˜¯ç‰¹åˆ«é è°±&lt;/strong>&lt;/u>ã€‚&lt;/p>
&lt;p>æ‰€ä»¥åœ¨é¢è¯•ä¸­å¦‚æœé‡åˆ°ç›¸å…³çš„é—®é¢˜ï¼Œå¯ä»¥è¿™æ ·å›ç­”ï¼šJava ä¸­çš„çº¿ç¨‹æ˜¯é€šè¿‡æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¸Šå®ç°çš„ï¼Œæ‰€ä»¥çº¿ç¨‹çš„è°ƒåº¦æœ€ç»ˆå–å†³äºæ“ä½œç³»ç»Ÿï¼Œè€Œæ“ä½œç³»ç»Ÿçº§åˆ«ï¼ŒOS æ˜¯ä»¥æŠ¢å å¼è°ƒåº¦çº¿ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºçº¿ç¨‹æ˜¯æŠ¢å å¼çš„ã€‚Java è™šæ‹Ÿæœºé‡‡ç”¨æŠ¢å å¼è°ƒåº¦æ¨¡å‹ï¼Œæ˜¯æŒ‡ä¼˜å…ˆè®©å¯è¿è¡Œæ± ä¸­ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹å ç”¨ CPUï¼Œå¦‚æœå¯è¿è¡Œæ± ä¸­çš„çº¿ç¨‹ä¼˜å…ˆçº§ç›¸åŒï¼Œé‚£ä¹ˆå°±éšæœºé€‰æ‹©ä¸€ä¸ªçº¿ç¨‹ï¼Œä½¿å…¶å ç”¨ CPUã€‚å¤„äºè¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹ä¼šä¸€ç›´è¿è¡Œï¼Œç›´è‡³å®ƒä¸å¾—ä¸æ”¾å¼ƒ CPUã€‚è€Œä¸”æ“ä½œç³»ç»Ÿä¸­çº¿ç¨‹çš„ä¼˜å…ˆçº§æœ‰æ—¶å¹¶ä¸èƒ½å’Œ Java ä¸­çš„ä¸€ä¸€å¯¹åº”ï¼Œæ‰€ä»¥ Java ä¼˜å…ˆçº§å¹¶ä¸æ˜¯ç‰¹åˆ«é è°±ã€‚ä½†æ˜¯åœ¨ Java ä¸­ï¼Œå› ä¸º Java æ²¡æœ‰æä¾›å®‰å…¨çš„æŠ¢å å¼æ–¹æ³•æ¥åœæ­¢çº¿ç¨‹ï¼Œè¦å®‰å…¨çš„åœæ­¢çº¿ç¨‹åªèƒ½ä»¥åä½œå¼çš„æ–¹å¼ã€‚&lt;/p>
&lt;h2 id="å®ˆæŠ¤çº¿ç¨‹">å®ˆæŠ¤çº¿ç¨‹&lt;/h2>
&lt;p>Daemonï¼ˆå®ˆæŠ¤ï¼‰çº¿ç¨‹æ˜¯ä¸€ç§æ”¯æŒå‹çº¿ç¨‹ï¼Œå› ä¸ºå®ƒä¸»è¦è¢«ç”¨ä½œç¨‹åºä¸­åå°è°ƒåº¦ä»¥åŠæ”¯æŒæ€§å·¥ä½œã€‚è¿™æ„å‘³ç€ï¼Œå½“ä¸€ä¸ª Java è™šæ‹Ÿæœºä¸­ä¸å­˜åœ¨&lt;strong>é&lt;/strong> Daemon çº¿ç¨‹çš„æ—¶å€™ï¼ŒJava è™šæ‹Ÿæœºå°†ä¼šé€€å‡ºã€‚å¯ä»¥é€šè¿‡è°ƒç”¨ &lt;code>Thread.setDaemon(true)&lt;/code>å°†çº¿ç¨‹è®¾ç½®ä¸º Daemon çº¿ç¨‹ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä¸€èˆ¬ç”¨ä¸ä¸Šï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶çº¿ç¨‹å°±æ˜¯ Daemon çº¿ç¨‹ã€‚&lt;/p>
&lt;p>Daemon çº¿ç¨‹è¢«ç”¨ä½œå®Œæˆæ”¯æŒæ€§å·¥ä½œï¼Œä½†æ˜¯åœ¨ Java è™šæ‹Ÿæœºé€€å‡ºæ—¶ Daemon çº¿ç¨‹ä¸­çš„ finally å—å¹¶ä¸ä¸€å®šä¼šæ‰§è¡Œã€‚åœ¨æ„å»º Daemon çº¿ç¨‹æ—¶ï¼Œä¸èƒ½ä¾é  finally å—ä¸­çš„å†…å®¹æ¥ç¡®ä¿æ‰§è¡Œå…³é—­æˆ–æ¸…ç†èµ„æºçš„é€»è¾‘ã€‚&lt;/p>
&lt;h2 id="çº¿ç¨‹é—´çš„å…±äº«å’Œåä½œ">çº¿ç¨‹é—´çš„å…±äº«å’Œåä½œ&lt;/h2>
&lt;h3 id="çº¿ç¨‹é—´çš„å…±äº«">çº¿ç¨‹é—´çš„å…±äº«&lt;/h3>
&lt;h4 id="synchronizedå†…ç½®é”">synchronizedå†…ç½®é”&lt;/h4>
&lt;p>çº¿ç¨‹å¼€å§‹è¿è¡Œï¼Œæ‹¥æœ‰è‡ªå·±çš„æ ˆç©ºé—´ï¼Œå°±å¦‚åŒä¸€ä¸ªè„šæœ¬ä¸€æ ·ï¼ŒæŒ‰ç…§æ—¢å®šçš„ä»£ç ä¸€æ­¥ä¸€æ­¥åœ°æ‰§è¡Œï¼Œç›´åˆ°ç»ˆæ­¢ã€‚ä½†æ˜¯ï¼Œæ¯ä¸ªè¿è¡Œä¸­çš„çº¿ç¨‹ï¼Œå¦‚æœä»…ä»…æ˜¯å­¤ç«‹åœ°è¿è¡Œï¼Œ é‚£ä¹ˆæ²¡æœ‰ä¸€ç‚¹å„¿ä»·å€¼ï¼Œæˆ–è€…è¯´ä»·å€¼å¾ˆå°‘ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹èƒ½å¤Ÿç›¸äº’é…åˆå®Œæˆå·¥ä½œï¼Œ åŒ…æ‹¬æ•°æ®ä¹‹é—´çš„å…±äº«ï¼ŒååŒå¤„ç†äº‹æƒ…ã€‚è¿™å°†ä¼šå¸¦æ¥å·¨å¤§çš„ä»·å€¼ã€‚&lt;/p>
&lt;p>Java æ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€ä¸ªå¯¹è±¡æˆ–è€…å¯¹è±¡çš„æˆå‘˜å˜é‡ï¼Œå…³é”®å­—&lt;code>synchronized&lt;/code> å¯ä»¥ä¿®é¥°æ–¹æ³•æˆ–è€…ä»¥åŒæ­¥å—çš„å½¢å¼æ¥è¿›è¡Œä½¿ç”¨ï¼Œå®ƒä¸»è¦ç¡®ä¿å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¤„äºæ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­ï¼Œå®ƒä¿è¯äº†çº¿ç¨‹å¯¹å˜é‡è®¿é—®çš„å¯è§æ€§å’Œæ’ä»–æ€§ï¼Œåˆç§°ä¸ºå†…ç½®é”æœºåˆ¶ã€‚&lt;/p>
&lt;p>å¯¹è±¡é”å’Œç±»é”ï¼š&lt;/p>
&lt;p>å¯¹è±¡é”æ˜¯ç”¨äºå¯¹è±¡å®ä¾‹æ–¹æ³•ï¼Œæˆ–è€…ä¸€ä¸ªå¯¹è±¡å®ä¾‹ä¸Šçš„ï¼Œç±»é”æ˜¯ç”¨äºç±»çš„é™æ€æ–¹æ³•æˆ–è€…ä¸€ä¸ªç±»çš„ class å¯¹è±¡ä¸Šçš„ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç±»çš„å¯¹è±¡å®ä¾‹å¯ä»¥æœ‰å¾ˆå¤šä¸ªï¼Œä½†æ˜¯æ¯ä¸ªç±»åªæœ‰ä¸€ä¸ª class å¯¹è±¡ï¼Œæ‰€ä»¥ä¸åŒå¯¹è±¡å®ä¾‹çš„å¯¹è±¡é”æ˜¯äº’ä¸å¹²æ‰°çš„ï¼Œä½†æ˜¯æ¯ä¸ªç±»åªæœ‰ä¸€ä¸ªç±»é”ã€‚&lt;/p>
&lt;p>ä½†æ˜¯æœ‰ä¸€ç‚¹å¿…é¡»æ³¨æ„çš„æ˜¯ï¼Œå…¶å®ç±»é”åªæ˜¯ä¸€ä¸ªæ¦‚å¿µä¸Šçš„ä¸œè¥¿ï¼Œå¹¶ä¸æ˜¯çœŸå®å­˜åœ¨çš„ï¼Œç±»é”å…¶å®é”çš„æ˜¯æ¯ä¸ªç±»çš„å¯¹åº”çš„ class å¯¹è±¡ã€‚ç±»é”å’Œå¯¹è±¡é”ä¹‹é—´ä¹Ÿæ˜¯äº’ä¸å¹²æ‰°çš„ã€‚&lt;/p>
&lt;p>&lt;strong>é”™è¯¯çš„åŠ é”å’ŒåŸå› åˆ†æ&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Worker&lt;/span> &lt;span style="color:#66d9ef">implements&lt;/span> Runnable &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> Integer i&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">Worker&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Integer i&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">i&lt;/span> &lt;span style="color:#f92672">=&lt;/span> i&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">run&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">synchronized&lt;/span> &lt;span style="color:#f92672">(&lt;/span>i&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Thread thread &lt;span style="color:#f92672">=&lt;/span> Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">currentThread&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getName&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> i&lt;span style="color:#f92672">++;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sleep&lt;/span>&lt;span style="color:#f92672">(&lt;/span>3000&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>InterruptedException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> e&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">printStackTrace&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŸå› ï¼šè™½ç„¶æˆ‘ä»¬å¯¹ i è¿›è¡Œäº†åŠ é”ï¼Œä½†æ˜¯&lt;/p>
&lt;p>ä½†æ˜¯å½“æˆ‘ä»¬åç¼–è¯‘è¿™ä¸ªç±»çš„ class æ–‡ä»¶åï¼Œå¯ä»¥çœ‹åˆ° i++å®é™…æ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">i&lt;/span> &lt;span style="color:#f92672">=&lt;/span> Integer&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">valueOf&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">i&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">intValue&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">+&lt;/span> 1&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> Integer &lt;span style="color:#a6e22e">valueOf&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String s&lt;span style="color:#f92672">,&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span> radix&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#66d9ef">throws&lt;/span> NumberFormatException &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> Integer&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">valueOf&lt;/span>&lt;span style="color:#f92672">(&lt;/span>parseInt&lt;span style="color:#f92672">(&lt;/span>s&lt;span style="color:#f92672">,&lt;/span>radix&lt;span style="color:#f92672">));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ¬è´¨ä¸Šæ˜¯è¿”å›äº†ä¸€ä¸ªæ–°çš„ &lt;code>Integer&lt;/code> å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯æ¯ä¸ªçº¿ç¨‹å®é™…åŠ é”çš„æ˜¯ä¸åŒçš„ &lt;code>Integer&lt;/code> å¯¹è±¡ã€‚&lt;/p>
&lt;h4 id="volatileæœ€è½»é‡çš„åŒæ­¥æœºåˆ¶">volatileæœ€è½»é‡çš„åŒæ­¥æœºåˆ¶&lt;/h4>
&lt;p>&lt;code>volatile&lt;/code>ä¿è¯äº†ä¸åŒçº¿ç¨‹å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œæ“ä½œæ—¶çš„å¯è§æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå˜é‡çš„å€¼ï¼Œè¿™æ–°å€¼å¯¹å…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯ç«‹å³å¯è§çš„ã€‚å‚è§ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">VolatileCase&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">boolean&lt;/span> ready &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">true&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span> &lt;span style="color:#f92672">(&lt;/span>ready&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;å¾ªç¯ready:&amp;#34;&lt;/span> &lt;span style="color:#f92672">+&lt;/span> ready&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">sleep&lt;/span>&lt;span style="color:#f92672">(&lt;/span>1000&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>InterruptedException e&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">throw&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> RuntimeException&lt;span style="color:#f92672">(&lt;/span>e&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">new&lt;/span> Runnable&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">run&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ready &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">false&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}).&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸åŠ  volatile æ—¶ï¼Œå­çº¿ç¨‹æ— æ³•æ„ŸçŸ¥ä¸»çº¿ç¨‹ä¿®æ”¹äº† ready çš„å€¼ï¼Œä»è€Œä¸ä¼šé€€å‡ºå¾ªç¯ï¼Œ è€ŒåŠ äº† volatile åï¼Œå­çº¿ç¨‹å¯ä»¥æ„ŸçŸ¥ä¸»çº¿ç¨‹ä¿®æ”¹äº† ready çš„å€¼ï¼Œè¿…é€Ÿé€€å‡ºå¾ªç¯ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ volatile ä¸èƒ½ä¿è¯æ•°æ®åœ¨å¤šä¸ªçº¿ç¨‹ä¸‹åŒæ—¶å†™æ—¶çš„çº¿ç¨‹å®‰å…¨&lt;/p>
&lt;p>volatile æœ€é€‚ç”¨çš„åœºæ™¯ï¼šä¸€ä¸ªçº¿ç¨‹å†™ï¼Œå¤šä¸ªçº¿ç¨‹è¯»ã€‚&lt;/p>
&lt;h2 id="threadlocal">ThreadLocal&lt;/h2>
&lt;h3 id="ä¸synchonized-çš„æ¯”è¾ƒ">ä¸Synchonized çš„æ¯”è¾ƒ&lt;/h3>
&lt;p>ThreadLocal å’Œ Synchonized éƒ½ç”¨äºè§£å†³å¤šçº¿ç¨‹å¹¶å‘è®¿é—®ã€‚å¯æ˜¯ ThreadLocal ä¸ synchronized æœ‰æœ¬è´¨çš„å·®åˆ«ã€‚synchronized æ˜¯åˆ©ç”¨é”çš„æœºåˆ¶ï¼Œä½¿å˜é‡æˆ–ä»£ç å—åœ¨æŸä¸€æ—¶è¯¥ä»…ä»…èƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®ã€‚è€Œ ThreadLocal ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æä¾›äº†å˜é‡çš„å‰¯æœ¬ï¼Œä½¿å¾—æ¯ä¸ªçº¿ç¨‹åœ¨æŸä¸€æ—¶é—´è®¿é—®åˆ°çš„å¹¶éåŒä¸€ä¸ªå¯¹è±¡ï¼Œè¿™æ ·å°±éš”ç¦»äº†å¤šä¸ªçº¿ç¨‹å¯¹æ•°æ®çš„æ•°æ®å…±äº«ã€‚&lt;/p>
&lt;p>Spring çš„äº‹åŠ¡å°±å€ŸåŠ©äº† ThreadLocal ç±»ã€‚Spring ä¼šä»æ•°æ®åº“è¿æ¥æ± ä¸­è·å¾—ä¸€ä¸ªconnectionï¼Œç„¶ä¼šæŠŠ connection æ”¾è¿› ThreadLocal ä¸­ï¼Œä¹Ÿå°±å’Œçº¿ç¨‹ç»‘å®šäº†ï¼Œäº‹åŠ¡éœ€è¦æäº¤æˆ–è€…å›æ»šï¼Œåªè¦ä» ThreadLocal ä¸­æ‹¿åˆ° connection è¿›è¡Œæ“ä½œã€‚ä¸ºä½• Spring çš„äº‹åŠ¡è¦å€ŸåŠ© ThreadLocal ç±»ï¼Ÿ&lt;/p>
&lt;p>ä»¥ JDBC ä¸ºä¾‹ï¼Œæ­£å¸¸çš„äº‹åŠ¡ä»£ç å¯èƒ½å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>dbc &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> DataBaseConnection&lt;span style="color:#f92672">();&lt;/span>&lt;span style="color:#75715e">//ç¬¬ 1 è¡Œ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>Connection con &lt;span style="color:#f92672">=&lt;/span> dbc&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getConnection&lt;/span>&lt;span style="color:#f92672">();&lt;/span>&lt;span style="color:#75715e">//ç¬¬ 2 è¡Œ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>con&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setAutoCommit&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">false&lt;/span>&lt;span style="color:#f92672">);&lt;/span>&lt;span style="color:#75715e">//ç¬¬ 3 è¡Œ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>con&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">executeUpdate&lt;/span>&lt;span style="color:#f92672">(...);&lt;/span>&lt;span style="color:#75715e">//ç¬¬ 4 è¡Œ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>con&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">executeUpdate&lt;/span>&lt;span style="color:#f92672">(...);&lt;/span>&lt;span style="color:#75715e">//ç¬¬ 5 è¡Œ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>con&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">executeUpdate&lt;/span>&lt;span style="color:#f92672">(...);&lt;/span>&lt;span style="color:#75715e">//ç¬¬ 6 è¡Œ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>con&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">commit&lt;/span>&lt;span style="color:#f92672">();&lt;/span>&lt;span style="color:#75715e">////ç¬¬ 7 è¡Œ
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šè¿°ä»£ç ï¼Œå¯ä»¥åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†:&lt;/p>
&lt;p>äº‹åŠ¡å‡†å¤‡é˜¶æ®µï¼šç¬¬ 1ï½3 è¡Œä¸šåŠ¡å¤„ç†é˜¶æ®µï¼šç¬¬ 4ï½6 è¡Œäº‹åŠ¡æäº¤é˜¶æ®µï¼šç¬¬ 7 è¡Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ï¼Œä¸ç®¡æˆ‘ä»¬å¼€å¯äº‹åŠ¡è¿˜æ˜¯æ‰§è¡Œå…·ä½“çš„ sql éƒ½éœ€è¦ä¸€ä¸ªå…·ä½“çš„æ•°æ®åº“è¿æ¥ã€‚&lt;/p>
&lt;p>ç°åœ¨æˆ‘ä»¬å¼€å‘åº”ç”¨ä¸€èˆ¬éƒ½é‡‡ç”¨ä¸‰å±‚ç»“æ„ï¼Œå¦‚æœæˆ‘ä»¬æ§åˆ¶äº‹åŠ¡çš„ä»£ç éƒ½æ”¾åœ¨DAO(DataAccessObject)å¯¹è±¡ä¸­ï¼Œåœ¨ DAO å¯¹è±¡çš„æ¯ä¸ªæ–¹æ³•å½“ä¸­å»æ‰“å¼€äº‹åŠ¡å’Œå…³é—­äº‹åŠ¡ï¼Œå½“ Service å¯¹è±¡åœ¨è°ƒç”¨ DAO æ—¶ï¼Œå¦‚æœåªè°ƒç”¨ä¸€ä¸ª DAOï¼Œé‚£æˆ‘ä»¬è¿™æ ·å®ç°åˆ™æ•ˆæœä¸é”™ï¼Œä½†å¾€å¾€æˆ‘ä»¬çš„ Service ä¼šè°ƒç”¨ä¸€ç³»åˆ—çš„ DAO å¯¹æ•°æ®åº“è¿›è¡Œå¤šæ¬¡æ“ä½œï¼Œ é‚£ä¹ˆï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±æ— æ³•æ§åˆ¶äº‹åŠ¡çš„è¾¹ç•Œäº†ï¼Œå› ä¸ºå®é™…åº”ç”¨å½“ä¸­ï¼Œæˆ‘ä»¬çš„ Service è°ƒç”¨çš„ DAO çš„ä¸ªæ•°æ˜¯ä¸ç¡®å®šçš„ï¼Œå¯æ ¹æ®éœ€æ±‚è€Œå˜åŒ–ï¼Œè€Œä¸”è¿˜å¯èƒ½å‡ºç° Service è°ƒç”¨ Service çš„æƒ…å†µã€‚&lt;/p>
&lt;p>å¦‚æœä¸ä½¿ç”¨ ThreadLocalï¼Œä»£ç å¤§æ¦‚å°±ä¼šæ˜¯è¿™ä¸ªæ ·å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">serviceMethod&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Connection connection &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> connection&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getConnection&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> connection&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">setAutoCommit&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">false&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Dao1 dao1 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Dao1&lt;span style="color:#f92672">(&lt;/span>connection&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dao1&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">doSomething&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Dao2 dao2 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Dao2&lt;span style="color:#f92672">(&lt;/span>connection&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dao2&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">doSomething&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Dao3 dao3 &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Dao3&lt;span style="color:#f92672">(&lt;/span>connection&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dao3&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">doSomething&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> connection&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">commit&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>&lt;span style="color:#66d9ef">catch&lt;/span> &lt;span style="color:#f92672">(&lt;/span>Exception e&lt;span style="color:#f92672">){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> e&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">printStackTrace&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Class Dao1&lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> Connection connection &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#a6e22e">Dao1&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Connection connection&lt;span style="color:#f92672">){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">connection&lt;/span> &lt;span style="color:#f92672">=&lt;/span> connection&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">doSomething&lt;/span>&lt;span style="color:#f92672">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯éœ€è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•è®©ä¸‰ä¸ª DAO ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®æºè¿æ¥å‘¢ï¼Ÿæˆ‘ä»¬å°±å¿…é¡»ä¸ºæ¯ä¸ª DAO ä¼ é€’åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œè¦ä¹ˆå°±æ˜¯åœ¨ DAO å®ä¾‹åŒ–çš„æ—¶å€™ä½œä¸ºæ„é€ æ–¹æ³•çš„å‚æ•°ä¼ é€’ï¼Œè¦ä¹ˆåœ¨æ¯ä¸ª DAO çš„å®ä¾‹æ–¹æ³•ä¸­ä½œä¸ºæ–¹æ³•çš„å‚æ•°ä¼ é€’ã€‚è¿™ä¸¤ç§æ–¹å¼æ— ç–‘å¯¹æˆ‘ä»¬çš„ Spring æ¡†æ¶æˆ–è€…å¼€å‘äººå‘˜æ¥è¯´éƒ½ä¸åˆé€‚ã€‚ä¸ºäº†è®©è¿™ä¸ªæ•°æ®åº“è¿æ¥å¯ä»¥è·¨é˜¶æ®µä¼ é€’ï¼Œåˆä¸æ˜¾ç¤ºçš„è¿›è¡Œå‚æ•°ä¼ é€’ï¼Œå°±å¿…é¡»ä½¿ç”¨åˆ«çš„åŠæ³•ã€‚&lt;/p>
&lt;p>Web å®¹å™¨ä¸­ï¼Œæ¯ä¸ªå®Œæ•´çš„è¯·æ±‚å‘¨æœŸä¼šç”±ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å°†ä¸€äº›å‚æ•°ç»‘å®šåˆ°çº¿ç¨‹çš„è¯ï¼Œå°±å¯ä»¥å®ç°åœ¨è½¯ä»¶æ¶æ„ä¸­è·¨å±‚æ¬¡çš„å‚æ•°å…±äº«ï¼ˆæ˜¯éšå¼çš„å…±äº«ï¼‰ã€‚è€Œ Java ä¸­æ°å¥½æä¾›äº†ç»‘å®šçš„æ–¹æ³•ä½¿ç”¨ ThreadLocalã€‚&lt;/p>
&lt;p>ç»“åˆä½¿ç”¨ Spring é‡Œçš„ IOC å’Œ AOPï¼Œå°±å¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸€ç‚¹ã€‚&lt;/p>
&lt;p>åªè¦å°†ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ”¾å…¥ ThreadLocal ä¸­ï¼Œå½“å‰çº¿ç¨‹æ‰§è¡Œæ—¶åªè¦æœ‰ä½¿ç”¨æ•°æ®åº“è¿æ¥çš„åœ°æ–¹å°±ä» ThreadLocal è·å¾—å°±è¡Œäº†ã€‚&lt;/p>
&lt;h3 id="threadlocalçš„ä½¿ç”¨">ThreadLocalçš„ä½¿ç”¨&lt;/h3>
&lt;p>ThreadLocal ç±»æ¥å£å¾ˆç®€å•ï¼Œåªæœ‰ 4 ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">set&lt;/span>&lt;span style="color:#f92672">(&lt;/span>T value&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> set&lt;span style="color:#f92672">(&lt;/span>Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">currentThread&lt;/span>&lt;span style="color:#f92672">(),&lt;/span> value&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>TRACE_VTHREAD_LOCALS&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dumpStackIfVirtualThread&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è®¾ç½®å½“å‰çº¿ç¨‹çš„çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> T &lt;span style="color:#a6e22e">get&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> get&lt;span style="color:#f92672">(&lt;/span>Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">currentThread&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯¥æ–¹æ³•è¿”å›å½“å‰çº¿ç¨‹æ‰€å¯¹åº”çš„çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">remove&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> remove&lt;span style="color:#f92672">(&lt;/span>Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">currentThread&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°†å½“å‰çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼åˆ é™¤ï¼Œç›®çš„æ˜¯ä¸ºäº†å‡å°‘å†…å­˜çš„å ç”¨ï¼Œè¯¥æ–¹æ³•æ˜¯ jdkæ–°å¢çš„æ–¹æ³•ã€‚éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œå½“çº¿ç¨‹ç»“æŸåï¼Œå¯¹åº”è¯¥çº¿ç¨‹çš„å±€éƒ¨å˜é‡å°†è‡ªåŠ¨è¢«åƒåœ¾å›æ”¶ï¼Œæ‰€ä»¥æ˜¾å¼è°ƒç”¨è¯¥æ–¹æ³•æ¸…é™¤çº¿ç¨‹çš„å±€éƒ¨å˜é‡å¹¶ä¸æ˜¯å¿…é¡»çš„æ“ä½œï¼Œä½†å®ƒå¯ä»¥åŠ å¿«å†…å­˜å›æ”¶çš„é€Ÿåº¦ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">protected&lt;/span> T &lt;span style="color:#a6e22e">initialValue&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿”å›è¯¥çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼ï¼Œè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ª protected çš„æ–¹æ³•ï¼Œæ˜¾ç„¶æ˜¯ä¸ºäº†è®©å­ç±»è¦†ç›–è€Œè®¾è®¡çš„ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå»¶è¿Ÿè°ƒç”¨æ–¹æ³•ï¼Œåœ¨çº¿ç¨‹ç¬¬ 1 æ¬¡è°ƒç”¨ get() æˆ– set(Object)æ—¶æ‰æ‰§è¡Œï¼Œå¹¶ä¸”ä»…æ‰§è¡Œ 1 æ¬¡ã€‚ThreadLocal ä¸­çš„ç¼ºçœå®ç°ç›´æ¥è¿”å›ä¸€ä¸ª nullã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> ThreadLocal RESOURCE &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ThreadLocal&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>RESOURCE ä»£è¡¨ä¸€ä¸ªèƒ½å¤Ÿå­˜æ”¾String ç±»å‹çš„ThreadLocal å¯¹è±¡ã€‚æ­¤æ—¶ä¸è®ºä»€ä¹ˆä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿå¹¶å‘è®¿é—®è¿™ä¸ªå˜é‡ï¼Œå¯¹å®ƒè¿›è¡Œå†™å…¥ã€è¯»å–æ“ä½œï¼Œéƒ½æ˜¯ çº¿ç¨‹å®‰å…¨çš„ã€‚&lt;/p>
&lt;p>&lt;em>å®ç°è§£æ&lt;/em>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>ThreadLocalMap &lt;span style="color:#a6e22e">getMap&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Thread t&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> t&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">threadLocals&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> T &lt;span style="color:#a6e22e">get&lt;/span>&lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> get&lt;span style="color:#f92672">(&lt;/span>Thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">currentThread&lt;/span>&lt;span style="color:#f92672">());&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span> T &lt;span style="color:#a6e22e">get&lt;/span>&lt;span style="color:#f92672">(&lt;/span>Thread t&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ThreadLocalMap map &lt;span style="color:#f92672">=&lt;/span> getMap&lt;span style="color:#f92672">(&lt;/span>t&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>map &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ThreadLocalMap&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">Entry&lt;/span> e &lt;span style="color:#f92672">=&lt;/span> map&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">getEntry&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">this&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>e &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span>&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#a6e22e">@SuppressWarnings&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;unchecked&amp;#34;&lt;/span>&lt;span style="color:#f92672">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> T result &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">(&lt;/span>T&lt;span style="color:#f92672">)&lt;/span> e&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">value&lt;/span>&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> result&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> setInitialValue&lt;span style="color:#f92672">(&lt;/span>t&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://img.hinathan.online/2025/07/687474703a2f2f75706c6f61642d.jpg" alt="threadLocalå¼•ç”¨ç¤ºæ„å›¾">&lt;/p>
&lt;p>ä¸Šé¢å…ˆå–åˆ°å½“å‰çº¿ç¨‹ï¼Œç„¶åè°ƒç”¨ getMap æ–¹æ³•è·å–å¯¹åº”çš„ ThreadLocalMapï¼Œ&lt;/p>
&lt;p>ThreadLocalMap æ˜¯ ThreadLocal çš„é™æ€å†…éƒ¨ç±»ï¼Œç„¶å Thread ç±»ä¸­æœ‰ä¸€ä¸ªè¿™æ ·ç±»å‹æˆå‘˜ï¼Œæ‰€ä»¥ getMap æ˜¯ç›´æ¥è¿”å› Thread çš„æˆå‘˜ã€‚&lt;/p>
&lt;p>çœ‹ä¸‹ ThreadLocal çš„å†…éƒ¨ç±» ThreadLocalMap æºç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">ThreadLocalMap&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">Entry&lt;/span> &lt;span style="color:#66d9ef">extends&lt;/span> WeakReference&lt;span style="color:#f92672">&amp;lt;&lt;/span>ThreadLocal&lt;span style="color:#f92672">&amp;lt;?&amp;gt;&amp;gt;&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/** The value associated with this ThreadLocal. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Object value&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ç±»ä¼¼äºmapçš„keyã€valueç»“æ„ï¼Œkeyå°±æ˜¯ThreadLocalï¼Œvalueå°±æ˜¯éœ€è¦éš”ç¦»è®¿é—®çš„å˜é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> Entry&lt;span style="color:#f92672">(&lt;/span>ThreadLocal&lt;span style="color:#f92672">&amp;lt;?&amp;gt;&lt;/span> k&lt;span style="color:#f92672">,&lt;/span> Object v&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">super&lt;/span>&lt;span style="color:#f92672">(&lt;/span>k&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> value &lt;span style="color:#f92672">=&lt;/span> v&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ç”¨æ•°ç»„ä¿å­˜Entry å› ä¸ºå¯èƒ½æœ‰å¤šä¸ªå˜é‡éœ€è¦çº¿ç¨‹éš”ç¦»è®¿é—®
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">private&lt;/span> Entry&lt;span style="color:#f92672">[]&lt;/span> table&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°æœ‰ä¸ª Entry å†…éƒ¨é™æ€ç±»ï¼Œå®ƒç»§æ‰¿äº† WeakReferenceï¼Œæ€»ä¹‹å®ƒè®°å½•äº†ä¸¤ä¸ªä¿¡æ¯ï¼Œä¸€ä¸ªæ˜¯ ThreadLocalç±»å‹ï¼Œä¸€ä¸ªæ˜¯ Object ç±»å‹çš„å€¼ã€‚getEntry æ–¹æ³•åˆ™æ˜¯è·å–æŸä¸ª ThreadLocal å¯¹åº”çš„å€¼ï¼Œset æ–¹æ³•å°±æ˜¯æ›´æ–°æˆ–èµ‹å€¼ç›¸åº”çš„ ThreadLocalå¯¹åº”çš„å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span> Entry &lt;span style="color:#a6e22e">getEntry&lt;/span>&lt;span style="color:#f92672">(&lt;/span>ThreadLocal&lt;span style="color:#f92672">&amp;lt;?&amp;gt;&lt;/span> key&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> key&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">threadLocalHashCode&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#f92672">(&lt;/span>table&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">length&lt;/span> &lt;span style="color:#f92672">-&lt;/span> 1&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Entry e &lt;span style="color:#f92672">=&lt;/span> table&lt;span style="color:#f92672">[&lt;/span>i&lt;span style="color:#f92672">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">(&lt;/span>e &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#66d9ef">null&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> e&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">refersTo&lt;/span>&lt;span style="color:#f92672">(&lt;/span>key&lt;span style="color:#f92672">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> e&lt;span style="color:#f92672">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> getEntryAfterMiss&lt;span style="color:#f92672">(&lt;/span>key&lt;span style="color:#f92672">,&lt;/span> i&lt;span style="color:#f92672">,&lt;/span> e&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">set&lt;/span>&lt;span style="color:#f92672">(&lt;/span>ThreadLocal&lt;span style="color:#f92672">&amp;lt;?&amp;gt;&lt;/span> key&lt;span style="color:#f92672">,&lt;/span> Object value&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å›é¡¾æˆ‘ä»¬çš„ get æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯æ‹¿åˆ°&lt;strong>æ¯ä¸ªçº¿ç¨‹ç‹¬æœ‰çš„ ThreadLocalMap&lt;/strong>&lt;/p>
&lt;p>ç„¶åå†ç”¨ ThreadLocal çš„å½“å‰å®ä¾‹ï¼Œæ‹¿åˆ° Map ä¸­çš„ç›¸åº”çš„ Entryï¼Œç„¶åå°±å¯ä»¥æ‹¿åˆ°ç›¸åº”çš„å€¼è¿”å›å‡ºå»ã€‚å½“ç„¶ï¼Œå¦‚æœ Map ä¸ºç©ºï¼Œè¿˜ä¼šå…ˆè¿›è¡Œ map çš„åˆ›å»ºï¼Œåˆå§‹åŒ–ç­‰å·¥ä½œã€‚&lt;/p>
&lt;h3 id="å¼•å‘çš„å†…å­˜æ³„æ¼åˆ†æ">å¼•å‘çš„å†…å­˜æ³„æ¼åˆ†æ&lt;/h3>
&lt;h4 id="å¼•ç”¨">å¼•ç”¨&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>Object o &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Object&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ª oï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸ºå¯¹è±¡å¼•ç”¨ï¼Œè€Œ new Object()æˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸ºåœ¨å†…å­˜ä¸­äº§ç”Ÿäº†ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚&lt;/p>
&lt;p>å½“å†™ä¸‹ &lt;code>o=null&lt;/code> æ—¶ï¼Œåªæ˜¯è¡¨ç¤º o ä¸å†æŒ‡å‘å †ä¸­ object çš„å¯¹è±¡å®ä¾‹ï¼Œä¸ä»£è¡¨è¿™ä¸ªå¯¹è±¡å®ä¾‹ä¸å­˜åœ¨äº†ã€‚&lt;/p>
&lt;h4 id="å¼ºå¼•ç”¨">å¼ºå¼•ç”¨&lt;/h4>
&lt;p>&lt;strong>å¼ºå¼•ç”¨&lt;/strong>å°±æ˜¯æŒ‡åœ¨ç¨‹åºä»£ç ä¹‹ä¸­æ™®éå­˜åœ¨çš„ï¼Œç±»ä¼¼â€œObject obj=new Objectï¼ˆï¼‰â€è¿™ç±»çš„å¼•ç”¨ï¼Œåªè¦å¼ºå¼•ç”¨è¿˜å­˜åœ¨ï¼Œåƒåœ¾æ”¶é›†å™¨æ°¸è¿œä¸ä¼šå›æ”¶æ‰è¢«å¼•ç”¨çš„å¯¹è±¡å®ä¾‹ã€‚&lt;/p>
&lt;h4 id="è½¯å¼•ç”¨">è½¯å¼•ç”¨&lt;/h4>
&lt;p>&lt;strong>è½¯å¼•ç”¨&lt;/strong>æ˜¯ç”¨æ¥æè¿°ä¸€äº›è¿˜æœ‰ç”¨ä½†å¹¶éå¿…éœ€çš„å¯¹è±¡ã€‚å¯¹äºè½¯å¼•ç”¨å…³è”ç€çš„å¯¹è±¡ï¼Œ åœ¨ç³»ç»Ÿå°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ä¹‹å‰ï¼Œå°†ä¼šæŠŠè¿™äº›å¯¹è±¡å®ä¾‹åˆ—è¿›å›æ”¶èŒƒå›´ä¹‹ä¸­è¿›è¡Œ ç¬¬äºŒæ¬¡å›æ”¶ã€‚å¦‚æœè¿™æ¬¡å›æ”¶è¿˜æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚&lt;/p>
&lt;h4 id="å¼±å¼•ç”¨">å¼±å¼•ç”¨&lt;/h4>
&lt;p>&lt;strong>å¼±å¼•ç”¨&lt;/strong>ä¹Ÿæ˜¯ç”¨æ¥æè¿°éå¿…éœ€å¯¹è±¡çš„ï¼Œä½†æ˜¯å®ƒçš„å¼ºåº¦æ¯”è½¯å¼•ç”¨æ›´å¼±ä¸€äº›ï¼Œè¢«å¼± å¼•ç”¨å…³è”çš„å¯¹è±¡å®ä¾‹åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å‘ç”Ÿä¹‹å‰ã€‚å½“åƒåœ¾æ”¶é›†å™¨å·¥ä½œæ—¶ï¼Œ æ— è®ºå½“å‰å†…å­˜æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶æ‰åªè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡å®ä¾‹ã€‚&lt;/p>
&lt;h4 id="è™šå¼•ç”¨">è™šå¼•ç”¨&lt;/h4>
&lt;p>&lt;strong>è™šå¼•ç”¨&lt;/strong>&lt;code>PhantomReference&lt;/code>ä¹Ÿç§°ä¸ºå¹½çµå¼•ç”¨æˆ–è€…å¹»å½±å¼•ç”¨ï¼Œå®ƒæ˜¯æœ€å¼±çš„ä¸€ç§å¼•ç”¨å…³ç³»ã€‚ä¸€ä¸ªå¯¹è±¡å®ä¾‹æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´æ„æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥å–å¾—ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„å°±æ˜¯èƒ½åœ¨è¿™ä¸ªå¯¹è±¡å®ä¾‹è¢«æ”¶é›†å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚&lt;/p>
&lt;h2 id="threadlocalä½¿ç”¨ä¸å½“é€ æˆå†…å­˜æ³„éœ²">ThreadLocalä½¿ç”¨ä¸å½“é€ æˆå†…å­˜æ³„éœ²&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">ThreadLocalLeakDemo&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">final&lt;/span> ThreadLocal&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#66d9ef">byte&lt;/span>&lt;span style="color:#f92672">[]&amp;gt;&lt;/span> threadLocal &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> ThreadLocal&lt;span style="color:#f92672">&amp;lt;&amp;gt;();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">public&lt;/span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">void&lt;/span> &lt;span style="color:#a6e22e">main&lt;/span>&lt;span style="color:#f92672">(&lt;/span>String&lt;span style="color:#f92672">[]&lt;/span> args&lt;span style="color:#f92672">)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Runnable task &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æ¨¡æ‹Ÿå ç”¨å¤§é‡å†…å­˜çš„å¯¹è±¡
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">byte&lt;/span>&lt;span style="color:#f92672">[]&lt;/span> data &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#66d9ef">byte&lt;/span>&lt;span style="color:#f92672">[&lt;/span>10 &lt;span style="color:#f92672">*&lt;/span> 1024 &lt;span style="color:#f92672">*&lt;/span> 1024&lt;span style="color:#f92672">];&lt;/span> &lt;span style="color:#75715e">// 10MB
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> threadLocal&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">set&lt;/span>&lt;span style="color:#f92672">(&lt;/span>data&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¿˜è®° remove()ï¼ŒThreadLocal å¼•ç”¨è¿˜åœ¨
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Thread work done.&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> &lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span> i &lt;span style="color:#f92672">=&lt;/span> 0&lt;span style="color:#f92672">;&lt;/span> i &lt;span style="color:#f92672">&amp;lt;&lt;/span> 100&lt;span style="color:#f92672">;&lt;/span> i&lt;span style="color:#f92672">++)&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Thread thread &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> Thread&lt;span style="color:#f92672">(&lt;/span>task&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> thread&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">start&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="é—®é¢˜åˆ†æ">é—®é¢˜åˆ†æ&lt;/h3>
&lt;p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ª ThreadLocalMapï¼Œç”¨æ¥å­˜å‚¨ ThreadLocal çš„å€¼ã€‚&lt;/p>
&lt;p>ThreadLocalMap çš„ key æ˜¯ ThreadLocal çš„ å¼±å¼•ç”¨ï¼Œvalue æ˜¯å¼ºå¼•ç”¨çš„æ•°æ®ã€‚&lt;/p>
&lt;p>å¦‚æœ ThreadLocal è¢« GC å›æ”¶ï¼Œè€Œæ²¡æœ‰è°ƒç”¨ remove() æ–¹æ³•ï¼š&lt;/p>
&lt;p>key ä¼šå˜æˆ nullï¼Œä½† value ä»ç„¶å­˜åœ¨ï¼Œå¯¼è‡´æ— æ³•æ¸…ç†ã€‚&lt;/p>
&lt;p>åªè¦çº¿ç¨‹è¿˜æ´»ç€ï¼ˆå¦‚çº¿ç¨‹æ± ä¸­çº¿ç¨‹ï¼‰ï¼Œvalue å°±ä¸ä¼šè¢«å›æ”¶ âœ å†…å­˜æ³„æ¼ã€‚&lt;/p>
&lt;h3 id="å†…å­˜">å†…å­˜&lt;/h3>
&lt;pre tabindex="0">&lt;code>Thread-1:
ThreadLocalMap:
Entry[] table = [
[0] -&amp;gt; Entry(key=ThreadLocal@abc123, value=10MB byte[])
[1] -&amp;gt; Entry(key=null, value=10MB byte[]) &amp;lt;-- key è¢«å›æ”¶äº†ï¼Œvalue æ— æ³•è®¿é—®ï¼Œæ³„æ¼ï¼
...
]
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://img.hinathan.online/2025/07/WX20250330-104859.png" alt="threadLocalå¼•ç”¨ç¤ºæ„å›¾">&lt;/p>
&lt;h3 id="æ­£ç¡®ä½¿ç”¨æ–¹æ³•">æ­£ç¡®ä½¿ç”¨æ–¹æ³•&lt;/h3>
&lt;h4 id="æ–¹æ³•ä¸€æ‰‹åŠ¨-remove">æ–¹æ³•ä¸€ï¼šæ‰‹åŠ¨ remove()&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>Runnable task &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">()&lt;/span> &lt;span style="color:#f92672">-&amp;gt;&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">byte&lt;/span>&lt;span style="color:#f92672">[]&lt;/span> data &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#66d9ef">byte&lt;/span>&lt;span style="color:#f92672">[&lt;/span>10 &lt;span style="color:#f92672">*&lt;/span> 1024 &lt;span style="color:#f92672">*&lt;/span> 1024&lt;span style="color:#f92672">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> threadLocal&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">set&lt;/span>&lt;span style="color:#f92672">(&lt;/span>data&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> System&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">out&lt;/span>&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">println&lt;/span>&lt;span style="color:#f92672">(&lt;/span>&lt;span style="color:#e6db74">&amp;#34;Thread work done.&amp;#34;&lt;/span>&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">finally&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> threadLocal&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">remove&lt;/span>&lt;span style="color:#f92672">();&lt;/span> &lt;span style="color:#75715e">// æ˜¾å¼ç§»é™¤ï¼Œé¿å…å†…å­˜æ³„æ¼
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="æ–¹æ³•äºŒä½¿ç”¨çº¿ç¨‹æ± æ—¶æ›´éœ€æ³¨æ„">æ–¹æ³•äºŒï¼šä½¿ç”¨çº¿ç¨‹æ± æ—¶æ›´éœ€æ³¨æ„&lt;/h4>
&lt;p>çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¤ç”¨çš„ï¼Œå¦‚æœ ThreadLocal çš„å€¼æ²¡æœ‰åŠæ—¶æ¸…ç†ï¼Œä¼šé•¿æ—¶é—´å ç”¨å†…å­˜&lt;/p>
&lt;h4 id="ä½¿ç”¨-try-finally-æ¸…ç†">ä½¿ç”¨ try-finally æ¸…ç†&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">try&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> threadLocal&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">set&lt;/span>&lt;span style="color:#f92672">(&lt;/span>someLargeObject&lt;span style="color:#f92672">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æ‰§è¡Œä¸šåŠ¡é€»è¾‘
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#f92672">}&lt;/span> &lt;span style="color:#66d9ef">finally&lt;/span> &lt;span style="color:#f92672">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> threadLocal&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">remove&lt;/span>&lt;span style="color:#f92672">();&lt;/span> &lt;span style="color:#75715e">// æ˜¾å¼æ¸…é™¤ï¼Œé¿å…æ³„éœ²
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://img.hinathan.online/2025/07/687474703a2f2f75706c6f61642d.jpg" alt="threadLocalå¼•ç”¨ç¤ºæ„å›¾">&lt;/p>
&lt;p>å›¾ä¸­çš„è™šçº¿è¡¨ç¤ºå¼±å¼•ç”¨ã€‚&lt;/p>
&lt;p>è¿™æ ·ï¼Œå½“æŠŠ threadlocal å˜é‡ç½®ä¸º null ä»¥åï¼Œæ²¡æœ‰ä»»ä½•å¼ºå¼•ç”¨æŒ‡å‘ threadlocalå®ä¾‹ï¼Œæ‰€ä»¥ threadlocal å°†ä¼šè¢« gc å›æ”¶ã€‚è¿™æ ·ä¸€æ¥ï¼ŒThreadLocalMap ä¸­å°±ä¼šå‡ºç°&lt;/p>
&lt;p>key ä¸º null çš„ Entryï¼Œå°±æ²¡æœ‰åŠæ³•è®¿é—®è¿™äº› key ä¸º null çš„ Entry çš„ valueï¼Œå¦‚æœå½“å‰çº¿ç¨‹å†è¿Ÿè¿Ÿä¸ç»“æŸçš„è¯ï¼Œè¿™äº› key ä¸º null çš„ Entry çš„ value å°±ä¼šä¸€ç›´å­˜åœ¨ä¸€æ¡å¼ºå¼•ç”¨é“¾ï¼š&lt;code>Thread Ref&lt;/code> -&amp;gt; &lt;code>Thread&lt;/code> -&amp;gt; &lt;code>ThreaLocalMap&lt;/code> -&amp;gt; &lt;code>Entry&lt;/code> -&amp;gt; &lt;code>value&lt;/code>ï¼Œè€Œè¿™å— value æ°¸è¿œä¸ä¼šè¢«è®¿é—®åˆ°äº†ï¼Œæ‰€ä»¥å­˜åœ¨ç€å†…å­˜æ³„éœ²ã€‚&lt;/p>
&lt;p>åªæœ‰å½“å‰ thread ç»“æŸä»¥åï¼Œcurrent thread å°±ä¸ä¼šå­˜åœ¨æ ˆä¸­ï¼Œå¼ºå¼•ç”¨æ–­å¼€ï¼ŒCurrent Threadã€Map value å°†å…¨éƒ¨è¢« GC å›æ”¶ã€‚æœ€å¥½çš„åšæ³•æ˜¯ä¸åœ¨éœ€è¦ä½¿ç”¨ThreadLocal å˜é‡åï¼Œéƒ½è°ƒç”¨å®ƒçš„ remove()æ–¹æ³•ï¼Œæ¸…é™¤æ•°æ®ã€‚&lt;/p>
&lt;p>å…¶å®è€ƒå¯Ÿ ThreadLocal çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹è§ï¼Œæ— è®ºæ˜¯ get()ã€set()åœ¨æŸäº›æ—¶å€™ï¼Œè°ƒç”¨äº† expungeStaleEntry æ–¹æ³•ç”¨æ¥æ¸…é™¤ Entry ä¸­ Key ä¸º null çš„ Valueï¼Œä½†æ˜¯è¿™æ˜¯ä¸åŠæ—¶çš„ï¼Œä¹Ÿä¸æ˜¯æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œçš„ï¼Œæ‰€ä»¥ä¸€äº›æƒ…å†µä¸‹è¿˜æ˜¯ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²ã€‚åªæœ‰ remove()æ–¹æ³•ä¸­æ˜¾å¼è°ƒç”¨äº† expungeStaleEntry æ–¹æ³•ã€‚&lt;/p>
&lt;p>ä»è¡¨é¢ä¸Šçœ‹å†…å­˜æ³„æ¼çš„æ ¹æºåœ¨äºä½¿ç”¨äº†å¼±å¼•ç”¨ï¼Œä½†æ˜¯å¦ä¸€ä¸ªé—®é¢˜ä¹ŸåŒæ ·å€¼å¾—æ€è€ƒï¼šä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨è€Œä¸æ˜¯å¼ºå¼•ç”¨ï¼Ÿ&lt;/p>
&lt;p>ä¸‹é¢æˆ‘ä»¬åˆ†ä¸¤ç§æƒ…å†µè®¨è®ºï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>key ä½¿ç”¨å¼ºå¼•ç”¨ï¼šå¯¹ ThreadLocal å¯¹è±¡å®ä¾‹çš„å¼•ç”¨è¢«ç½®ä¸º null äº†ï¼Œä½†æ˜¯ThreadLocalMap è¿˜æŒæœ‰è¿™ä¸ª ThreadLocal å¯¹è±¡å®ä¾‹çš„å¼ºå¼•ç”¨ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤ï¼ŒThreadLocal çš„å¯¹è±¡å®ä¾‹ä¸ä¼šè¢«å›æ”¶ï¼Œå¯¼è‡´ Entry å†…å­˜æ³„æ¼ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>key ä½¿ç”¨å¼±å¼•ç”¨ï¼šå¯¹ ThreadLocal å¯¹è±¡å®ä¾‹çš„å¼•ç”¨è¢«è¢«ç½®ä¸º null äº†ï¼Œç”±äºThreadLocalMap æŒæœ‰ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œå³ä½¿æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤ï¼ŒThreadLocal çš„å¯¹è±¡å®ä¾‹ä¹Ÿä¼šè¢«å›æ”¶ã€‚value åœ¨ä¸‹ä¸€æ¬¡ ThreadLocalMap è°ƒç”¨ setï¼Œgetï¼Œremove éƒ½æœ‰æœºä¼šè¢«å›æ”¶ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>æ¯”è¾ƒä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼šç”±äº ThreadLocalMap çš„ç”Ÿå‘½å‘¨æœŸè·Ÿ Thread ä¸€æ ·é•¿ï¼Œå¦‚æœéƒ½æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº” keyï¼Œéƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œä½†æ˜¯ä½¿ç”¨å¼±å¼•ç”¨å¯ä»¥å¤šä¸€å±‚ä¿éšœã€‚&lt;/p>
&lt;p>å› æ­¤ï¼ŒThreadLocal å†…å­˜æ³„æ¼çš„æ ¹æºæ˜¯ï¼šç”±äº ThreadLocalMap çš„ç”Ÿå‘½å‘¨æœŸè·ŸThread ä¸€æ ·é•¿ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº” key å°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œè€Œä¸æ˜¯å› ä¸ºå¼±å¼•ç”¨ã€‚&lt;/p>
&lt;h4 id="æ€»ç»“">æ€»ç»“&lt;/h4>
&lt;p>JVM åˆ©ç”¨è®¾ç½® ThreadLocalMap çš„ Key ä¸ºå¼±å¼•ç”¨ï¼Œæ¥é¿å…å†…å­˜æ³„éœ²ã€‚&lt;/p>
&lt;p>JVM åˆ©ç”¨è°ƒç”¨ removeã€getã€set æ–¹æ³•çš„æ—¶å€™ï¼Œå›æ”¶å¼±å¼•ç”¨ã€‚&lt;/p>
&lt;p>å½“ ThreadLocal å­˜å‚¨å¾ˆå¤š Key ä¸º null çš„ Entry çš„æ—¶å€™ï¼Œè€Œä¸å†å»è°ƒç”¨ removeã€getã€set æ–¹æ³•ï¼Œé‚£ä¹ˆå°†å¯¼è‡´å†…å­˜æ³„æ¼ã€‚&lt;/p>
&lt;p>ä½¿ç”¨&lt;u>çº¿ç¨‹æ± +ThreadLocal&lt;/u> æ—¶è¦å°å¿ƒï¼Œå› ä¸ºè¿™ç§æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ˜¯ä¸€ç›´åœ¨ä¸æ–­çš„é‡å¤è¿è¡Œçš„ï¼Œä»è€Œä¹Ÿå°±é€ æˆäº† value å¯èƒ½é€ æˆç´¯ç§¯çš„æƒ…å†µã€‚&lt;/p>
&lt;p>é”™è¯¯ä½¿ç”¨ThreadLocal å¯¼è‡´çº¿ç¨‹ä¸å®‰å…¨ã€‚&lt;/p>
&lt;h2 id="çº¿ç¨‹é—´çš„åä½œ">çº¿ç¨‹é—´çš„åä½œ&lt;/h2>
&lt;p>çº¿ç¨‹ä¹‹é—´ç›¸äº’é…åˆï¼Œå®ŒæˆæŸé¡¹å·¥ä½œï¼Œæ¯”å¦‚ï¼šä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†ä¸€ä¸ªå¯¹è±¡çš„å€¼ï¼Œ è€Œå¦ä¸€ä¸ªçº¿ç¨‹æ„ŸçŸ¥åˆ°äº†å˜åŒ–ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„æ“ä½œï¼Œæ•´ä¸ªè¿‡ç¨‹å¼€å§‹äºä¸€ä¸ªçº¿ç¨‹ï¼Œ è€Œæœ€ç»ˆæ‰§è¡Œåˆæ˜¯å¦ä¸€ä¸ªçº¿ç¨‹ã€‚å‰è€…æ˜¯ç”Ÿäº§è€…ï¼Œåè€…å°±æ˜¯æ¶ˆè´¹è€…ï¼Œè¿™ç§æ¨¡å¼éš”ç¦»äº†â€œåšä»€ä¹ˆâ€ï¼ˆwhatï¼‰å’Œâ€œæ€ä¹ˆåšâ€ï¼ˆHowï¼‰ï¼Œç®€å•çš„åŠæ³•æ˜¯è®©æ¶ˆè´¹è€…çº¿ç¨‹ä¸æ–­åœ°å¾ªç¯æ£€æŸ¥å˜é‡æ˜¯å¦ç¬¦åˆé¢„æœŸåœ¨ while å¾ªç¯ä¸­è®¾ç½®ä¸æ»¡è¶³çš„æ¡ä»¶ï¼Œå¦‚æœæ¡ä»¶æ»¡è¶³åˆ™é€€å‡º while å¾ªç¯ï¼Œä»è€Œå®Œæˆæ¶ˆè´¹è€…çš„å·¥ä½œã€‚å´å­˜åœ¨å¦‚ä¸‹é—®é¢˜ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>éš¾ä»¥ç¡®ä¿åŠæ—¶æ€§ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>éš¾ä»¥é™ä½å¼€é”€ã€‚å¦‚æœé™ä½ç¡çœ çš„æ—¶é—´ï¼Œæ¯”å¦‚ä¼‘çœ  1 æ¯«ç§’ï¼Œè¿™æ ·æ¶ˆè´¹è€…èƒ½æ›´åŠ è¿…é€Ÿåœ°å‘ç°æ¡ä»¶å˜åŒ–ï¼Œä½†æ˜¯å´å¯èƒ½æ¶ˆè€—æ›´å¤šçš„å¤„ç†å™¨èµ„æºï¼Œé€ æˆäº†æ— ç«¯çš„æµªè´¹ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="ç­‰å¾…é€šçŸ¥æœºåˆ¶">ç­‰å¾…é€šçŸ¥æœºåˆ¶&lt;/h3>
&lt;p>æ˜¯æŒ‡ä¸€ä¸ªçº¿ç¨‹ A è°ƒç”¨äº†å¯¹è±¡ O çš„ wait()æ–¹æ³•è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹ B è°ƒç”¨äº†å¯¹è±¡O çš„notify()æˆ–è€…notifyAll()æ–¹æ³•ï¼Œçº¿ç¨‹ A æ”¶åˆ°é€šçŸ¥åä»å¯¹è±¡O çš„wait() æ–¹æ³•è¿”å›ï¼Œè¿›è€Œæ‰§è¡Œåç»­æ“ä½œã€‚ä¸Šè¿°ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡å¯¹è±¡ O æ¥å®Œæˆäº¤äº’ï¼Œè€Œå¯¹è±¡ä¸Šçš„ wait()å’Œ notify/notifyAll()çš„å…³ç³»å°±å¦‚åŒå¼€å…³ä¿¡å·ä¸€æ ·ï¼Œç”¨æ¥å®Œæˆç­‰å¾…æ–¹å’Œé€šçŸ¥æ–¹ä¹‹é—´çš„äº¤äº’å·¥ä½œã€‚&lt;/p>
&lt;p>&lt;code>notify()&lt;/code>é€šçŸ¥ä¸€ä¸ªåœ¨å¯¹è±¡ä¸Šç­‰å¾…çš„çº¿ç¨‹ï¼Œä½¿å…¶ä»wait æ–¹æ³•è¿”å›,è€Œè¿”å›çš„å‰ææ˜¯è¯¥çº¿ç¨‹è·å–åˆ°äº†å¯¹è±¡çš„é”ï¼Œæ²¡æœ‰è·å¾—é”çš„çº¿ç¨‹é‡æ–°è¿›å…¥ WAITING çŠ¶æ€ã€‚&lt;/p>
&lt;p>&lt;code>notifyAll()&lt;/code>é€šçŸ¥æ‰€æœ‰ç­‰å¾…åœ¨è¯¥å¯¹è±¡ä¸Šçš„çº¿ç¨‹ã€‚&lt;/p>
&lt;p>&lt;code>wait()&lt;/code>è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹è¿›å…¥ WAITING çŠ¶æ€,åªæœ‰ç­‰å¾…å¦å¤–çº¿ç¨‹çš„é€šçŸ¥æˆ–è¢«ä¸­æ–­æ‰ä¼šè¿”å›ã€‚éœ€è¦æ³¨æ„ï¼Œè°ƒç”¨ wait()æ–¹æ³•åï¼Œä¼šé‡Šæ”¾å¯¹è±¡çš„é”ã€‚&lt;/p>
&lt;p>&lt;code>wait(long)&lt;/code>è¶…æ—¶ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè¿™é‡Œçš„å‚æ•°æ—¶é—´æ˜¯æ¯«ç§’ï¼Œä¹Ÿå°±æ˜¯ç­‰å¾…é•¿è¾¾n æ¯«ç§’ï¼Œå¦‚æœæ²¡æœ‰é€šçŸ¥å°±è¶…æ—¶è¿”å›ã€‚&lt;/p>
&lt;p>&lt;code>wait (long,int)&lt;/code>å¯¹äºè¶…æ—¶æ—¶é—´æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œå¯ä»¥è¾¾åˆ°çº³ç§’ã€‚&lt;/p>
&lt;h3 id="ç­‰å¾…å’Œé€šçŸ¥çš„æ ‡å‡†èŒƒå¼">ç­‰å¾…å’Œé€šçŸ¥çš„æ ‡å‡†èŒƒå¼&lt;/h3>
&lt;h4 id="ç­‰å¾…æ–¹éµå¾ªå¦‚ä¸‹åŸåˆ™">ç­‰å¾…æ–¹éµå¾ªå¦‚ä¸‹åŸåˆ™&lt;/h4>
&lt;ol>
&lt;li>è·å–å¯¹è±¡çš„é”ã€‚&lt;/li>
&lt;li>å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆè°ƒç”¨å¯¹è±¡çš„ wait()æ–¹æ³•ï¼Œè¢«é€šçŸ¥åä»è¦æ£€æŸ¥æ¡ä»¶ã€‚&lt;/li>
&lt;li>æ¡ä»¶æ»¡è¶³åˆ™æ‰§è¡Œå¯¹åº”çš„é€»è¾‘ã€‚&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">synchronized&lt;/span>&lt;span style="color:#f92672">(&lt;/span>å¯¹è±¡&lt;span style="color:#f92672">){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">while&lt;/span>&lt;span style="color:#f92672">(&lt;/span>æ¡ä»¶ä¸æ»¡è¶³&lt;span style="color:#f92672">){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> å¯¹è±¡&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">wait&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> å¯¹åº”çš„å¤„ç†é€»è¾‘
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="é€šçŸ¥æ–¹éµå¾ªå¦‚ä¸‹åŸåˆ™">é€šçŸ¥æ–¹éµå¾ªå¦‚ä¸‹åŸåˆ™&lt;/h4>
&lt;ol>
&lt;li>è·å¾—å¯¹è±¡çš„é”ã€‚&lt;/li>
&lt;li>æ”¹å˜æ¡ä»¶ã€‚&lt;/li>
&lt;li>é€šçŸ¥æ‰€æœ‰ç­‰å¾…åœ¨å¯¹è±¡ä¸Šçš„çº¿ç¨‹ã€‚&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">synchronized&lt;/span>&lt;span style="color:#f92672">(&lt;/span>å¯¹è±¡&lt;span style="color:#f92672">){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> æ”¹å˜æ¡ä»¶
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> å¯¹è±¡&lt;span style="color:#f92672">.&lt;/span>&lt;span style="color:#a6e22e">notifyAll&lt;/span>&lt;span style="color:#f92672">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>åœ¨è°ƒç”¨&lt;/strong> waitï¼ˆï¼‰ã€notify()ç³»åˆ—æ–¹æ³•ä¹‹å‰ï¼Œ&lt;strong>çº¿ç¨‹å¿…é¡»è¦è·å¾—è¯¥å¯¹è±¡çš„å¯¹è±¡çº§åˆ«é”&lt;/strong>ï¼Œå³åªèƒ½åœ¨åŒæ­¥æ–¹æ³•æˆ–åŒæ­¥å—ä¸­è°ƒç”¨waitï¼ˆï¼‰æ–¹æ³•ã€notify()ç³»åˆ—æ–¹æ³•ï¼Œè¿›å…¥ waitï¼ˆï¼‰æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹é‡Šæ”¾é”ï¼Œåœ¨ä» waitï¼ˆï¼‰è¿”å›å‰ï¼Œçº¿ç¨‹ä¸å…¶ä»–çº¿ç¨‹ç«äº‰é‡æ–°è·å¾—é”ï¼Œæ‰§è¡Œnotify()ç³»åˆ—æ–¹æ³•çš„çº¿ç¨‹é€€å‡ºè°ƒç”¨äº†notifyAll çš„synchronized ä»£ç å—çš„æ—¶å€™åï¼Œä»–ä»¬å°±ä¼šå»ç«äº‰ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†è¯¥å¯¹è±¡é”ï¼Œå®ƒå°±ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œåœ¨å®ƒé€€å‡º synchronized ä»£ç å—ï¼Œé‡Šæ”¾é”åï¼Œå…¶ä»–çš„å·²ç»è¢«å”¤é†’çš„çº¿ç¨‹å°†ä¼šç»§ç»­ç«äº‰è·å–è¯¥é”ï¼Œä¸€ç›´è¿›è¡Œä¸‹å»ï¼Œç›´åˆ°æ‰€æœ‰è¢«å”¤é†’çš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•ã€‚&lt;/p>
&lt;h4 id="notify-å’Œ-notifyall-åº”è¯¥ç”¨è°">notify å’Œ notifyAll åº”è¯¥ç”¨è°&lt;/h4>
&lt;p>å°½å¯èƒ½ç”¨ notifyAll()ï¼Œè°¨æ…ä½¿ç”¨ notify()ï¼Œå› ä¸º notify()åªä¼šå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬æ— æ³•ç¡®ä¿è¢«å”¤é†’çš„è¿™ä¸ªçº¿ç¨‹ä¸€å®šå°±æ˜¯æˆ‘ä»¬éœ€è¦å”¤é†’çš„çº¿ç¨‹&lt;/p></description></item></channel></rss>